2022 Threat Detection ReportTABLE OF CONTENTSI NTRODUCTIO N3T HREAT SM ETHODOLOG Y4IntroductionTop ten threat highlights 42 44Cobalt StrikeImpacketSocGholishYellow CockatooGootkitBloodHoundT REND S8IntroductionRansomwareSupply chain compromiseVulnerabilitiesAffiliatesCrypters\-as\-a\-serviceCommon web shells9 11 17 212426User\-initiated initial access29Malicious macOS installers3114New activity clusters 60Rose FlamingoSilver SparrowRelevant threats of 2021 65BazarLatent threats4144475053565860636566Remote monitoring and
management abuse32T ECHNIQUE S71Linux coinminers33Abusing remote procedure calls36Defence validation and testing39Summary of most
prevalent techniques of 202172C ONCLUSIO N79A CKNOWLEDGEMENT SThanks to the 100\+ securityexperts, writers, editors, designers,developers, and project managers whoinvested countless hours to producethis report. And a huge thanks tothe MITRE ATT\&CK team, whoseframework has helped the communitytake a giant leap forward inunderstanding and tracking adversarybehaviors. Also a huge thanks to allthe Canariespast and presentwhoworked on the 2019, 2020, and 2021Threat Detection Reports. The ThreatDetection Report is iterative, and partsof the 2022 report are derived fromprevious years.This report wouldnt be
possible without all of you!2022 Threat Detection ReportI NTRODUCTIO NWelcome to the 2022 
Threat Detection ReportWelcome to Red Canarys 2022 Threat Detection Report. Based on in\-depthanalysis of over 30,000 confirmed threats detected across our customersenvironments, this research arms security leaders and their teams withactionable insight into the threats we observe, techniques adversaries mostcommonly leverage, and trends that help you understand what is changingand why. This is our most expansive report to date, but our intention remainsthe same: The Threat Detection Report exists to help you understand anddetect threats.How to use the report:Start perusing the most prevalent techniques, trends, and threats to seewhat weve observed in our customers environments.Explore how to detect, mitigate, and simulate specific threatsand techniques.Talk with your team about how the ideas, recommendations, and prioritiesmap to your security controls and your overall strategy.New trends sectionRed Canarys security operations team performs three primary activities:Our Intelligence team seeks to identify and understand distinct threats.Our Detection Enablement and Detection Engineering teams seek tounderstand these threats and engineer solutions that reliably detect themand enable timely investigation.Our Incident Handling team is charged with responding to threats beforethey harm customers.In each of these areas, weve identified trends that help us understand howthreats are evolving and how we as defenders must evolve in kind. From thecontinued scourge of ransomware to high\-impact vulnerabilities and supplychain attacks, this section synthesizes intelligence with insights from the frontlines of threat detection and response.3l Introduction2022 Threat Detection ReportMethodologySince 2013, Red Canary has delivered high\-quality threat detection toorganizations of all sizes. Our platform collects as much as a petabyte of securitytelemetry every day and leverages a library of roughly 3,000 detection analyticsto surface potential threats that are analyzed by our Cyber Incident ResponseTeam (CIRT). Confirmed threats are tied to corresponding MITRE ATT\&CKtechniques and specific threats to help our customers clearly understand whatis happening in their environments. A significant portion of this report is asummary of confirmed threats derived from this data.Creating metrics around techniques and threats is a challenge for anyorganization. To help you better understand the data behind this report andto guide you as you create your own metrics, we wanted to share some detailsabout our methodology.Behind the dataTo understand our data, you need to understand how we detect maliciousand suspicious behavior in the first place. We gather telemetry from ourcustomers environments and feed it through a constantly evolving library ofdetection analytics. Our detection analytics are mapped to one or more ATT\&CKtechniques and sub\-techniques, as appropriate. When telemetry matches thelogic in one of our detection analytics, an event is generated for review by ourdetection engineers.When a detection engineer determines that one or more events for a specificendpoint surpasses the threshold of suspicious or malicious behavior, they4l Methodology2022 Threat Detection Reportcreate a confirmed threat documenting the activity on that endpoint. Theseconfirmed threats inherit the ATT\&CK techniques that were mapped to theanalytics that first alerted us to the malicious or suspicious behaviors.Its important to understand that the techniques and sub\-techniques werecounting are based on our analyticsand not on the individual reviewperformed by our detection engineers, during which they add more context todetections. Weve chosen this approach to maximize efficiency and consistency.However, the limitation of this approach is that context gleaned during theinvestigation of a threat does not inform its technique mapping,and by extension, some small percentage of threats may be mapped incorrectlyor incompletely. That said, we continually review these confirmed threats,and we do not believe that there are a significant number of mapping errors inour dataset.How do you count?You may be wondering how we tally the scores for the Threat Detection Report.Our methodology for counting technique prevalence has largely remainedconsistent since our first Threat Detection Report in 2019\. For each maliciousor suspicious detection we published during the year, we incremented thecount for each technique reflected by a detection analytic that contributedto that detection (excluding data from detections of unwanted software). Ifthat detection was remediated and the host was reinfected at a later date, anew detection would be created, thus incrementing the counts again. Whilethis method of counting tends to overemphasize techniques that get reusedacross multiple hosts in a single environment (such as when a laterally movingadversary generates multiple detections within a single environment), thisgives appropriate weight to the techniques you are most likely to encounteras a defender.For the purposes of this report, we decided to set our rankings based ontechniques, even though the majority of our analysis and detection guidance willbe based on sub\-techniques. This seemed to be the most reasonable approach,considering the following:Sometimes we map to a technique that doesnt have sub\-techniquesSometimes we map to sub\-techniquesSometimes we map generally to a technique but not to its sub\-techniquesIn cases where a parent technique has no subs or subs that we dont map to, wewill analyze the parent technique on its own and provide appropriate detectionguidance. However, in cases where sub\-technique detections are rampant fora given parent technique, we will focus our analysis and detection guidance5l Methodology2022 Threat Detection Reportentirely on sub\-techniques that meet our requirements for minimum detectionvolume. To that point, we decided to analyze sub\-techniques that representedat least 20 percent of the total detection volume for a given technique. If nosub\-technique reached the 20 percent mark, then we analyzed the parent.What about threats?Our Intelligence team seeks to provide additional context about threats tohelp improve decision\-making. By understanding what threats are presentin a detection, customers can better understand how they should respond.Throughout 2021, the Intelligence team sought to improve how we identifiedand associated threats in detections. We chose to define threats broadly asmalware, tools, threat groups, or activity clusters. We took two main approachesto associating a detection to a threat: automatically associating them based onpatterns identified for each specific threat and manually associating them basedon analysts assessments conducted while reviewing each detection.In contrast to our technique methodology, we counted threats by the uniqueenvironments affected. Whereas for techniques we counted multiple detectionswithin the same customer environment as distinct tallies, for threats wedecided to only count by the number of customers who encountered that threatduring 2021\. This is due to the heavy skew introduced by incident responseengagements for laterally moving threats that affect nearly every endpoint in anenvironment (think ransomware).Had we counted threats by individual detections, ransomwareand thelaterally moving threats that lead up to it (e.g Cobalt Strike)would havebeen disproportionately represented in our data. We believe our approach tocounting gives an appropriate measure of how likely each threat is to affectany given organization, absent more specific threat modeling details for thatorganization. It also serves as a check against the acknowledged bias in the waywe count technique prevalence.LimitationsThere are a few limitations to our methodology for counting threats, as there arefor any approach. Due to the nature of our visibility (i.e that we predominantlyleverage endpoint detection and response data), our perspective tends toweigh more heavily on threats that made it through the external defensessuchas email and firewall gatewaysand were able to gain some level of executionon victim machines. As such, our results are likely different than what you maysee from other vendors focused more on network or email\-based detection.While the top threats are worth focusing on, they are not the only threatsto consider, since other impactful ones may be unidentified and therefore6l Methodology2022 Threat Detection Reportunderreported. The analysis and detection guidance in this report is reflectiveof the overall landscape, and, if implemented, offers a great deal of defense\-in\-depth against the threats that most organizations are likely to encounter.Knowing the limitations of any methodology is important as you determinewhat threats your team should focus on. While we hope our top 10 threats anddetection opportunities help you and your team prioritize, we recommendbuilding your own threat model by comparing the top threats we share inour report with what other teams publish and what you observe in yourown environment.7l Methodology82022 Threat Detection ReportTrendsRed Canary performed an analysis of emerging and significant trends that weve 
encountered in confirmed threats, intelligence reporting, and elsewhere over 
the past year. Weve compiled the most prominent trends of 2021 in this report 
to show major themes that may continue into 2022\.The technique and threat sections of this report are focused on detection data 
and identifying prevalent ATT\&CK techniques and threats in those detections. 
The trends section takes us one step beyond that data and allows us to narrate 
events that might not be prevalent but may be emergent or otherwise deserve 
your attention.How to use our analysisThe next page highlights the most prevalent threats occurring in our customer 
environments, so we can assume they are prevalent elsewhere. We include 
advice for responding to each threat and offer detection opportunities so you 
can better defend your organization. Some defenders may be able to take our 
detection guidance and apply it directly, while others may not. Regardless, 
defenders without a detection engineering function can still make use of the 
actionable analysis of each threat written by our Intelligence team experts.9l Trends2022 Threat Detection ReportRansomwareRansomware continued to 
dominate the 2021 threat 
landscape, and we observed 
operators take new 
 approaches.Supply chain
compromisesSupply chain compromises were 
a major theme, starting with 
SolarWinds, Kaseya and NPM 
package compromises mid\-year, 
and ending with Log4j.VulnerabilitiesAdversaries exploited 
vulnerabilities affecting 
popular enterprise platforms 
to drop web shells, spread 
ransomware, and more.AffiliatesCrypters\-as\-a\-serviceCommon web shellsThe threat landscape continued 
its trend toward a software\-
as\-a\-service (SaaS) economy, 
muddying the already murky 
waters of attribution.Crypters like HCrypt and Snip3 
joined the ranks of other as\-a\-
service threats.Adversaries exploited web 
applications with help from 
web shells such as China 
Chopper, Godzilla, and 
Behinder.User\-initiated
initial accessMalicious macOS
installersRemote monitoring and 
management abuseWe observed an uptick in 
threats that occurred after 
users sought out content 
which, often unbeknownst 
to them, was malicious.Malicious installers led to 
rotten Apples and adware, as 
macOS systems continued to 
be targeted.Adversaries continued to use 
and abuse legitimate remote 
monitoring and management 
(RMM) software to move data
and control infected hosts.Linux coinminersCoinminers once again 
dominated the Linux
threat landscape.Abusing remote
procedure callsDefense validation
and testingIntrusions leveraging remote 
procedure calls (RPC) made 
waves, particularly PetitPotam 
and PrintNightmare.Confirmed testing comprised 
almost one quarter of our 
detections in 2021, with many 
coming from open source tools.10l Trends2022 Threat Detection ReportT REN DRansomwareRansomware continued to dominate the 2021 threat landscape, with 
operators taking new approaches.Throughout 2021, ransomware remained one of the top threats to everyorganization. While some groups focused on traditional encryption, 2021 alsomarked the rise of additional tactics such as double extortion, which amplifiesan adversarys leverage and further compels victims to pay up. Ransomware hasbecome particularly challenging to track and prevent due to several trends weobserved in 2021, discussed below.The affiliate modelOne challenge in responding to ransomware intrusions is that differentadversaries are often involved at different phases of the intrusion. Ransomwaregroups usually rely on multiple affiliates to give them initial access to anenvironment before they encrypt files or take other actions. This makes trackingransomware groups even more difficult, as intrusions can be a mix and matchof different affiliates providing access to different ransomware groups.Red Canary carefully tracks affiliates of ransomware groups and the malwarethey use, since these adversaries are the ones who sometimes gain initial accessto an environment. These affiliates frequently use crimeware such as Bazarand Qbot to gain initial access to an environment, later passing off access toransomware groups. A few common combinations of malware and ransomwarewe observed in 2021 include:MALWARE FAMILY (PRECURSOR )RANSO MWA REGROU PQ botQ botQbotBazarIce d ID11 l RansomwareEgregorSodinokibiREvilContiContiConti2022 Threat Detection ReportSome things change, but some things
stay the sameChallenges in understanding the ransomware landscape are not limitedto tracking affiliates and payloads. Defenders must also contend with newgroups emerging and others seemingly disappearing (often to be reincarnatedin a different form as another group). Some of the ransomware families webid farewell to in 2021 were Egregor, SodinokibiREvil, BlackMatter, andDoppelpaymer. While some seemed to fade away due to law enforcementactions, others disappeared for reasons that researchers havent pinned down.Where one ransomware family disappeared, however, another was ready tostep into its place. 2021 saw the dawn of many new ransomware families,including BlackByte, Grief, Hive, Yanluowang, Vice Society, and CryptoLockerPhoenix Locker. Many new ransomware families displayed close similaritiesto old families that disappeared, leading analysts to assess that knownadversaries simply resurfaced using a new name. For example, Griefransomware displayed many similarities to Doppelpaymer, including itsdeployment following Dridex malware.Beyond encryptionA significant ransomware trend in 2021 was the increase in adversariesexpanding their threats beyond data encryption. Multiple ransomware groupspivoted to stealing and exfiltrating data before encrypting it, then demandingpayment to prevent the data from leaking publicly on a dark web site. While thispractice isnt new (it dates back to at least 2019\), what was significant in 2021was the number of groups who adopted this approachto the point where itbecame the standard.Adversaries realized they could demand payment for more than just thethreat of a data leak or encryption. An adversary known as Fancy Lazarus (noaffiliation with Fancy Bear or Lazarus Group) extorted victims by threatening toconduct a distributed denial of service (DDoS) intrusion if they didnt pay.12l Ransomware2022 Threat Detection ReportT AK EA CTIO NThere is no one simple way to prevent ransomware. The same security approachesyou take to prevent any malware also should help prevent ransomware. Its criticalto regularly update software, as we often see ransomware after operators exploit avulnerability in an internet\-facing application. Additionally, internet\-facing remotedesktop protocol (RDP) connections without multi\-factor authentication (MFA) area common ransomware vector, making MFA for any accounts that can log in via RDPa high priority.Ransomware also frequently gets into an environment as a follow\-on payloadfor malware delivered via phishing emails. Looking for these malware families,such as Qbot, Bazar, and IcedID, can be an effective way to identify a potentialransomware intrusion chain early and stop it in its tracks. Robust detection forother common post\-exploitation behaviors and tools like Cobalt Strike are alsoeffective in limiting the impact of ransomware, as adversaries conduct multiplephases before data exfiltration and encryption.Its also important to remember that backups are no longer sufficient ransomwareprotection. While creating offline backups is an excellent security practice and mayhelp restore an environment after a ransomware intrusion, organizations cannotrely on this entirely because adversaries regularly exfiltrate data before encryption,although this too offers potential opportunities for detection. Backups will allowan organization to get back up and running more easily, but will not protect youagainst leaked data.While this report focuses on what security teams can do, when it comes toransomware, its also important to remember that this problem is monumentaland extends beyond defenders. Policymakers are also taking a close look atransomware, and its necessary for the security community to help them betterunderstand what we do so they can make better decisions.13 l Ransomware2022 Threat Detection ReportT REN DSupply chain compromiseSupply chain compromises were a major theme in 2021, starting with 
SolarWinds, Kaseya and NPM package compromises mid\-year, and ending
with Log4j.Supply chain compromises were prevalent in 2021, and these incidents arentgoing away any time soon. Its important to understand the different typesof supply chain compromises. To state it simply, asupply chain compromiseoccurs when an adversary compromises a software developer, hardwaremanufacturer, or service provider and uses that access to target customers whouse the affected software, hardware, or service. For example, the SolarWindsand Kaseya incidents involved an adversary compromising update serversto target customers of the companies IT management software. Separately,NPM package and Log4j incidents involved adversaries exploiting open sourcelibraries in sweeping compromises that impacted products that use Log4j orNPM packages as a dependencyas well as anyone who uses those productsdirectly. Each of these incidents made headlines in mainstream media as well asinfosec publications.SolarWindsAdversaries compromised SolarWinds, accessed the update infrastructure for itsOrion IT management software, and sent backdoored updates to the companysthousands of customers in December 2020, affecting organizations well into2021\. The trojanized Orion platform updates included a legitimately signeddynamic link library (DLL) file, and some featured backdoor functionality that,after a dormancy period lasting as long as two weeks, initiated communicationwith command and control (C2\) servers. Adversaries identified targets ofinterest for further exploitation and conducted follow\-on activity such asinstalling additional malicious binaries. These malicious binaries were usedto install a backdoor where adversaries could access the victim organizationsaccounts. SolarWinds had a massive impact across many networks, and it tookmonths for enterprises to investigate and respond. This compromise initiatedimportant discussions about supply chain risks that remain relevant in 2022and beyond.KaseyaIn July 2021, adversaries exploited vulnerabilities in Kaseya VSA IT Managementsoftware in a campaign ultimately designed to deploy Sodinokibi ransomware,also known as REvil. VSA is popular among managed service providers (MSP)14l Supply chain compromise2022 Threat Detection Reportthat use it to remotely administer IT systems. The adversaries exploited zerodays to gain remote control over the MSPs VSA installations, which theyused to infect the MSPs customers endpoints with ransomware. Kaseyaestimated that about 50 direct customers who were running Kaseya VSAsystemsand between 800 and 1,500 other businesseswere impacted bythis breach. While the damage was not as bad as it could have been, thisincident further highlights the importance of tracking supply chain threats.It also resulted in significant attention from the U.S. government, which laterindicted the adversaries responsible for the intrusion. Read about how RedCanary responded to the compromises and protected several customers fromransomware infections.NPM package compromisesNode Package Manager (NPM) is a repository for publishing node.js projects,including libraries that developers download and incorporate into their softwareto perform specific mathematical functions, process data in specific ways,visualize data, and more. In October 2021, adversaries compromised an opensource JavaScript library with more than 7 million weekly downloads andused it to distribute password stealers and coinminers. At the time, the NPMregistry did not require author accounts to use multifactor authentication (MFA),which led to an unknown adversary hijacking the registry accounts of multiplepackage authors. After hijacking, the adversary published malicious versionsof the legitimate packages that contained malware. Victims included packageauthors and end users of applications relying on those packages. One package,ua\-parser\-js, was downloaded around 8 million times a week at the time and isused by Google, Amazon, Facebook, IBM, and Microsoft. The U.S. Cybersecurityand Infrastructure Agency (CISA) published a security alert about the incident,warning victims to update to a safe version.There were many other NPM compromises throughout the year, most notablyus\-parser\-js. Prior to this compromise, an adversary copied the legitimateua\-parser\-js library and combined it with malicious code to publish a maliciouslibrary. Following this compromise, an adversary took control of two NPMpackages, coa and rc. These incidents used a combination of XMRig coinmineron macOSand Danabot on Windows. Red Canary continues to trackthis activity.Log4jLog4j is a popular Java logging library underlying many third\-party applicationsthat was hit with a remote code execution vulnerability in December 2021\.The primary threats initially exploiting this vulnerability were coinminers andbotnets, though the community feared exploitation would expand becauseof Log4js massive intrusion surface. In some scenarios, the Log4j library wasaffected by a remote code execution vulnerability.15l Supply chain compromise2022 Threat Detection ReportOne reason the community didnt observe a large volume of exploitation in thefirst few days may be that these vulnerabilities are highly application\-specific,depending on how theyve implemented Log4j. This means an adversary couldnot have crafted a single exploit that would have had a broad impact on manytypes of applications at once. Though it took adversaries a few weeks to rampup targeting, in late December 2021 and early 2022, internet\-facing VMwareHorizon servers using vulnerable versions of Log4j became a target for multipleoperators. Adversaries were likely attracted to VMware Horizon because it iswidely used and often internet\-facing. We anticipate the continued targeting ofinternet\-facing applications using vulnerable versions of Log4j for monthsto come.TAK EA CTIO NOne of the best ways organizations can be prepared is by accurately inventoryingall of the hardware, software, and service providers they rely on and trust. This willassist in quick response when an inevitable supply chain concern arises.While itsounds commonplace, normal defense\-in\-depth strategies can also help preventsupply chain compromises from turning into impactful intrusions. Endpointdetection and response (EDR) tools coupled with network detection tools will helpyou detect malicious post\-exploitation activity in the event an adversary gainsaccess to your network through a trusted third party. While there may be nothingyou can do to prevent a dependency or a vendor from being compromised, thereis quite a lot you can do to detect and prevent follow\-on compromise, includingdetection opportunities weve shared throughout the rest of this report.16 l Supply chain compromiseT AK EA CTIO NWeve outlined several of 2021smajor vulnerabilities below,along with some detectionguidance. Detecting exploitationof a vulnerability from an endpointperspective can be difficult anddepends on how exploitation occursin practice. We have tried to supplydetection guidance as close to thepoint of exploitation as possible. Inother cases, we provide detectionopportunities that would most likelyappear as follow\-on behavior, suchas suspicious child processes orregistry modifications. The targetingof vulnerabilities in enterpriseapplications and platforms isunlikely to slow down in 2022, so itsimportant to detect the threats thatexploit them head\-on.2022 Threat Detection ReportT REN DVulnerabilitiesIn 2021, adversaries exploited vulnerabilities affecting popular enterprise 
platforms to drop web shells, spread ransomware, and more.Several high\-profile vulnerabilities made it into the collective consciousness ofthe security community in 2021\. ProxyLogon and ProxyShell targeted MicrosoftExchange servers and affected a massive number of systems, sometimes leadingto ransomware deployment. The exploitation of vulnerabilities in KaseyasVSA appliance software also led to ransomware deployment on some of thethousands of organizations that used Kaseya software for remote administrationof endpoints. In the latter half of the year, adversaries exploited multiplevulnerabilities in Zohos ManageEngine suite of products. PrintNightmare andan MSHTML vulnerability caused a ruckus among the security community andmedia; however, their actual impact appears to have been limited.An important nuance to call out is that vulnerabilities are just flaws in codeathreat must exploit that vulnerability. Given the frequency with whichvulnerabilities are disclosed and the ease with which adversaries can exploitnewly reported weaknesses, particularly in common applications, Red Canaryfocuses on identifying and detecting the behavior we observe surroundingexploitation of a vulnerability. We recommend other organizations do thesame. Understanding the threats and the ways in which adversaries operate incompromised networks allows defenders to protect against malicious activityregardless of the means by which their environment is accessed.ProxyLogon (CVE\-2021\-26855, CVE\-2021\-26857, 
CVE\-2021\-26858, CVE\-2021\-27065\)In March 2021, Microsoft released details of four Exchange Servervulnerabilities collectively known as ProxyLogon. If chained together, thevulnerabilities would allow an adversary remote code execution on a targetedExchange server. Multiple adversaries, including the suspected Chinese state\-sponsored group HAFNIUM, used the vulnerability chain to drop web shells andcollect data from thousands of Exchange servers. Other adversaries used theDearCry ransomware to target unpatched servers as well. Microsoft releasedpatches for these vulnerabilities at the time of initial reporting.17l Vulnerabilities2022 Threat Detection ReportMicrosoft Exchange Mailbox Replication service 
writing Active Server pagesAdversaries exploited ProxyLogon to drop web shells on vulnerable systems,which manifested through the msexchangemailboxreplication.exe servicewriting an ASPX file to disk. Malicious web shells will likely be placed on theweb server in a web\-accessible directory. The following analytic looks for theExchange mailbox replication service creating ASPX files.process \=\= msexchangemailboxreplication.exe\&\&filemod\_extension \=\= .aspxProxyShell (CVE\-2021\-31207, CVE\-2021\-34523, 
CVE\-2021\-34473\)Exchange servers remained a target throughout 2021\. In July, Microsoftreleased details of three new vulnerabilities in the Exchange server, whichwere dubbed ProxyShell. ProxyShell exploitation allows an adversary toremotely execute code without authentication. Following the exploitation,adversaries dropped web shells to conduct reconnaissance, move laterally,and in some instances, deploy ransomware. Where ProxyLogon seemedto have a high impact over a short period of time, ProxyShell seemed topersist throughout the year; we detected exploitation as late as December.DetectingProxyShell exploitation is similar to ProxyLogon mentioned above,specificallymsexchangemailboxreplication.exe writing an ASPX web shellto disk.PrintNightmare (CVE\-2021\-34527\)On July 1,security researchers and Microsoft released details of a newvulnerability dubbed PrintNightmare (CVE\-2021\-34527\). PrintNightmarepermits an unprivileged user to remotely obtain elevated privileges on anysystem running the print spooler service, which is enabled by default. It abusesa vulnerability in how the print spooler service fails to properly authenticateusers attempting to load a printer driver dynamic link library (DLL). This zero dayaffected all editions of Windows, allowing code execution with local SYSTEM\-level privileges.Though the vulnerability was concerning, there were not many reportedcampaigns exploiting it. That said, ransomware operators such as Vice Societyand Magniber have exploited the vulnerability to gain initial access,andtherefore its worth looking out for. We observed a single malicious instance ofPrintNightmare exploitation leading to precursor ransomware behaviors.18 l Vulnerabilities2022 Threat Detection ReportWindows print spooler service
spawning cmd.exePrintNightmare exploitation results in a shell being opened on the targetedsystem as a child process of the spooler service. This detection analyticidentifies the Windows print spooler service spawning a shell on the system.parent\_process \=\= spoolsv.exe\&\&process \=\=cmd.exeKaseya VSA (CVE\-2021\-30116\)On July 2, adversaries leveraged multiple vulnerabilities in Kaseya VirtualSystems Administrator (VSA) to distribute Sodinokibi ransomware, also knownas REvil. VSA allows IT administrators to remotely administer endpoints. Bycompromising this software, an adversary gains remote execution capabilityto a large subset of customer endpoints, especially if Kaseya is operated by amanaged service provider (MSP).Red Canary detected the initial behavioral activity using a preexistinganalytic for identifying certutil.exe decoding content, as detailed below. OurIntelligence team had tracked Sodinokibi prior to this, which helped us identifythe malicious registry modification of blacklivesmatter seen below andattribute it to Sodinokibi.Certificate utility tool (certutil.exe )
decoding contentThis detection analytic will detect certutil.exe running with the \-decode option.Adversaries frequently leverage certutil to decode Base 64\-encoded content.process \=\=certutil.exe\&\&command\_line\_includes (decode)19 l Vulnerabilities2022 Threat Detection ReportManageEngine products (CVE\-2021\-40539, CVE\-
2021\-44077, CVE\-2021\-44515\)In November and December, we observed likely exploitation of remote codeexecution vulnerabilities in two different Zoho ManageEngine products:ADSelfService Plus (CVE\-2021\-40539\) and ServiceDesk Plus (CVE\-2021\-44077\).In one case, an incident response partner determined that ADSelfServicePlus was used for initial access prior to deploying ransomware. The FBI notedthat advanced adversaries exploited a vulnerability in a third ManageEngineproduct, Desktop Central. ManageEngine products are widely used amongIT departments to manage various services across the enterprise. As such,this presents adversaries with a wide attack surface. Organizations usingManageEngine products in their environment should update accordingly.Patches for all the vulnerabilities listed here are available via ManageEngine.Keytool.exespawning system shell
or PowerShellFor the vulnerability in ADSelfService Plus (CVE\-2021\-40539\), weobserved adversaries use the Java utility Keytool to move a web shell fromthe initial directory it was dropped into. As such, keytool.exe spawning shellsshould be investigated, and the following detection analytic should surfacerelated activity.parent\_process \=\= keytool.exe\&\&process \=\= (cmd.exe \|\| powershell.exe)20 l Vulnerabilities2022 Threat Detection ReportT REN DAffiliatesThe threat landscape continued moving toward a software\-as\-a\-service 
(SaaS) economy, muddying the already murky waters of attribution.The term affiliate has been increasingly used to describe the cybercrimeecosystems evolution into a software\-as\-a\-service (SaaS) economy. Borrowedfrom the subscription\-based software specialization strategy, an affiliaterefers to the provider\-customer relationship of malicious services. In thecybercrime ecosystem, several SaaS variants have emerged, from phishing\-as\-a\-service (PhaaS) to access\-as\-a\-service to crypter\-as\-a\-service toransomware\-as\-a\-service (Raas). It has never been easier to find an adversaryfor hire.This service specialization across the phases of an intrusion has led to aproliferation of partnering, muddying the waters of what was once a relativelyconsistent collection of tactics across campaigns. As adversaries swapsubscribers and pass off payloads, identifying and anticipating the progressionof a compromise becomes more challenging. To meet this challenge, we need todistinguish the affiliate activity at each stage of the campaign.Tracking threats at Red CanaryTracking affiliates is tricky, and to help explain why we think its so important,we want to share some background on our threat tracking journey. At RedCanary, we primarily track threats by documenting their observable behaviorsin the form of tactics, techniques and procedures (TTP). When we first set outon this intelligence mission, we began by clustering the most prominent andprevalent threats within our data. We often focused on the primary payload asa means of referring to the threat within a detectionthink Qbot, TrickBot, orCobalt Strike. Often we would see one or more of these threats progressingto another threat, especially in the wild west of active incident responseengagements.Throughout 2021, we realized that referring toactivity as an Emotet phishingcampaign or a Qbot phishing campaign was confusing. The activity we observedbefore and after Emotet or Qbot sometimes varied, while other times, wenoticed the same patterns in how different malware families gained initialaccess. This realization helped us determine that patterns within filenames orinfrastructure indicated that these characteristics likely belonged to their owninitial access clustera delivery affiliaterather than a simple malware payloadas we had initially been referring to them. Understanding the relationshipsbetween these related threats enables us to better understand and respond tothe overall ecosystem of the threat landscape.21l Affiliates2022 Threat Detection ReportProminent affiliates in 2021The process of teasing out the distinguishing characteristics that allow us toseparate distinct clusters into more granular components is constantly evolving,as are the threats themselves. While weve been tracking some affiliates, such asTA551 (named by Proofpoint), for quite some time, others came into focus morerecently as our research progressed throughout the course of 2021\. Breakingdown intrusions into their component parts helps us better keep pace with thenature of the affiliate\-based economy adversaries operate in today.In 2021, we began identifying patterns in multiple phishing affiliates droppingvariants of the Bazar family of malware, also referred to as Baza. Derivedfrom the use of .bazar top\-level domains for C2 when it was first observed in thewild, this family has lent its name to multiple initial access vectors, campaigns,and components, including BazarLoader, BazarCall, and BazarISO. The multiplecomponents under the umbrella of the Bazar family highlight the importance ofdifferentiating the initial access from the payload. We have seen BazarBackdoordelivered by other prominent phishing affiliates, such as TA551, and haveeven seen behavior echoing some of the earliest campaigns that deliveredBazarBackdoor surface in the latter half of 2021, delivering a resurgent Emotetas its payload.Incorporating findings from other researchers helped us test hypothesesand add context to our understanding of several other affiliated threats. Theprominence of Qbot in our detections and as a ransomware precursor led usto further scrutinize the XLSX phishing lures that delivered it. As a result of thisresearch, we created a distinct profile for the TR delivery affiliate (which we alsoobserved delivering IcedID). Distinguishing these components would not havebeen possible without other researchers who shared their findings, such asBrad Duncan.Shifting away from phishing affiliates, we appreciated Morphisecs greatreporting on HCrypt and Snip3 in the first half of the year, the first time crypter\-as\-a\-service crossed our radar. This helped us better break down several otherclusters of activity to distinguish the hallmarks of the crypter from the initialphishing campaigns, such as Aggah, or the myriad RAT payloads HCrypt typicallydelivered.22l Affiliates2022 Threat Detection ReportT AK EA CTIO NAnalysts can better track affiliates by focusing on patterns in each phase ofan intrusion and comparing similarities and differences to help distinguishwhen activity has passed from one affiliate to the next. To do this, you can askquestions of the data and compare answers across distinct incidents where youobserved overlaps.Here are some example questions to consider:Does the email that delivered this payload belong to a phishing affiliate, or isthis entire campaign a cohesive cluster?What about the attachment or link within the emailis that a commoditymaldoc? Is it part of access broker infrastructure, or does it belong to theadversary operating the later\-stage payload?Is the download cradle and loader the beginning of the next\-stage payload,or the last vestige of the delivery affiliate before handing off execution to thedelivered payload?By honing in on the handoff between one affiliate and the next, you gain betterinsight into the potential pivot points in the progression of an incident, hopefullydetecting adversaries closer to the start of an intrusion. Distinguishing phishingaffiliates such as TA551 or TR from the IcedID or Qbot payloads they deliver not onlyhelps delineate the handoff between the affiliates, but allows you to dive deeperinto delivery patterns to identify differences when the deployed payload changes.Anticipating the next stage of a threats progression based on early observablesenables defenders and incident responders to implement mitigations before thatinitial access can progress to lateral movement, data exfiltration, or ransomware.23 l Affiliates2022 Threat Detection ReportT REN DCrypters\-as\-a\-serviceIn 2021, crypters like HCrypt and Snip3 joined the ranks of other
as\-a\-service threats.Throughout 2021, Red Canary observed operators using crypters HCrypt andSnip3 to deliver various remote access trojans (RAT). Like other as\-a\-servicethreats, the developers sell or lease these crypters to affiliates who use themto carry out campaigns, expanding the threat landscape and creating neweconomies of scale. The as\-a\-service ecosystem lowers the technical barrierto entry, allowing operators to purchase capabilities rather than develop them.HCryptHCrypt is a crypter designed to evade detection and facilitate the downloadof secondary payloads, often commodity RATs like ASyncRAT, Quasar RAT, andLimeRAT. Weve seen adversaries leveraging HCrypt to gain initial access viaphishing attachments, often relying on image files (IMG or ISO) containing ascript (VBS or JavaScript) that launches HCrypt. The malicious script downloadsan additional script hosted on various publicly accessible sites such as GitHuband Discord. Without intervention, this execution chain ultimately leads toa RAT infection.Snip3Like HCrypt, Snip3 is a crypter designed to evade detection and downloadadditional malware. Snip3 is often delivered via phishing emails that promptvictims to download a VBA file. To evade detection, Snip3 leverages obfuscatedPowerShell commands that contain the RemoteSigned flag. Weve observedthese PowerShell commands connecting to top4top\[.]io,a legitimate file\-sharingservice popular in Egypt, Algeria, and Yemen.Because these crypters are used by various adversaries delivering differentpayloads, it can be difficult to cluster seemingly disparate activity. However,as public reporting on Snip3 has discussed specific targeting of victims in theaviation sector, and we know of at least one set of operators that consistentlyrelies on phishing emails with lures related to travel or cargo, weve associatedactivity we saw in 2021 with a campaign Cisco calls Operation Layover. Weassess with high confidence that certain activity we observed in 2021 overlapswith this long\-running operation, also chronicled by researchers from Morphisecand Microsoft. While this campaign involved attempts to deliver ASyncRATor RevengeRAT to victims, similar intrusion chains deliver other publiclyavailable RATs.24l Crypters\-as\-a\-service2022 Threat Detection ReportT AK EA CTIO NAs HCrypt and Snip3 operate as\-a\-service, groups that purchase thesecapabilities may leverage them in different ways. The detection analytic belowrepresents one opportunity to detect both crypters, empowering defenders tointervene before adversaries deliver additional malware.Detection opportunities
WScript spawning Powershell using
Invoke\-ExpressionThis detection analytic will identify wscript.exe spawning PowerShell thatuses Invoke\-Expression or one of its aliases. HCrypt and Snip3 use PowerShellInvoke\-Expression cmdlets to execute downloaded PowerShell contentfilelessly, without the downloaded scripts touching disk.process \=\= powershell.exe\&\&parent\_process\=\= wscript.exe\&\&command\_line\_includes(iex \|\| invoke \|\| invoke\-expression)25 l Crypters\-as\-a\-service2022 Threat Detection ReportT REN DCommon web shellsIn 2021, adversaries exploited web applications with help from web shells 
such as China Chopper, Godzilla, and Behinder.Web shells seriously affected many environments in 2021 due in large part toMicrosoft Exchange and Zoho ManageEngine web server exploitation. Throughoutthe year, adversaries exploited ProxyShell, a Microsoft Exchange vulnerability, togain privileged access to email systems owned by thousands of organizations. Inthese cases, the adversaries left behind a China Chopper web shell, a small andextensible bit of code that runs arbitrary ASP.NET, PHP, JSP, and other languages.Some versions of China Chopper require authentication with a preset password,but many adversaries fail to implement this, meaning that multiple adversariescan use the same web shell in different campaigns at once.We also observed adversaries exploiting Oracle WebLogic servers to install theGodzilla web shell. Like China Chopper, Godzilla supports execution in ASP.NET,JSP, and PHP. Unlike China Chopper variants though, Godzilla web shells use acombination of simple password authentication with an additional encryption keyvalue to require adversaries to have two pieces of information to communicatewith the shell. The authentication ensures that only a single adversary can usethe web shell. This encryption also obfuscates network traffic and confoundsnetwork\-based analysis.Finally, we observed the Behinder web shell following adversaries exploiting aJava\-based web application made by Chinese cloud software company Yonyou.Behinder can load and execute compiled payloads in addition to standardcommands. As with Godzilla, Behinder supports encryption and goes the extramile by randomizing User\-Agent strings in network traffic to hinder network andlog analysis.Why web shells matterWeb shells are malicious scripts designed to maintain persistent access tocompromised web servers and facilitate remote code execution. Some are simple,allowing adversaries to issue a single command in a text box on a web page, whileothers include extensive capabilities where the adversarys imagination is thelimit. Web shells execute with the same user account privileges as the exploitedweb application. If the application runs as an administrator, sensitive databasesand systems may be accessible. Most web shells have simple or non\-existentauthentication mechanisms. Adversaries often leave web shells on public\-facingweb servers with no authentication mechanisms so they can return to the systems26l Common web shells2022 Threat Detection Reportlater. In some incidents, responders may find many web shells on a single server orevidence of multiple adversaries using an abandoned web shell. Web shells shouldbe removed as soon as possible to prevent further access.TAK EA CTIO NPatching should be the first step for remediating vulnerable web applications likeExchange, to prevent web shells from being dropped at all. Look for evidenceof an existing breach by following guidance from the application developers.For example, Microsoft recommends using the Microsoft Support EmergencyResponse Tool (MSERT) to scan the Exchange server for exploitation.If you cannot patch your web applications, consider creating IIS rewrite rules,disabling Unified Messaging services, and disabling multiple Internet InformationServices (IIS) application pools. These stopgap measures may affect the internaland external availability of your applications, depending on which products yourorganization uses. For more remediation advice, check out our blog MicrosoftExchange server exploitation: how to detect, mitigate, and stay calm.To detect web shells, start by examining file modifications and process executions.For Exchange servers, look for suspicious ASPX file modifications that may indicatean adversary wrote a web shell to disk. For other web applications like ASP.NET,PHP, and JSP applications, look for suspicious process behaviors. For example,you may be able to identify web shell activity by watching for web server workerprocesses spawning cmd.exe and PowerShell, certutil on Windows, or curl onLinux systems.Windows IIS Worker process spawning
certutil.exeThis detection analytic will identify unusual activity originating from w3wp.exeexecuting certutil to download files.parent \=\= w3wp.exe\&\&command\_line\_includes (certutil \&\& \-split)27l Common web shells2022 Threat Detection ReportLinux PHP or Java processes spawning wget
or curlThis detection analytic will identify unusual activity originating from Linux webservers executing wget orcurl to download files.parent\_process \=\= (php \|\| java)\&\&command\_line\_inlcudes (wget \|\| curl)28l Common web shells2022 Threat Detection ReportT REN DUser\-initiated initial accessWe observed an uptick in threats that occurred after users sought out content 
which, often unbeknownst to them, was malicious.In 2021, Red Canary observed adversaries use a range of initial access mechanismsto gain a foothold into victims environments. Much of the activity we saw wasconsistent with our expectations, with many detections resulting from maliciousemails, attempts to harvest victims credentials, and breaches by way of a trustedparty. Additional details on trends associated with these initial access vectorsand follow\-on activity such as webstall installation can be found throughout thereport.Understanding initial access can help defenders protect their environmentsearly on. Prioritizing detections related to initial access saves money, time andeffort; lessens pain points for users; and reduces impact to a business. From anintelligence perspective, understanding common patterns in initial access andfollow\-on activity helps build confidence in determining if relationships existbetween threats that co\-occur in an environment.Notably, over the past year, we observed a rise in what we refer to as user\-initiated activity: cases where victims downloaded a malicious executable afterengaging with content they purposefully sought out. This often occurs without thevictims knowledge, particularly in cases where adversaries poison search engineresults to direct victims to compromised websites.Though user\-initiated activity can be just as dangerous as adversary\-initiatedactivity, it can be more challenging to triage because it often involves unwantedsoftware or riskware, which many organizations deem lower\-risk. However, it iscritical to respond to this type of activity immediately, as follow\-on threats caninclude infostealers and ransomware.Top threats relying on user\-initiated activitySeveral of our top 10 threatsSocGholish, Yellow Cockatoo, and Gootkitrelyon variants of user\-initiated activity for initial access. Though not as pervasive,we also saw similar tradecraft with Rose Flamingo, an activity cluster involvedin intrusion chains where we later observed various payloads such as STOPransomware.Adversaries behind both Gootkit and Yellow Cockatoo abuse search engineoptimization (SEO) to display malicious content at the top of a victimssearch results. Because compromised websites are displayed prominently29l User\-initiated initial access2022 Threat Detection Reportand presented to the victim from a trusted search engine, victims are ofteneasily lured to these sites. They are then prompted to download maliciouscontent masquerading as legitimate content. For example, if a user searchedfor this is my query, the binary they downloaded would be named this\-is\-my\-query.exe. Because the file looks familiar, users are less likely toscrutinize it closely or look for red flags.Rose Flamingos initial access occurs via file\-sharing websites purporting toprovide free or cracked software.Similarly, SocGholish leverages drive\-by\-downloads masquerading assoftware updates.SocGholish itself is embedded in legitimate websitesthat have been compromised to prompt users about the need to downloadsupposed required updates.In each case, the tradecraft allows the operators to carry out seemingly targetedsocial engineering intrusions at scale.TAK EA CTIO NTo harden your intrusion surface against the search engine tradecraft commonlyused by Yellow Cockatoo and Gootkit, we recommend taking steps to preventaccess to malicious domains and other malicious content on the internet. Thiscould involve configuring your web proxy to block newly registered and low\-reputation domains (e.g tk, top, and gg) and blocking ads.To mitigate risks associated with the fake browser updates related to SocGholishand the malicious JavaScript files used by Gootkit, we recommend preventingautomatic execution of JavaScript files. You can do this by changing the default fileassociations for .js and .jse files.We also recommend periodically refreshing security training to remind employeesof the risks associated with web browsing, as this is discussed less frequently.30 l User\-initiated initial access2022 Threat Detection ReportT REN DMalicious macOS installersMalicious installers led to rotten Apples and adware, as macOS systems 
continued to be targeted in 2021\.Weve come a long way from hearing cries of Macs dont get viruses and in2021, the information security community saw more and more malware targetingmacOS systems. In contrast to Windows systems, we observe far fewer maliciousdocuments or email attachments on macOS systems. Instead, the majority ofmalware we observe on macOS stems from malicious installers that trick victimsinto thinking theyre downloading legitimate content. This approach is particularlyinsidious, as victims on macOS systems usually possess administrative privileges.Shlayer, Bundlore, and Silver Sparrow followed this malicious installer trend.Also, four of the eight macOS malware threats Objective\-See covered in theirreview of 2021 relied on malicious installers for deployment.Most macOS threats we observe are malicious adware. Malicious adware is anunwanted program designed to show advertisements on a victims screen, oftenwithin a web browser. A good example of the potential impact of malicious adwarecomes from the activity cluster Red Canary tracks as Silver Toucan. This clusterdiscloses its own terms of service that victim hosts may use for proxy activities.Malicious macOS adware often includes tools such as MITMProxy for ad injection,which raises the privacy concern of web traffic inspection on affected hosts.TAK EA CTIO NUpdating the operating system andapplying antimalware controls arethe best defenses against malicioussoftware on macOS. Patching tothe latest version possible ensuresthat malware exploits are less likelyto succeed. Malware authors stillcirculate versions of installers thatexploit patched vulnerabilities,knowing that not everyone can patchtheir macOS system. Antimalwarecontrols help mitigate this threat.Where possible, obtain softwaredirectly from trusted sources thatsign the installers and seeknotarization from Apple. Malicioussoftware has been mistakenlynotarized in the past, but each casehas been rapidly found and remedied.Figure 1: Malicious adware lureThreats like Shlayer pose as fake Flash Player downloads to look legitimate.31l Malicious macOS installers2022 Threat Detection ReportT REN DRemote monitoring and 
management abuseAdversaries continue to use and abuse legitimate remote monitoring and 
management (RMM) software to move data and control infected hosts.Adversaries regularly abuse remote monitoring and management (RMM) toolsbecause theyre widely used for legitimate reasons and seem benign. Alongwith the ability to blend in while moving laterally, these tools offer adversariesa reliable way to communicate with and pass information in and out of infectedhosts.In 2021 we identified an uptick of ransomware operators abusing RMM toremotely control victim machines and deploy additional malicious payloads.RMM has typically been used by help desk technicians to resolve issues on clientcomputers. These software suites allow users to remotely control hosts, providingadversaries with a user\-friendly graphical interface, secure network connectionsvia cloud hosted infrastructure, and host persistence. This makes it a challenge fordefenders to catch the early stages of intrusions. It became increasingly clear to usthroughout the year that being able to initially detect abnormal installation andexecution of these tools can help thwart ransomware or slow further deploymentof malicious payloads.Not all ransomware operators or affiliates use these tools as part of their intrusionchain, meaning other security controls are still important to cover other accesspaths. Community reporting has identified ransomware groups like REvil, Conti,Avos Locker, and Blackheart using software suites such as ScreenConnect, Atera,and Anydesk to gain persistent footholds to hosts after compromising them. Inmany instances, this led to the deployment of ransomware. Identifying rogueinstances of these management tools is a great starting point to help understandand defend your endpoints.TAK EA CTIO NWe see the use of RMM tools as a wayfor adversaries to blend into the vastswath of endpoint telemetry thatdefenders rely on heavily for findingand eradicating evil. We all need totake a different approach when itcomes to detecting this behavior.Rather than solely focusing onblocking known malware samples orwriting detection logic surroundingbuilt\-in operating system tool abuse(e.g living off\-the\-land binaries),keep legitimate third\-party softwareinventory in mind as well.Enterprises purchase and usehundreds, if not thousands, ofsoftware suites, but accounting forwhats legitimate in your organizationis important. Were not suggestingthe near impossible, which is to keeptabs on all abnormal behavior of yournumerous applications, but merelysuggesting to stay up to date on thepermissibility of their presence.Correlating with the legendaryPyramid of Pain, malicious use ofRMM tools finds itself near the top ofthe pyramid, under Known Toolsand TTPs. Gathering laundry lists oflegitimate software and comparingthem against process executionlogs will prove valuable for yourdefensive posture. SANS has a greatwhite paper on how defenders canuse open source utilities to collectthis information remotely from theirmanaged devices. Weve also coveredthis topic more in\-depth with multipledetection opportunities in ourMisbehaving RATs blog post.32l Remote monitoring and management abuse2022 Threat Detection ReportT REN DLinux coinminersCoinminers continued to dominate the Linux threat landscape in 2021\.While coinminers affect all operating systems, they made up the majority of thethreats we saw on Linux environments in 2021, just as weve seen in years prior. AsLog4j vulnerabilities consumed the information security news cycle in December2021, researchers reported adversaries exploiting Log4j to deliver XMRig payloadsand other coinminers. Being able to detect and respond to common threats likecoinminers will help any blue team detect a wide range of activityeven when itemanates from unknown exploits.Many of our Linux coinminer detections began with a Secure Shell (SSH) daemonor a web server process. While we often did not know the exact method of initialaccess, the intrusion chains we observed suggested that many of them beganwith weak user authentication or exploitation of web applications. After gaininginitial access, adversaries usually leveraged system utilities such as curl or wgetto download additional utilities like shell scripts and coinmining binaries fromexternal sources.The shell scripts we identified performed various actions, including hostreconnaissance, inhibition of competing miners, defense evasion, and persistence.Two common persistence methods weve observed with miner threats like Kinsingand TeamTNT are adding SSH keys to a users authorized\_keys file and creatingscheduled tasks via the crontab command, two relatively easy techniques. Asingle shell command can be added to a script and establish hooks without mucheffort on the part of the adversary.The coinmining binaries that we observed most commonly were XMRigpayloads, which were often delivered by adversaries who targeted unpatchedendpoints. We observed threats such as Outlaw authenticating via SSH toendpoints, presumably as a result of brute\-force attempts, followed by executingshell scripts that initiated XMRig payloads named kswapd0\. We also saw z0minerexploiting vulnerabilities in Confluence to deploy XMRig payloads by executingvarious shell scripts. Finally, Bird Miner tried to execute XMRig payloads on macOS hosts by usingQemu to emulate a Linux environment. No matter how elaborate their initialaccess techniques, the commonality between these threats is XMRig payloads.Due to its popularity, XMRig artifacts provide excellent opportunities fordetection, including several discussed below.33l Linux coinminers2022 Threat Detection ReportT AK EA CTIO NCompromises involving coinmining have been surprisingly consistent over the lastfew years, and many of the detection opportunities we have shared previouslyare still relevant. Focusing on post\-exploitation activity should help, regardlessof whether the initial access method is a weak SSH password, outdated webapplication, or exploitation of a vulnerability like Log4Shell.The best defense against many of the coinminer compromises we observed ispatch management. Many of the coinminers we saw exploited flaws in outdatedapplications like JBoss and WebLogic, so keeping systems updated will deteradversaries who are simply scanning for applications with known vulnerabilities.Strong authentication policies, such as multi\-factor authentication (MFA) or lockingauthentication to just SSH keys, should mitigate techniques like SSH brute forcing.Here are some additional detection analytics to help identify potential Linuxcoinminer activity.Bashauthorized\_keys filemodificationThis detection analytic will identify instances of Bash processes making filemodifications to a users authorized\_keys file. Kinsing coinmining malware isone Linux threat that uses this technique for persistence.process \=\= bash\&\&filemod\_filepath \=\= .sshauthorized\_keys\*Note: There are many shells on Linux endpoints, and this analytic will likely needto be modified to specify the shells that are used within your Linux environment.34l Linux coinminers2022 Threat Detection ReportPkill with xmr in command lineThis detection analytic will identify processes named pkill that have command\-line options containing the string xmr, which may be observedprior to new XMRig processes executing on infected endpoints.process \=\= pkill\&\&command\_line \=\= xmrRenamed coinminersThis detection analytic will identify processes that have command\-lineoptions specific to XMRig and similar miners. While command\-line argumentscan be brittle, this is a great way to catch lazy adversaries who do little tohide their activities.command\_line\_includes (stratum \|\| coin \|\| donate\-level \|\|cryptonight \|\| moneropool)\|\|command\_line\_includes \[at least 2 of the following] (cpu\-priority \|\|max\-cpu\-storage \|\| algo \|\| url)Process connecting to known mining poolsThis detection analytic will identify non\-web browser processes that initiatenetwork connections to known mining pools.process !\= (chrome \|\| firefox \|\| msedge \|\| iexplore \|\| safari)\&\&network \_connection\_includes \=\= (supportxmr \|\| xmrpool \|\| xmr \|\|nanopool \|\| monero)\*Note: This is a non\-exhaustive list of pools and web browsers, which you canadd to with additional research. Additionally, this analytic will likely need tobe tuned to your specific environment, depending on your use of browsers andbusiness purposes.35l Linux coinminers2022 Threat Detection ReportT REN DAbusing remote procedure 
callsIntrusions leveraging remote procedure calls (RPC) made waves in 2021, 
particularly PetitPotam and PrintNightmare.Remote procedure calls (RPC) facilitate local and remote communicationbetween client and server programs. Many Windows services leverage RPCs forcommunication, and many RPCs expose functions to end users. Depending onprivilege levels and the security checks that are (or are not) performed whenthese functions are implemented, adversaries can abuse RPCs to perform manymalicious actions.We covered RPC abuse in depth on the Red Canary blog last year, but twomethods of RPC abuse stood out in 2021: PetitPotam and PrintNightmare. Bothemerged over the summer, and adversaries quickly adapted them from theoreticalproofs of concept for privilege escalation into real\-world intrusions. Both werereportedly leveraged in ransomware campaigns, underscoring the urgency behindthese threats. Weve done extensive testing to replicate these techniques andvalidate detective and preventive controls for them. What follows is a summary ofthese compromises and what you can do to defend your organization.PetitPotamFirst published as a proof\-of\-concept intrusion by researcher Gilles Lionel in July2021, PetitPotam allows an adversary to hijack server authentication sessions andgain access to highly sensitive systems like Active Directory Certificate Services(AD CS). Microsoft published a security bulletin (CVE\-2021\-36942\) in Augustthat raised the barrier of entry for PetitPotam, requiring that adversaries firstauthenticate themselves with legitimate credentials to conduct the intrusion.PetitPotam enables an adversary to force authentication of a machine byperforming an NTLM relay\-like intrusion against the Encrypting File SystemRemote Protocol (EFSRPC), which manages data encrypted by the EncryptingFile System (EFS) on remote servers. PetitPotam was particularly troublingbecause the EFSRPC exposed functionality through a DLL (efslsaext.dll)that enabled unauthenticated communication through the LSASS pipe viathe EfsRpcOpenFileRaw method. Depending on the patch status, either anunauthenticated or an authenticated adversary can call the EfsRpcOpenFileRaw36l Abusing remote procedure calls2022 Threat Detection Reportmethod, intercept the authentication response (NTLM relay) between the clientand a server, and use that to authenticate to another workstation. If they target adomain controller, an adversary could potentially compromise the entire domainby relaying that authentication to an AD CS server. James Forshaws detailedarticle from August is a great place to learn more.TAK EA CTIO NSecurity teams seeking to observe and detect PetitPotam intrusions have multipleoptions. Well describe relevant telemetry that can be gathered from EDR tools andnative operating system logs.Start by monitoring the Window Security Event 4624 log for anonymous andother suspicious logins. Many EDR products collect named pipe data, so you canalso monitor for lsarpc or efsrpc named pipe connections to domain controllers.This will show when an unauthenticated user is trying to communicate with thedomain controller over those transport protocols.Microsoft has published extensive mitigation guidance describing manycontrols that administrators can implement to prevent NTLM intrusions ingeneralsome of them more than a decade oldand many of these protectionsapply to PetitPotam. If its feasible in your environment, the following can help tomitigate PetitPotam intrusions:Update domain controllers and workstations to patch machinesagainst CVE\-2021\-36942\.Disable or set EFS Service startup type to disabled if service is not
being used.Enable SMB signing to prevent relay intrusions.Apply an RPC filter to only allow authenticated connection to the EFS serviceover Kerberos.PrintNightmareIn July 2021, researchers Zhiniang Peng and Xuefeng Li disclosed a Windowsvulnerability called PrintNightmare (CVE 2021\-34527\) that enabled adversariesto perform remote code execution and privilege escalation in two different ways.The objective of each is to connect to a remote host without authentication andcause it to load a malicious DLL. One method abuses the driver installation feature37l Abusing remote procedure calls2022 Threat Detection Reportof the Print System Remote Protocol (MS\-RPRN) protocol, while the other abusesa similar driver installation feature of a different protocol, the Print SystemAsynchronous Remote Protocol (MS\-PAR) protocol. In both cases, an inboundconnection is accepted by the print spooler service (running as SYSTEM), whichallows the creation of a separate process also running as SYSTEM. Once anadversary gains SYSTEM level privileges, they effectively have full control overthat host.TAK EA CTIO NThe following data sources, largely available via commercial EDR tools, can helpyou identify PrintNightmare\-related behavior:Monitor files for thethe creation of suspicious DLLs in the following file path:C:WindowsSystem32spooldrivers(x64W32X86\)dllMonitor module loads to identify when DLLs (especially unsigned ones) areloaded from the following file path: C:WindowsSystem32spooldrivers(x64W32X86\)dllMonitor suspicious registry modifications that involve DLLs getting addedto the following: HKLMSystemCurrentControlSetControlPrintEnvironmentsWindows x64DriversVersiondll (for x64 systems) orHKLMSYSTEMCurrentControlSetControlPrintEnvironmentsWindowsNT x86dll (for x86 systems)Monitor processes spawning from spoolsv.exe.It is unusual for spoolsv.exeto spawn child processes under legitimate conditions.In addition to the above detection opportunities, implement the following controls:Update servers and workstations to newest Microsoft releases to patch CVE2021\-34527 and other vulnerabilities. 
Turn off the spooler service if it is not being used legitimately.Disable Point and Print in the registry: reg add HKEY\_LOCAL\_MACHINESoftwarePoliciesMicrosoftWindows NTPrintersPointAndPrint vRestricted t REG\_DWORD d 0 f38l Abusing remote procedure calls2022 Threat Detection ReportT REN DDefense validation and 
testingConfirmed testing comprised almost one quarter of our detections in 2021, 
with many coming from open source tools.We see a lot of testing. In fact, 23\.4 percent of all the confirmed threats wedetected in 2021 were confirmed by customers to be testing. Were all for testing(as you can hopefully tell by our work with Atomic Red Team), and we wanted toshare what weve observed about testing when compared to proper villains.We also have some suggestions for how to make testing more effective.In aggregate, confirmed testing behaviors we observed in 2021 differedsignificantly when compared to non\-testing behaviors. When comparing thetop 10 detection analytics that appeared in detections marked by customersas testing to those that fired in detections not marked as testing, only threeanalytics overlapped. Here are some patterns we observed in testingdetections during 2021\.Common testing toolsUnsurprisingly, a large volume of the testing detections we observed were fromcommon breach and intrusion simulation tools and open source testing tools.For example, a detection analytic on CrackMapExec execution from cmd.exeappeared in our top testing techniques, but not in our non\-testing detections.CrackMapExec is a post\-exploitation tool to audit and assess security in ActiveDirectory environments, so it is a natural choice for testing. This suggests thatCrackMapExec is more widely used by testers than non\-testers.Throughout 2021, we also frequently observed Mimikatz, BloodHound,Impacket, Cobalt Strike, and Metasploit in testingso much so that testingdetections involving these tools helped all of them make it into our top 10threats this year. We consider all of these tools to be dual\-usethey are usedby both adversaries and legitimate users. These dual\-use tools present a challengebecause it can be difficult to determine if their use is malicious or benign withoutadditional context and understanding of what is normal in an environment. Werecommend all organizations have a clear understanding of authorized use ofthese tools in their environments and treat unconfirmed testing as maliciousactivity until proven otherwise.39l Defense validation and testing2022 Threat Detection ReportCredential theft methodsWe frequently observe credential theft during testing, which is a positive becauseadversaries frequently do this as well. However, weve noticed that testers oftenfocus narrowly on two approaches for credential dumping. One analytic thatfires frequently in testing detections identifies cross\-process injection or accessactivity from rundll32\.exe to lsass.exe. Another analytic identifies instances ofrundll32\.exe dumping process memory using MiniDump, a built\-in code library.Part of the reason we observe these behaviors so frequently is because they areintegrated into multiple automated breach and intrusion simulation tools, makingit more likely for this behavior to occur at scale.Noisy discovery commandsAnother pattern in our testing detections is quick execution of a series of discoverycommands such as ipconfig, whoami, and others. This is in opposition to whatwe see from many adversaries, who often perform fewer discovery commands ina more targeted way. For example, one of the top analytics we used for detectingtesting was for enumeration of Windows Domain Administrator accounts withcommands like net domain admins. While non\-testers use this command as well,we found that testers use it more frequently.TAK EA CTIO NBased on our findings, we encourage organizations to be thoughtful about theirtesting goals. One approach is to test atomic behaviors without considering thesurrounding behavior. This can be helpful to determine if you have the ability topotentially detect that behavior. However, consider also adopting a goal to test afull intrusion chain. This may look different than testing for atomic behaviorsforexample, instead of executing 20 discovery commands in quick sequence, youcould execute one or two discovery commands followed by other activity, thenreturn to additional discovery commands.One approach that can help ensure youre testing based on real\-world threats thatmatter is to enhance testing with threat intelligence. Adversary emulation, in whichtesters use threat intelligence to try to carefully mimic threats of concern as closelyas possible, is a widespread methodology that can provide significant value andhelp organizations improve testing. MITREs adversary emulation plans providea helpful starting point.We also recommend changing up your toolset. Automated red teaming and testingtools are powerful, but they are often easier for defenders to detect. To ensure yourorganization has robust detection capabilities for a range of behaviors, considerdifferent ways you could test the same techniques. For example, instead of justusing Mimikatz for credential dumping, try using Gsecdump, NPPSpy, or other testsfrom Atomic Red Team.40l Defense validation and testing412022 Threat Detection ReportTop threatsThe following chart illustrates the specific threats Red Canary detected most 
frequently across our customer environments in 2021\. We ranked these threats 
by the percentage of customer organizations affected to prevent a single, major 
malware outbreak from skewing the metrics.As discussed in our Methodology section, we chose to define threats broadly 
as malware, tools, threat groups, or activity clusters. Eight of our top 10 threats 
are malware families or tools, while one (TA551\) is a threat group named by 
another team (Proofpoint) and another an activity cluster created by Red 
Canary (Yellow Cockatoo). This is expected because distinct malware families 
and tools are often more straightforward to identify, while associating activity 
to threat groups or activity clusters requires longer\-term analysis that may 
extend beyond the year.This was our second year tracking top threats. When compared to the top 
threats in 2020, the overall percentage of customers affected by each threat was 
down. For example, in 2020, 15\.5 percent of customers were affected by TA551, 
compared to 10\.2 percent of customers in 2021\. While its unclear whether this is 
anything more than a natural ebb and flow of activity, we suspect one factor is 
the overall increase in detection volume we observed in 2021\.How to use our analysisThese are the most prevalent threats occurring in our customer environments, 
so we can assume they are prevalent elsewhere. We include advice for 
responding to each threat and offer detection opportunities so you can better 
defend your organization. Some defenders may be able to take our detection 
guidance and apply it directly, while others may not. Regardless, defenders 
without a detection engineering function can still make use of the actionable 
analysis of each threat written by our Intelligence team experts.42l Threats2022 Threat Detection ReportTop threats10\.2% of customers affectedTA55150%8\.8%7\.9%6\.8%5\.9%5\.5%5\.0%3\.9%3\.8%3\.8%MimikatzCobalt StrikeQbotImpacketSocGholishYellow CockatooMetasploit FrameworkGootkitBloodhound1234567899Note: We analyzed each of the top 10 threats in last years Threat Detection report. 
However, since there is significant overlap between the top threats for 2021 and 
2022, we opted only to analyze new entrants to the top 10 or reanalyze existing top 
10 threats that have changed significantly.43l Threats\#3OVERALL RANK7\.9%CUSTOMERS AFFECTED2022 Threat Detection ReportT O PT E NT HRE ATH IGHLIGHT SCobalt StrikeCobalt Strike continues to be a favorite C2 tool among adversaries, as many 
rely on its functionality to maintain a foothold into victim organizations.AnalysisCobalt Strike has never been more popular, as adversaries are increasinglyadopting it as their favorite C2 tool. Adversariesransomware operators inparticularrely substantially on Cobalt Strikes core functionalities as they seekto deepen their foothold in their victims environments.Its speed, flexibility,and advanced features are likely contributing factors as to why ransomwareattacks have been ticking upward in recent years. Some of the most notoriousransomware operators including groups like Conti, Ryuk, and REvilSodinokibiare known to rely heavily on Cobalt Strike in their attacks.The security community is embracing the fact that whatever functional label youplace on Cobalt Strike, its here to stay, its implicated in all variety of intrusions,and its our duty to defend against it. Luckily for defenders, over the course ofthis past year the security community has produced a plethora of great technicalanalysis and detection opportunities around preventing and investigatingCobalt Strike. Some of the more common detection strategies documented inpublic reporting include:command\-line monitoringpublic network infrastructure scanningin\-memory scanningdynamicstatic binary analysisabnormal process lineagenetwork traffic monitoringbaselining the prevalence of reconnaissance commandsKeep in mind that although many of these methods of detection can be easilybypassed with changes to the Cobalt Strike configurations, we highly suggestusing them as a stopgap until your teams develop more advanced methods.The security community has shared invaluable public resources on analyzingand detecting Cobalt Strike. Our detection opportunities from last yearsThreat Detection Report remain effective. For defenders getting started withunderstanding how the tool works and operates, we highly recommend reading44l Cobalt Strike2022 Threat Detection Reporteach of the following resources because they all have unique takeaways andcover a majority of the most effective detection techniques:https:www.mandiant.comresourcesdefining\-cobalt\-strike\-componentshttps:blog.talosintelligence.com202009coverage\-strikes\-back\-cobalt\-strike\-paper.htmlhttps:thedfirreport.com20210829cobalt\-strike\-a\-defenders\-guidehttps:thedfirreport.com20220124cobalt\-strike\-a\-defenders\-guide\-part\-2https:go.recordedfuture.comhubfsreportsmtp\-2021\-0914\.pdfDetection opportunities
Cobalt Strike beacon implantThis detection analytic identifies an adversary using a Cobalt Strike beaconimplant to pivot and issue commands over SMB through the use of configurablenamed pipes. Cobalt Strike beacons have configurable options to allow SMBcommunication over named pipes, utilizing a host of default names commonlyused by adversaries. Analysis should focus on any file modifications to asuspicious named pipe within this process.file\_modifications\_include (pipemsagent\_ \|\| pipeinterprocess\_ \|\|pipelsarpc\_ \|\| pipesamr\_ \|\| pipenetlogon\_ \|\| pipewkssvc\_ \|\|pipesrvsvc\_ \|\| pipemojo\_ \|\| pipepostex \|\| pipestatus\_ \|\| pipemsse\-) Rundll32\.exeto spawn SQL Server Client 
Configuration UtilityThis analytic identifies instances ofrundll32\.exespawning the SQL ServerClient Configuration Utility (cliconfg.exe ). We often see this pattern of processexecution when Cobalt Strike leverages DLL Search Order Hijacking as a methodof UAC bypass.parent\_process \=\=rundll32\.exe\&\&process \=\=cliconfg.exe45 l Cobalt Strike2022 Threat Detection ReportCommand\-line patterns for Cobalt Strike 
beacons via GetSystemThis analytic identifies commonly observed command\-line patterns whenCobalt Strike beacons escalate privileges via the GetSystem feature.Adversaries use GetSystem to impersonate a token for the SYSTEM account.This level of access allows an adversary to perform privileged actions beyondthat of an administrator.process \=\=cmd\&\&command\_line\_includes ((?i)echos\+\[0\-9a\-f]{11}s\+\>;?s\+.pipe\[0\-9a\-f]{6}.match)\*Note: The above regular expression will match on the following example what ofusing GetSystem may look like via a Cobalt Strike beacon:C:Windowssystem32cmd.exe c echo 92d8cc45954 \>; .pipe446b3c46 l Cobalt Strike\#5OVERALL RANK5\.8%CUSTOMERS AFFECTED2022 Threat Detection ReportT O PT E NT HRE ATH IGHLIGHT SImpacketThough Impacket is used legitimately for testing, it is often abused by 
ransomware operators and other adversaries, thanks in large part to
its versatility.AnalysisAt its core, Impacket is a collection of Python libraries that plug intoapplications like vulnerability scanners, allowing them to work with Windowsnetwork protocols. These Python classes are used in multiple tools, includingpost\-exploitation and vulnerability\-scanning products, to facilitate commandexecution over Server Message Block (SMB) and Windows ManagementInstrumentation (WMI). Oftentimes the popular Python scriptssmbexec ,wmiexec , ordcomexecare used directly without referring to Impacket, asthey are versatile and easily implemented code samples. This is the first yearthat Impacket made it into our top 10 threat rankings, which we attribute toincreased use by adversaries and testers alike.Impacket is an interesting tool as we consider it dual\-useits leveraged byboth adversaries and legitimate users. Its often used behind the scenes byadministration and vulnerability\-scanning applications, including Linux toolsthat manage or scan Windows environments. While Impacket is fairly easy todetect, it can be challenging to determine if it is malicious or benign withoutadditional context and understanding of what is normal in an environment.While threats such as FIN8 malware BADHATCH and multiple ransomwareoperators have used Impacket, approximately one third of the Impacketdetections we saw in 2021 were from confirmed testing. We recommend allorganizations have a clear understanding of authorized use of Impacket in theirenvironments, and consider any activity outside of that to be malicious untilproven otherwise.Throughout 2021, operators of Conti, SunCrypt, Yanluowang, Cring, andVice Society ransomware all used Impacket at some point during intrusions.Impacket acted as a sort of swiss army knife during intrusions, allowingadversaries to:retrieve credentials usingsecretsdump.pyfunctionality (SunCrypt)issue commands on remote systems during lateral movement (SunCrypt)deliver a ransomware binary usingsmbexec.py(Cring and Vice Society)47 l Impacket2022 Threat Detection ReportResponding to ImpacketResponse actions may vary depending on the Impacket script component theadversary is leveraging. If you detect a malicious instance of Impacket, seriouslyconsider isolating the endpoint because theres likely an active adversary inyour environment.Once the endpoint is isolated, evaluate if the adversary loaded other tools, ifthey were able to move laterally from the device, and if they stole credentials.If the adversary moved laterally, isolate any devices they may have accessed. Ifthere is evidence of credential theft, reset passwords for the impacted accounts.Please note that if the adversary leveraged Kerberos, passwords will need adouble reset over the course of 10 hours (based on the default 10\-hour ticketTime to Live setting) to reset and invalidate existing tickets.Following the initial response steps above, stop any active processesassociated with Impacket, remove any malicious files written to disk, andremove any changes to the device made by the adversary. Reimaging impacteddevices is not out of the question, since an adversary may have installed othertools or established persistence.Detection opportunities
WMIexecexecutionThis detection analytic uses a regular expression to identify commands from theImpacketwmiexecscript, which allows a semi\-interactive shell used via WMI.This analytic shows output being redirected to the localhostADMIN$share. Theregular expression identifies an output file named as a Unix timestamp (similarto 1642629756\.323274\) generated through the script.parent\_process \=\=wmiprvse.exe\&\&process \=\=cmd.exe\&\&command\_line\_includes ((?i)cmd.exe Q c 127\.0\.0\.1ADMIN$\[0\-9]{1,10}.\[0\-9]{1,10} 2\>\&1\))SMBexecexecutionThis detection analytic uses a regular expression to identify commands from the48 l Impacket2022 Threat Detection ReportImpacketsmbexecscript, which allows a semi\-interactive shell used throughSMB. The regular expression identifies the name of a file share used to storeoutput from the commands for interaction.parent\_process \=\=services.exe\&\&process \=\=cmd.exe\&\&command\_line\_includes((?i)cmd.exe Q c echo cd ^\>127\.0\.0\.1\[a\-zA\-Z]{1,}$output 2^\>^\&1 \> \& )49 l Impacket2022 Threat Detection ReportT O PT E NT HRE ATH IGHLIGHT SSocGholishSocGholish leverages drive\-by\-downloads masquerading as software 
updates to trick visitors of compromised websites into executing malware.AnalysisSocGholish is an initial access threat that leverages drive\-by\-downloadsmasquerading as software updates. Active since at least April 2018, SocGholishhas been linked to the suspected Russian cybercrime group Evil Corp (alsoknown as Indrik Spider). Red Canary encountered SocGholish in a wide varietyof industry verticals in 2021\. These drive\-by\-downloads placed SocGholishinside the top five most prevalent threats we track. This ranking was fueledby an increasing number of detections as the year went on, culminating inSocGholish peaking as the most prevalent threat we encountered in December.Red Canary customers affected by 
SocGholish in 2021\#5OVERALL RANK5\.5%CUSTOMERS AFFECTED50 l SocGholish2022 Threat Detection ReportA SocGholish drive\-by\-download occurs when an unsuspecting user visitsa compromised website and downloads a malicious ZIP file. In one incidentdescribed by Expel earlier this year, adversaries compromised an organizationssite that was running a vulnerable version of WordPress. Employee endpointswere then infected with drive\-by\-downloads of SocGholish directly fromthe companys own website. SocGholish relies on social engineering to gainexecution, tricking unsuspecting users into running a malicious JavaScriptpayload stored within a downloaded ZIP file. These files typically masqueradeas browser updates, though other lures include Adobe Flash or MicrosoftTeams. Once executed, the JavaScript payload connects back to SocGholishinfrastructure, where it shares details about the infected host and can retrieveadditional malware.In 2021, Red Canary observed NetSupport RAT and BLISTER malware deliveredby SocGholish. In the past, we have seen SocGholish deploy a Cobalt Strikepayload that led to WastedLocker ransomware. The connection betweenSocGholish and BLISTER is notable, as this malware loader was only identifiedby Elastic in late December 2021\. Following BLISTER deployment in anenvironment initially compromised with SocGholish, we detected severalpost\-exploitation reconnaissance behaviors on the affected endpoint.The majority of SocGholish infections weve detected did not result in a second\-stage payload, sometimes due to existing mitigations or rapid response toisolate the host. In most cases, we observed reconnaissance activity that onlyidentified the infected endpoint and user. In some cases, Active Directory anddomain enumeration followed user discovery. Both of these can be a precursorto lateral movement, however, the hosts were isolated before any lateralmovement activity could begin. Much of the reconnaissance conducted by themalicious JavaScript file happens in memory, with data being exfiltrated directlyvia POST commands to the C2 domain. One good source of insight into thisbehavior comes from collecting script load content, if such telemetry is availablefrom your endpoint detection and response (EDR) sensor. Collecting this dataprovides key insight into the specific commands executed and data exfiltrated.Detection opportunities
JavaScript executing from a ZIP file and making 
external network connectionsExecuting script contents from within a ZIP file is unusual, especially when thatscript is making external network connections. This detection analytic regularlyidentifies the initial execution and network connections from a SocGholishJavaScript payload extracted from a ZIP file.51 l SocGholish2022 Threat Detection Reportprocess \=\=wscript.exe\&\&command\_line\_includes ( .zip\&\&.js )\&\&has\_external\_netconnScript files conducting reconnaissance with 
whoamiand writing the output to a fileSocGholish employs several scripted reconnaissance commands. While much ofthis activity occurs in memory, one that stands out is the execution of whoamiwith the output redirected to a local temp file with the naming conventionrad\<5\-hex\-chars\>.tmp.parent\_process \=\=wscript.exe\&\&process \=\=cmd.exe\&\&command\_line\_includes(whoamiall\>\> )Enumerating domain trusts activity
withnltest.exeLeft unchecked, SocGholish may lead to domain discovery. This type of behavioris often a precursor to ransomware activity, and should be quickly quelled toprevent further progression of the threat.process \=\=nltest.exe\&\&command\_line\_includes(domain\_trusts \|\| all\_trusts)52 l SocGholish\#7OVERALL RANK4\.9%CUSTOMERS AFFECTED2022 Threat Detection ReportT O PT E NT HRE ATH IGHLIGHT SYellow CockatooYellow Cockatoo is an activity cluster involving a remote access trojan (RAT) 
that filelessly delivers various other malware modules.AnalysisAs Yellow Cockatoo uses effective search engine poisoning tactics, can stealthilypersist in a compromised environment, and appears to affect a wide array oforganizations across various sectors and geographies, we werent surprisedto see it crack our top 10 threats in 2021\. In September the volume of YellowCockatoo detections increased substantially (relative to earlier in the year). Thismay have been the result of a new installation mechanism, chronicled in detailby researchers from Morphisec (they call this threat Jupyter).While much of the public reporting, notably a robust profile published byMorphisec, covers an infostealer component of Yellow Cockatoo, we oftenobserve behaviors that occur earlier in the Yellow Cockatoo kill chains. Thistypically includes installation mechanisms, which deliver code that runspersistently. This code later downloads and executes additional modules thatare never written to disk. In many of the instances of Yellow Cockatoo activitywe observed, the payloads were a minimal version of the original componentsdocumented by Morphisec, with the infostealer functionality delegated toadditional modules.Yellow Cockatoo tradecraft is wide\-ranging, and there are several variations onits attack chain. Over time, the most significant detection opportunities stemfrom the behaviors we observe consistently. These include but are not limited tothe tradecraft outlined below.Initial access: Search engine redirects enable Yellow Cockatoo operators to 
perform seemingly targeted social engineering attacks at scale. Initial accessby Yellow Cockatoo often occurs via a search engine redirect that directs auser from a legitimate search engine to a site that downloads a malicious filebearing the victims search query as its name (for example: this\-is\-my\-search\-query.msi or this\-is\-my\-search\-query.exe). Because potential victims aredirected to a site based on a search they initiated, they may be more inclinedto engage with its content. Though many adversaries craft tailored attacks andleverage familiar themes, Yellow Cockatoo is unique in its ability to dynamicallycustomize its attacks based on victims real\-time searches.53 l Yellow Cockatoo2022 Threat Detection ReportExecution: Following installation, the EXE or MSI file spawns a command line 
and creates a similarly named TMP file that launches PowerShell. All of this isprecursor activity that leads to the execution of a malicious dynamic link library(DLL). This is a remote access trojan (RAT) implemented as a .NET assemblydesigned to be reflectively loaded into PowerShell.Defense evasion: Since Yellow Cockatoos follow\-on activity occurs in
memory, it poses a unique challenge to defenders. Yellow Cockatoo uses XORand Base64 encoding to ensure its files are obfuscated and do not exist incleartext on disk. Cleartext is only present in memory and only exists after it isinvoked by its loader. Accordingly, static detection rules for files on disk maymiss malware components.To harden your attack surface against the search engine redirects commonlyused by Yellow Cockatoo, we recommend taking steps to prevent access tomalicious domains and other malicious content on the internet. This couldinvolve configuring your web proxy to block newly registered and low\-reputation domains (e.gtk, top, and gg) and block advertisements.Detection opportunities
PowerShell writing startup shortcutsWe frequently observe adversaries using PowerShell to write malicious LNK filesinto the startup directory to establish persistence. Accordingly, this detectionopportunity is likely to identify persistence mechanisms in multiple threats. Inthe context of Yellow Cockatoo, this persistence mechanism eventually launchesthe command\-line script that leads to the installation of a malicious DLL:process \=\=powershell.exe\&\&command\_line\_includes (appdata )\&\&filemod\_path\_includes (start menuprogramsstartup)\&\&filemod\_extension \=\=.Ink\*Note: You can test the efficacy of this detection opportunity by running this AtomicRed Team test in PowerShell with elevated privileges.54 l Yellow Cockatoo2022 Threat Detection ReportPowerShell utilizing System.Reflection.
Assembly to load a DLLThis detection analytic identifies PowerShell using System.Reflection.Assembly. to load a DLL. However, this analytic may generate false positives inyour environment and likely requires tuning.process \=\=powershell.exe\&\&command\_line\_includes (reflection.assembly )\&\&command\_line\_regex\_encoded \=\= (?i)::(?load)?(?:\|file)(55 l Yellow Cockatoo\#9OVERALL RANK3\.8%CUSTOMERS AFFECTED2022 Threat Detection ReportT O PT E NT HRE ATH IGHLIGHT SGootkitGootkit is a banking trojan that can deliver additional payloads, siphon data 
from victims, and stealthily persist in a compromised environment.AnalysisA malware threat with a JavaScript loader component, Gootkit has been activelyobserved in the wild for more than a decade. Over the past several years, it hasevolved into a multi\-stage tool used to facilitate a range of hands\-on\-keyboardactivity in multi\-pronged attacks, wherein more than one objective is likelyaccomplished. Gootkit was originally delivered via spam email campaigns andolder exploit kits, but over time its initial access has shifted to SEO poisoningtactics. Specifically, operators alter search engine results to direct victimsto legitimate but compromised websites hosting Gootkit. Upon visitinga compromised website, victims are prompted to download a ZIP archivecontaining a malicious JavaScript file, which if executed can allow an adversaryto remotely access a victims system. While some researchers track the deliverymechanism as Gootloader and the trojan activity as Gootkit, Red Canarytracks both components as Gootkit. Our classification may shift as we gatheradditional information.Follow\-on activity varies. In 2021, Red Canary saw operators use Gootkitto deliver Cobalt Strike. Though we didnt observe any ransomware in thatintrusion, the intrusion chain mirrored public reporting of compromiseswhere victims networks were ultimately encrypted with Sodinokibi (REvil)ransomware. Based on public research and follow\-on activity observed incustomer environments last year, its likely that Gootkit operators facilitateransomware\-as\-a\-service (RaaS) activity in some cases, either deploying otherpayloads directly or selling access to environments with Gootkit infections. Wehave also observed Gootkit dropping the Osiris banking trojan.While weve observed Gootkit detections in customer environments acrossmultiple sectors, almost without exception, infections occurred after victimsvisited compromised websites purporting to host content related to legal orfinancial agreements. Victims were likely directed to these sites after initiatingqueries in common search engines with keywords such as agreement,contract, and the names of various financial institutions. Given the volumeof Gootkit detections and the range of victims, this threat is likely moreopportunistic than targeted to a specific industry or organization. Accordingly,Gootkit remains a threat to all organizations.56 l Gootkit2022 Threat Detection ReportOne hypothesis as to why we observe Gootkit so frequently is that it isdownloaded from sites victims navigated to based on search results theyinitiated themselves, as we further discuss in the user\-initiated initialaccess section.Detection opportunities
Windows Scripting Host executing
JavaScript filesThis detection analytic will identify unusual activity originating fromwscript.exeexecuting JavaScript filesfrom the%APPDATA%directory. This appliesto GootKit because the initial loader for the threat is implemented in JavaScriptthat gets executed viawscript.exewhen the victim double\-clicks on thedownloaded loader.process \=\=wscript.exe\&\&file\_path\_includes (%APPDATA% )PowerShell using a shortened
EncodedCommandflagThis detection analytic will identify use of the shortenedEncodedCommandflag in PowerShell, a tacticoften used by Gootkit operators and others toobfuscate malicious code on an endpoint. Like all detection analytics, this maygenerate some false positives in your environment that require tuning. Thisapplies to GootKit at multiple stages after the loader, when this threat usesPowerShell to deobfuscate and execute downloaded payloads.process \=\=powershell.exe\&\&command\_line\_includes \=\= \[any variation of the\-encodedcommandswitch]Note: the encoded command switch has many variations, including\-encodedcommand e enc , and many other variations57 l Gootkit\#9OVERALL RANK3\.8%CUSTOMERS AFFECTED2022 Threat Detection ReportT O PT E NT HRE ATH IGHLIGHT SBloodHoundBloodHound is an open source tool that provides visibility into Active 
Directory environments. It is a common precursor to follow\-on activity, 
whether thats further testing or ransomware.AnalysisBloodHound is an open source tool that can be used to identify attack pathsand relationships in an Active Directory (AD) environment. Like Impacket, this isthe first year BloodHound made it into our top 10 threat rankings, thanks to bothtesting activity and adversary use. It is popular among adversaries and testersbecause having information about an AD environment can enable further lateralmovement throughout a network. BloodHound has multiple components,including SharpHound, which is a data collector for BloodHound written inC Throughout 2021, SharpHound was one of the most common BloodHoundcomponents we observed.Multiple adversaries used BloodHound during 2021, including FIN12 andoperators of Yanluowang ransomware. We also observed BloodHound beingused by operators in conjunction with Cobalt Strike only 75 minutes after auser first opened a malicious XLS phishing lure that initiated a SquirrelWafflemalware payload.Because adversaries often leverage BloodHound early in their intrusion,defenders should be prepared with robust detection and a quick response tostop the malware in its tracks. BloodHounds role as a dual\-use tool can make itparticularly challenging to determine if its presence is authorized or malicious,meaning that a solid understanding of its allowed use in an environment iscritical to respond appropriately.Identifying SharpHound components gathering data can be challenging. Togather AD data, SharpHound connects to multiple hosts over ports 137 and 445,along with multiple named pipe connections. As your environment scales larger,the noise from SharpHound will scale accordingly. For most organizations,SharpHound activity will likely appear to be SMB scanning activity untilinvestigated further.58 l BloodHound2022 Threat Detection ReportDetection opportunities
High\-volume port 445 connectionsThis detection opportunity identifies a single process exceeding a set thresholdfor a normal volume of network connections to port 445\. We did not specify logicfor this detection analytic, since the normal number of connections will differin each environment. While it takes some tuning, this analytic helps detect notonly BloodHound, but also various types of post\-exploitation SMB scanning andlateral movement.Common BloodHound command\-line optionsThis detection analytic identifies processes that contain common commandlines consistent with the execution of BloodHound. While this is a simpleanalytic, weve found it to be effective in identifying BloodHound. Its a goodsupplement to the port 445 analytic, which can require more tuning.command\_line\_includes (\-collectionMethod \|\| invoke\-bloodhound \|\| get\-bloodHounddata)59l BloodHound\#29OVERALL RANK1\.1%CUSTOMERS AFFECTED2022 Threat Detection ReportT HRE AT :NE WA CTIVIT YC LUSTE RRose FlamingoRose Flamingo relies on search engine optimization (SEO) poisoning to trick 
victims into infecting themselves.AnalysisRose Flamingo is an activity cluster named by Red Canary that focuses onopportunistic, financially motivated malware as an initial access broker. RoseFlamingo targets victims who are looking to download licensed softwarewithout having to pay for it. Payloads related to Rose Flamingo typically arriveas archive files that are distributed via phony file\-sharing websites purporting toprovide users with free cracked software packages. To lure potential victims,the adversaries behind Rose Flamingo use search engine optimization (SEO)poisoning to elevate a malicious sites search ranking.Rose Flamingo victims will typically download a ZIP archive file containing twofiles at a minimum. Archives related to Rose Flamingo may contain words likefree ,key ,download ,license ,latest ,ISO , andcrack . While these archivesusually appear as ZIP files, they infrequently appear as other compressedarchive formats as well. The files in a typical Rose Flamingo archive are apassword text file and one password\-protected archive. Some iterationsof these password files contain the password and some classic ASCII art,as shown below, though the purpose behind the art is unknown. This type ofdelivery method conceals the malicious payloads that are contained within thepassword\-protected archive from any prying security softwareFigure 2: The contents of a password text file associated with Rose Flamingo60l Rose Flamingo2022 Threat Detection ReportWhile we created the Rose Flamingo naming convention to help us trackactivity we consider to be related, theres a growing body of external researchdocumenting components that partially overlap with what we define as RoseFlamingo. Much of this emerging research dropped in 2021, and its worthreviewing for anyone who is interested in learning more about related activity:In January 2021, CSIS Security Group released research referencinginfrastructure and payloads that overlap with Rose Flamingo.In March 2021, Fortinet detailed a threat called Netbounce, which uses asimilar file\-naming convention and has some overlapping infrastructure.Just about a week later in March 2021, Proofpoint published research abouta threat they call CopperStealer (Mingloa), describing infrastructure andpayload\-naming conventions that are very similar to Rose Flamingos.In June 2021, an Ahnlab report described a threat called Cryptbot,detailing files used for delivery that appear to overlap with Rose Flamingosfile\-naming conventions.In late July 2021, BitDefender joined the party, helping corroborate many ofour own observations with their MosaicLoader whitepaper, a great reportthat touches on much of the initial loader activity weve observed in RoseFlamingo\-related incidents.Last but not least, in September 2021, SophosLabs released research thatfocuses on a content delivery network that has many infrastructure andpayload overlaps with our analysis.Because none of us have perfect visibility, we appreciate that other teams sharetheir perspective and how they track these threats.As seen in our Intelligence Insights rankings from month to month, RoseFlamingo made our top 10 list for the first time in July 2021, climbing toeighth place for most prevalent threats that month. It also made our top 10in September and October 2021\. Red Canary has observed Rose Flamingodelivering various stealers such as Cryptbot, RedLine, and Raccoon, in additionto more concerning payloads such as STOP ransomware. We will continuebirdwatching as we look for new opportunities to observe and take actionwhen threats like Rose Flamingo find a new place to roost.61l Rose Flamingo2022 Threat Detection ReportDetection opportunities
Archive containing ZIP and TXT files
containingpasswordThis detection analytic will identify processes making file modifications forZIP archive files and TXT files with the stringpasswordin them, which wecommonly observe in Rose Flamingo activity. The password files may containdifferent naming variations, such asp@sswordorpassw0rd . Detecting TXTfiles with these strings may generate fewer false positives. If you have troublegetting this detection opportunity to work, you may find further successfocusing on application processes that are responsible for handling archives inyour organization, such as 7zip.filemod\_includes (zip )\&\&filemod\_includes (password\&\&txt )Potential Rose Flamingo loaderThis detection analytic will identify unusual processes that containnaming schemas that have been observed in use by loaders related toRose Flamingo archives.process\_name\_includes (main\-\|\|installer\-v\|\|main\_setup\_x86x64\|\|x86\_x64\_setup\|\|setup\_x84\_x64 )Potential Rose Flamingo loaderThis detection analytic will identify files and file paths that contain stringscommonly observed in archives delivered by Rose Flamingo.filepath\_includes (\-free\|\|\-crack\|\|\-download\|\|\-key\|\|\-license\|\|\-iso\|\|\-Install )\|\|filename\_includes (\-free\|\|\-crack\|\|\-download\|\|\-key\|\|\-license\|\|\-iso\|\|\-Install )\&\&filename\_includes (zip\|\|7z\|\|rar )62l Rose Flamingo2022 Threat Detection ReportT HRE AT :NE WA CTIVIT YC LUSTE RSilver SparrowSilver Sparrow is a macOS activity cluster with fully functional distribution 
methods and infrastructure but no final payload.In February 2021, Red Canary discovered an activity cluster we named SilverSparrow when we identified a strain of macOS malware using aLaunchAgentto establish persistence. Distributed via downloads from AWS S3 buckets,malware dropped by Silver Sparrow relies on installation through macOS PKGfiles. We analyzed two versions of Silver Sparrow malware: The first versioncontained a Mach\-O binary compiled for Intel x86\_64 architecture only, andthe second version included a Mach\-O binary compiled for Intel x86\_64 and M1ARM64 architectures. The downloader was novel because of the way it usedJavaScript for execution and the appearance of a related binary compiledfor Apples new M1 ARM64 architecture. During installation, the malwareexecuted JavaScript commands to orchestrate the creation of files and scriptsfor persistent execution. These files attempted to download a future payloaddetermined by a file from an additional S3 bucket retrieved every hour.Since we observed multiple files and components on victim machines, wedecided to cluster all the suspicious artifacts under the Silver Sparrow activitycluster, including an unusualinsufile that seems to instruct the malware toremove itself from an endpoint.Thanks to our friends at MalwareBytes, we determined that the Silver Sparrowactivity cluster affected tens of thousands of macOS endpoints across 164countries as of February 2021, including high volumes of detection in theUnited States, the United Kingdom, Canada, France, and Germany. Although wenever observed Silver Sparrow delivering additional malicious payloads, it wasoperationally mature and affected many thousands of machines worldwide.Overall, Silver Sparrow is interesting and unique because:At the time of analysis, its malware was compatible with M1 ARM64 andIntel chipsets. Researchers have uncovered very few threats for the M1ARM64 architecture because the architecture is young.Its installer packages leverage the macOS Installer JavaScript API toexecute suspicious commands. This is the first malware weve seen do this.Its infrastructure was hosted on AWS S3, making it hard to blockoutright. The decision to use AWS infrastructure suggests an operationallymature adversary.63l Silver Sparrow2022 Threat Detection ReportDetection opportunities
PlistBuddyutility manipulatingLaunchAgentThePlistBuddycommand is a built\-in tool in macOS that allows administratorsto manipulate property list, or plist, files used to configure various parts of themacOS operating system. Silver Sparrow used the command to manipulateLaunchAgentplists and allow persistence.PlistBuddywith the commandline includingRunAtLoadindicates an adversary is specifically manipulating aLaunchAgentor LaunchDaemon s capability to execute code at boot.TAK EA CTIO NWe included some detectionopportunities to help identifySilver Sparrow activity. Also, seethe macOS trends page for defensestrategies to protect yourself frommacOS threats.process\=\=PlistBuddy\&\&command\_line\_includes (RunAtLoad )Sqlite3 loading the Quarantine fileThe Quarantine feature of macOS prevents certain file types from easilyexecuting after being downloaded from the internet. The system keeps a recordof all downloaded files in a SQLITE database at \~LibraryPreferencescom.apple.LaunchServices.QuarantineEventsV Silver Sparrow malware and othermacOS threats commonly query this record using thesqlite3command todetermine where they were downloaded from to report back to the adversaryfor metrics (i.e whether or not the deployment path was successful).process\_name \=\= (sqlite3 )\&\&command\_line\_includes (LSQuarantineURLString )64 l Silver Sparrow\#16OVERALL RANK1\.7%CUSTOMERS AFFECTED2022 Threat Detection ReportR ELEVAN TT HRE AT SO F2 0 2 1BazarThe Bazar family of malware continued to be active in 2021, spurring 
ransomware infections.The Bazar malware family was quite active in 2021, spreading via multipledelivery affiliates, including TA551 and BazaCall. There are many namesfor Bazar (sometimes referred to as Baza) floating around that refer tovarious parts of the intrusion chain. Bazar is relevant because of its role asa malware precursor, and many 2021 intrusions starting with Bazar led toransomware like Ryuk and Conti. The Bazar malware family encompasses aloader, BazarLoader, and backdoor, BazarBackdoor. These components havebeen delivered via multiple delivery affiliates. As we discuss in the Affiliatessection of this report, differentiating initial delivery affiliates from loaders andpayloads will help you understand each phase of the threat and how to betterprotect your organization.One affiliate weve been tracking for a while, TA551, began delivering Bazarduring 2021\. While TA551 relied on email attachments to deliver Bazar, anotheraffiliate behind a 2021 phishing campaign known as BazaCall opted to trickusers into calling a phone number sent in an email. After a victim calledthe number, an adversary provided step\-by\-step instructions that led todownloading Bazar malware. (Check out Brad Duncans video for an exampleof how this intrusion plays out.) Once BazaLoader was installed, BazaCall led toCobalt Strike and eventually, ransomware.Detection opportunities
Microsoft Certificate Services using 
certutil.exeto initiate downloadThis detection analytic looks for instances of the Microsoft CertificateUtility (certutil.exe ) initiating a download, a technique used to downloadBazar payloads.process \=\=certutil.exe\&\&command\_line\_includes (urlcache )65l Bazar2022 Threat Detection ReportR ELEVAN TT HRE AT SO F2 0 2 1Latent threatsThreats come and go, but somelike USB stowaways and network 
wormslike to stick around.Latent threats demonstrate that most adversaries do not need to be advancedor sophisticated to execute code or persist in an organization. They can simplysettle to be an adequate persistent threat, using techniques and artifactsthat virtually anyone can find. This section outlines opportunities to detect andrespond to tried\-and\-true threats like USB stowaways and network worms.USB stowawaysIn this section we characterize USB stowaways as threats that leverage USBthumb drives to find their victims.Floxif (ranked \#75 in 2021\)Floxif, short for FloodFix, is a type of file\-infecting malware that researchershave observed spreading to some of the farthest reaches of organizationsnetworks since 2012\. In the detections that weve observed, Floxif mostcommonly arrived on endpoints via USB thumb drive. Floxif self\-replicates byidentifying processes running in memory that are eligible for infection andreplaces them with new, Floxif\-compromised binaries. Many variants of Floxifmalware rely on writing the accompanying DLLsymsrv.dllto a unique location,so detecting this threat can be done with relatively high confidenceFloxif DLL file modificationThis detection analytic identifies file modifications that are consistent withFloxif malware execution.file\_modification\_includes (Common files System symsrv.dll )66l Latent threats2022 Threat Detection ReportGamarue (ranked \#12 in 2021\)Gamarue is a malware family that was first observed by researchers in 2011and rendered inactive after a joint takedown operation in 2017\.While manyvariants of Gamarue exist, the variant we observed most frequently in 2021was an Autorun worm that spread primarily via infected USB drives. This isno different from what we saw in 2020, and we expect to continue seeing it foras long as users keep deploying infected USB drives to ferry files from oneendpoint to another.Explorer launching Rundll32 without any DLL in 
the command lineprocess \=\=rundll2\.exe\&\&parent\_process \=\=explorer.exe\&\&command\_line\_does\_not\_include (.dll )Conficker (ranked \#28 in 2021\)Bridging the gap between USB worms and network worms, Conficker is a wormthat feverishly spread across the internet in late 2008, leveraging the NetBIOSvulnerability MS08\-067\. As more sophisticated variants were developed, USBAutorun worming functionality was soon baked into Conficker as well, helpingto further spread this worm via sneakernet. Fourteen years later, Red Canarystill detects artifacts related to Conficker, most of which are leftover persistencemechanisms from incomplete remediation. While antivirus products may bedoing most of the heavy lifting in terms of remediating active instances ofConficker, those errant scheduled tasks may still be out there trying to launchConficker DLLs of bygone days.Rundll32 executing with command lines 
consistent with ConfickerThis detection analytic will identify unusual activity originating fromtherundll32\.exeprocess. Werfault typically spawns with command\-lineparameters when a process crashes, providing the program with input to createan error report. If you are having trouble getting this detection opportunity towork in your environment, you may find additional success by focusing only on67l Latent threats2022 Threat Detection Reportprocesses wheretaskeng.exeorsvchost.exeare the parents of Rundll32\.process \_name \=\=rundll32\.exe\&\&command\_line \=\=rundll32\.exe\[a\-z]{5,8}.\[a\-z]{1,3},\[a\-z]{5,8}Network wormsIn this section we characterize network worms as threats that exploitvulnerabilities in software to infect and establish control over an endpoint.Following initial access, adversaries leverage the infected endpoints networkconnections to identify additional assets to infect and repeat the cycle.WannaCry ransomware (ranked \#31
in 2021\)WannaCry, often shortened to WCry, is a ransomware variant that spreads asan SMB worm leveraging the ETERNALBLUE vulnerability, MS17\-010\. WannaCrywas first observed in May 2017, indiscriminately spreading across manyorganizations. Early variations of WannaCry had code built in to discontinueransomware operations, but later versions of did not include this functionality.Half a decade later, some might laugh that were including WannaCry in a reportreleased now, and we must admit that seeing WannaCry so high in our rankingswas a bit of a shock for us too, but here we are. Simply put, theres a reasonwhy the vulnerability WannaCry targets, MS17\-010, is known as ETERNALBLUE.Just like MS08\-067 is to Conficker, MS17\-010 is so reliable that we are likely tocontinue seeing WannaCry for quite some time. If you are concerned that yourendpoints might be afflicted by WannaCry, Microsoft provides guidance on howto identify endpoints that may be susceptible to SMBv1 exploitation, as well asmitigation techniques that are still applicable today.Process names that are consistent with
WannaCry binariesThis detection analytic will identify processes that are executing with processnames that are consistently observed in use by WannaCry binaries.process\_name \=\=mssecsvc.exe\|\|process\_name \=\=tasksche.exe68 l Latent threats2022 Threat Detection ReportLSASS spawning processesThis detection analytic will identify instances of the Local Security AuthoritySubsystem Service (lsass.exe ) spawning processes that are not typicallyobserved being launched bylsass.exe . LSASS is an injection target forWannaCry, as detailed by Microsoft.parent\_process \=\=lsass.exe\&\&process\_name !\=werfault.exe\|\|lsass.exeWannaMine cryptominer (ranked \#57
in 2021\)WannaMine, a portmanteau of WannaCry and Mine, is a malware family thatfocuses on deploying coinmining payloads. The Wanna part of the name ofthis threat comes from the use of the same ETERNALBLUE vulnerability thatWannaCry leveraged. While WannaMine may be old news to some, Red Canaryobserved new infections throughout the course of 2021\. Theres a reason whyvendors are still producing articles providing guidance around WannaMinecleanup and remediation.PowerShell executing with NoProfile and 
NonInteractive CLI parametersThis detection analytic identifies instances ofpowershell.exeexecuting withthe strings\-nopand\-noniin the command line, which are shortenings forthe PowerShell parametersNoProfileandNonInteractive . These command\-line parameters are rarely observed together legitimately, making for anotheranalytic that can be used to identify a multitude of threats, notjust WannaMine.process \=\=powershell.exe\&\&command\_line\_includes ( \-nop\&\&\-noni )69 l Latent threatsT AK EA CTIO NEven if youre not seeing themin headlines, it is important toevaluate threats that have beenknown to be problems in the past.If your least favorite adversary hasgone dormant, theres a chancethat they may come back usingmany of the same TTPs. Make sureyour endpoints are up to date withthe latest patches, and if you findyourself to be afflicted by the manythreats that we have outlined todaythat abuse Autorun functionality,you may want to consider disablingAutorun across the organization.2022 Threat Detection ReportHonorable mentionZloader is neither a USB stowaway nor a network worm, and though it nevercauses enough of a stir to breach our top rankings, it still deserves an honorablemention as a latent threat. The adversaries behind Zloader typically deviseinnovative ways to reach their victims before making the news with their nextcampaign, yet even with the latest passing headline, they often still rely on lessnovel TTPs that can give their presence away.Zloader (ranked \#53 in 2021\)Zloader is a banking trojan that has targeted victims through a variety ofavenues since 2016\. Though its TTPs have changed over the years, the drivingforce behind Zloader continues to appear to be financial motivation. In mid2020, Zloaders operators began delving into delivering ransomware alongsidetheir more typical banking trojan payloads, elevating our concern whenever wedetect a threat that is consistent with Zloader activity. Zloader makes this listbecause it is another threat that you may not hear much from for a few monthsbut is always likely to creep its way back.PowerShell modifying Windows
Defender exclusionsThis detection analytic identifies instances of PowerShell issuing commandsto modify Windows Defender exclusion policies. This activity is consistentwith ZLoader activity that occurs prior to the execution of follow\-on payloads.Additional threats, such as Purple Fox, leverage this TTP as well.process \=\=powershell.exe\&\&command\_line\_includes (Add\-MpPreference\|\|Set\-MpPreference )\&\&command\_line\_includes (ExclusionExtension\|\|ExclusionPath\|\|ExclusionProcess )70 l Latent threats712022 Threat Detection ReportTop techniquesThe purpose of this section is to help you detect malicious activity in its
early stages so you dont have to deal with the consequences of a serious 
security incident.The following chart represents the most prevalent MITRE ATT\&CK
techniques observed in confirmed threats across the Red Canary customerbase in 2021\. To briefly summarize whats explained in detail in theMethodology section, we have a library of roughly 3,000 detection analytics 
that we use to surface potentially malicious and suspicious activity across our 
customers environments. These are mapped to corresponding MITRE ATT\&CK 
techniques whenever possible, allowing us to associate the behaviors that 
comprise a confirmed threat detection with the industry standard for classifying
adversary activity.72l Techniques2022 Threat Detection ReportT O PT ECHNIQUE SNAMETEC H NIQUERA NK 
(SU B\-TECH NI QUE RA NK )% OF CUSTO ME RS 
A FFECTEDT1059:Command and Scripting Inter prete rT1059\.001: PowerShellT1059\.003: Windows Command ShellT1218:Signed Binar y Proxy ExecutionT 1 21 8 .0 1 1: Rundll 321(1\)(2\)2(3\)T1047: Wind ows Management Instru mentat io n3T1003:Credent ial DumpingT1003\.001: LSASS Memo r yT1105:Ingress Tool TransferT1055:Process InjectionT1053:Scheduled Ta skJobT 1053\. 005:Sche dule d Ta skT1027:Obfuscated Files or Inform ationT1036:Masqueradin gT 1036\. 003:RenameSystem Ut il it iesT 1036\. 005:MatchLegi ti mate N a meo rLocationT1574:HijackExecution FlowT 1574\. 001:DLL S ea rchOrde rHij a cki n g4(6\)567(4\)89(7\)(11\)10(5\)53\. 4%(35\.0%)(28\.1%)34\. 8%(23\.3%)15\. 4%18\. 3%(13\.3%)20\. 4%21\. 7%14\. 7%(12\.2%)19\. 4%22\. 1%(15\.6%)(7\.9%)8\. 4%(7\.8%)\*Note: We chose not to include analysis for each technique in the PDF supplement to the report,but, as always, theyre available in full on the Threat Detection Report website.73l Techniques2022 Threat Detection ReportWhats included in this section?Weve written extensive analysis of 12 ATT\&CK techniques and sub\-techniques.Each technique\-specific section includes:a brief analysis of how and why adversaries leverage a given techniquedescriptions of data sources that offer visibility into the technique (e.gcommand monitoring, process monitoring, etc.)guidance on the tooling or logs that will enable you to collect those datasources (e.g EDR, Sysmon, AMSI, Windows Events. etc.)specific examples of how you can use that telemetry to detect adversariesabusing the techniqueindividual tests for emulating how adversaries abuse the technique tovalidate that you can observe or detect itThe bottom lineExamined holistically, the list of prevalent techniques showcased in this reportsuggests that if you can detect threats relatively early in the intrusion lifecycle,youre much less likely to face the consequences of a significant cyber attack.This principle has saved many of our customers from immeasurable grief overthe years.To that point, we mostly detect adversaries as theyre setting the stage for later,more impactful actions. We catch them attempting to abuse native operatingsystem utilities to execute code or bring in custom tooling. We catch themelevating their privilege levels to get deeper access to compromised systems.We catch them establishing persistence so they can maintain their presence. Wecatch them manipulating our customers defensive controls to evade preventionor detection. These are necessary means to an endwhether the goal is toconduct espionage, a ransomware attack, or something else altogether. Whenwe disrupt these means, we prevent their ends.This is precisely why exfiltration and impact techniques (e.g ransomware) dontrank highly on our list. The following heatmap shows the distribution of the 20most prevalent techniques across the ATT\&CK matrix.74l Techniques2022 Threat Detection ReportFigure 3: MITRE ATT\&CK Navigator layer showing the 20 most prevalent ATT\&CK techniques detected by Red CanaryThis isnt to suggest that we never encounter ransomware. In fact, we routinelyencounter ransomware threats through short\-term engagements with ourmany incident response partners. However, we monitor far more customersfull time than we do via IR engagements, and therefore, these ransomwareincidents represent only a small fraction of our overall detection volume.75l Techniques2022 Threat Detection ReportInterestingly, if we create a heatmap like the one above where we only includedetections from our incident response work, we see a slightly differentarrangement of techniques that does include impact tacticsas well as moredefense evasion, more lateral movement, and less execution. This makes sensebecause in incident response engagements we are entering environmentswhere a lot of the preliminary activitythe stuff we generally catch early for ourfull\-time customershas already occurred. In other words, were already at theimpactful part of the incident.Figure 4: MITRE ATT\&CK Navigator layer showing the 20 most prevalent ATT\&CK techniques detected by Red Canary
during incident response engagements76l Techniques2022 Threat Detection ReportHow to use our analysisIf your organization is able to follow the visibility, collection, anddetection guidance in this report, you can effectively improve your defense\-in\-depth against the adversary actions that often lead to a serious incident.Of course, this is easier said than done. There are countless prerequisitesto operationalizing this report, ranging from configuration challenges todeveloping plumbing that allows you to move telemetry from its source to itsdestinationwhether thats a SIEM or some other aggregation point.However, this analysis is still useful for practitioners or leaders who arentimmediately ready to operationalize it. For leaders, the most prevalenttechniques can help you identify gaps as you develop a road map for improvingcoverage. You can assess your existing sources of collection against the oneslisted in this report to inform your investments in new tools and personnel.As a practitioner, youll gain a better understanding of common adversaryactions and whats likely to occur if an adversary gains access to yourenvironment. Youll learn what malicious looks like in the form of telemetry andthe many places you can look to find that telemetry. Youll gain familiarity withthe principles of detection engineering by studying our detection opportunities.At a bare minimum, you and your team will be armed with hyper\-relevant andeasy\-to\-use Atomic Red Team tests that you can leverage to ensure that yourexisting security tooling does what you think its supposed to do.Whats missing and why?Red Canary is actively adopting new data sources that reach beyond theendpoint to enhance our detection, investigation, and incident handlingcapabilities, and youll see evidence of this throughout the techniquessectionparticularly in the visibility, collection, and detection subsections.Even so, the majority of our detection analytics are based on endpointtelemetry and the majority of the endpoints we monitor are client workstations.This reality shapes our perspective and the contents of this report.Given our vantage point and the defense\-in\-depth our detection analytics offer,we tend to detect the adversary behaviors that happen just after initial access.As a result, execution, privilege escalation, persistence, and defense evasiontechniques are probably over\-emphasized in our report. On the other hand, oneof the most prevalent forms of initial accessemail\-based phishingis under\-represented. Under no circumstance should anyone interpret these findings tosuggest that phishing protection is unimportant. To the contrary, phishing isamong the most prevalent ways that adversaries initially access our customersenvironments, and the data in this report does reflect a great number of77l Techniques2022 Threat Detection Reportemail\-borne threats. However, Red Canary doesnt have as much early\-stagevisibility into phishing as we do into other techniques, which is precisely whythis report works best as a complement to other reports from vendors withdifferent vantage pointslike those who make firewalls or email\-monitoringproducts.Further, discovery techniques are also underrepresented in this report. This isbecause discovery techniques can be incredibly noisy, generating prohibitivelyhigh volumes of false positives for our detection engineers. Beyond that,discovery\-related alerts arent always actionable since, for example, you cantreally prevent someone from scanning a public\-facing resource. This isnt tosay we dont inform our customers of discovery activity. We absolutely do, butits typically done manually by our detection engineers as theyre analyzingpotentially malicious events. Since our ATT\&CK mapping happens at thedetection\-analytic level, prior to human analysis, the discovery activity isntincluded in this report.One final note: we overwhelmingly monitor Windows endpoints, and thereforeweve included only limited information about macOS and Linux techniquesin this section. To be very clear, we have robust detection coverage for macOSand Linux threats, but this report reflects the reality that Windows continues todominate the enterprise marketplace.Learn more about our top techniques78 l Techniques2022 Threat Detection ReportConclusionThank you for devoting your time to absorbing this report; we appreciate your dedication toprotecting your organization. We understand there are lots of reports floating around theinformation security community, and we take pride in our work to muffle the noise, optinginstead for curated and actionable content. We hope the information encompassed in thisreport offers insights into howto improve your security posture and what you can do if youencounter any of the most prevalent threats, trends, and techniques. We will continue toupdate the Red Canary blog with relevant resources related to the Threat Detection Reportand many other valuable resources you can use to take action.If you have any questions or concerns, or just want to chat, please feel free to reach out to usat info@redcanary.com.ContributorsThank you to all our contributors who helped make this report possible.Jimmy AstleKelsey BudnickSusannah ClarkAaron DiderBrian DonohueJeff FellingThomas GardnerMatt GraeberDominic HeidtDave HullChristina JohnsJonny JohnsonMilan KlusacekTony LambertAdam MaschinchiKeith McCammonPaul MichaudKatie NickelsLauren PodberJustin SchoenfeldAnna SeitzHarrison Van RiperPhillip WellsErin York79l Conclusion80